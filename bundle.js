/*! For license information please see bundle.js.LICENSE.txt */
(()=>{"use strict";var t={917:(t,e,s)=>{s.d(e,{jt:()=>n,pf:()=>a,Ms:()=>o,fw:()=>c});var i=s(925),r=s(485);function n(t,e,s,i,r){if(i<=s)return()=>e;const n=t.map(((t,s)=>r().init(t,e[s])));return t=>n.map((e=>e.progress((t-s)/(i-s))))}function a(t,e,s,r,a,o,l){let h=n(t,e,0,r,a),c=i.Z.now(),d=t.slice(),u=null,g=()=>{null!==u&&(i.Z.clear(u),u=null,l&&l(d))},p=()=>{let t=Math.min(i.Z.now()-c,r);d=h(t),o&&o(d),t==r&&g()};return u=i.Z.periodic(p,s),p(),Object.assign((()=>d),{cancel:g})}class o{static ease=()=>()=>new h;static linear=(t=0)=>()=>new l(t);static byName(t){switch(t){case"ease":return o.ease();case"linear":return o.linear(0);default:throw new Error("Unknown timing function: "+t)}}from;to;init(t,e){return this.from=t,this.to=e,this.doInit(),this}}class l extends o{shift;t1s;t2s;step;constructor(t){super(),this.shift=t}doInit(){this.t1s=0,this.t2s=1,this.shift<0&&(this.t1s=0+1*-this.shift),this.shift>0&&(this.t2s=0+1*(1-this.shift)),this.step=(this.to-this.from)/(this.t2s-this.t1s)}progress(t){return t<=this.t1s?this.from:t>=this.t2s?this.to:this.from+this.step*(t-this.t1s)}}class h extends o{doInit(){}progress(t){return this.from+Math.sin(Math.PI/2*t)*(this.to-this.from)}}class c{v1;v2;progressMs;intervalMs;timingFunctionName;timePassed;timePassedSinceLastFrame;static __type="Animation";animation;_onAnimationProgress=()=>{};constructor(t,e,s,i,r,a=0,l=0){this.v1=t,this.v2=e,this.progressMs=s,this.intervalMs=i,this.timingFunctionName=r,this.timePassed=a,this.timePassedSinceLastFrame=l,this.animation=n(t,e,a,i,o.byName(this.timingFunctionName))}progress(t){return this.timePassed+=t,this.timePassed>=this.intervalMs?(this._onAnimationProgress(this.animation(this.intervalMs)),!1):(this.timePassedSinceLastFrame+=t,this.timePassedSinceLastFrame>=this.progressMs&&this._onAnimationProgress(this.animation(this.timePassed)),!0)}set onAnimationProgress(t){this._onAnimationProgress=t}__serialize(){return{v1:this.v1,v2:this.v2,progressMs:this.progressMs,intervalMs:this.intervalMs,timingFunctionName:this.timingFunctionName,timePassed:this.timePassed,timePassedSinceLastFrame:this.timePassedSinceLastFrame}}__unserialize(t){}}r.Z.registerConstructor(c.__type,(t=>new c(t.v1,t.v2,t.progressMs,t.intervalMs,t.timingFunctionName,t.timePassed,t.timePassedSinceLastFrame)))},811:(t,e,s)=>{s.d(e,{g:()=>n});var i=s(607),r=s(464);class n{history;checks;steps;lastPlaneState;constructor(t,...e){this.history=new i.d(t),this.checks=e,this.steps=[]}addCheck(t){this.checks.push(t)}addStep(t){this.steps.push(t)}detect(t){t.planeState.size>0&&(t.planeState.forEach(((e,s)=>{const i=t.missileState.get(s),n=r.Z.length(r.Z.subtract(e.xy,i.xy)),a=r.Z.angle(e.v,i.v),o=Math.sign(r.Z.dotProduct(e.v,i.v))>=0,l=r.Z.behind(i.v,i.xy,e.xy),h=i.lastMissileIsDead;this.history.push({t:e.t,dist:n,angle:a,sameDir:o,behind:l,missileIsDead:h})})),this.checks.forEach((t=>t(this.history))))}step(t){if(t.planeState.size>0){const e=t.getLatestPlaneState(),s=t.getLatestMissileState();if(null===e||null===s)return;if(this.lastPlaneState===e)return;this.lastPlaneState=e;const i=r.Z.length(r.Z.subtract(e.xy,s.xy)),n=r.Z.angle(e.v,s.v),a=Math.sign(r.Z.dotProduct(e.v,s.v))>=0,o=r.Z.behind(s.v,s.xy,e.xy),l=s.lastMissileIsDead;let h={t:e.t,dist:i,angle:n,sameDir:a,behind:o,missileIsDead:l};this.steps.forEach((t=>t(h)))}}}},182:(t,e,s)=>{var i=s(165);class r{keyUp=new Map;keyDown=new Map;mouseUp=new Map;mouseDown=new Map;mouseLeave=new Map;mouseMoveAction=new Map;mouseZoomAction=new Map;doubleclickAction=new Map;_next=null;clone(){const t=new r;return t.keyUp=new Map(this.keyUp),t.keyDown=new Map(this.keyDown),t.mouseUp=new Map(this.mouseUp),t.mouseDown=new Map(this.mouseDown),t.mouseLeave=new Map(this.mouseLeave),t.mouseMoveAction=new Map(this.mouseMoveAction),t.mouseZoomAction=new Map(this.mouseZoomAction),t.doubleclickAction=new Map(this.doubleclickAction),null!=this._next&&(t._next=this._next.clone()),t}}let n=new Set,a=null,o=new r;function l(t,e){let s=o;do{let i=t(s);if(i.has(e))return i.get(e);s=s._next}while(null!==s);return null}function h(t,e){return(void 0===t[e]?"":t[e]).toString()+","+t.altKey.toString()+","+t.ctrlKey.toString()+","+t.metaKey.toString()+","+t.shiftKey.toString()}const c=[i.t`Left`,i.t`Middle`,i.t`Right`];function d(t){let e=t.split(","),s=parseInt(e[0]);return("true"==e[1]?"Alt + ":"")+("true"==e[2]?"Ctrl + ":"")+("true"==e[3]?"Win + ":"")+("true"==e[4]?"Shift + ":"")+(c[s]?c[s]:(0,i.t)(e[0]).replace(/^Key/,""))}let u=!1;window.onkeydown=t=>{if(u)return;if(n.has(t.code))return;n.add(t.code);let e=l((t=>t.keyDown),h(t,"code"));e&&(t.preventDefault(),e.callback(t))},window.onkeyup=t=>{if(u)return;n.delete(t.code);let e=l((t=>t.keyUp),h(t,"code"));e&&(t.preventDefault(),e.callback(t))};const g=function(t,e,s,i,r){const n=h({button:t,altKey:-1!==e.indexOf("Alt"),ctrlKey:-1!==e.indexOf("Ctrl"),metaKey:-1!==e.indexOf("Win")||-1!==e.indexOf("Meta"),shiftKey:-1!==e.indexOf("Shift")},"button");r&&o.mouseDown.set(n,{description:s,callback:r}),i&&o.mouseUp.set(n,{description:s,callback:i})},p=function(t,e,s,i,r){const n=h({code:t.toString(),altKey:-1!==e.indexOf("Alt"),ctrlKey:-1!==e.indexOf("Ctrl"),metaKey:-1!==e.indexOf("Win")||-1!==e.indexOf("Meta"),shiftKey:-1!==e.indexOf("Shift")},"code");i&&o.keyDown.set(n,{description:s,callback:i}),r&&o.keyUp.set(n,{description:s,callback:r})},m=function(){const t=t=>{let e=[];for(let[s,i]of function*(t){let e=new Set;for(let s=o;null!=s;s=s._next){let i=t(s);for(let[t,s]of i)e.has(t)||(e.add(t),yield[t,s])}}(t))e.push({description:i.description,button:s});return e};return{keys:t((t=>t.keyDown)).map((({button:t,description:e})=>d(t)+": "+e)),mouse:t((t=>t.mouseUp)).map((({button:t,description:e})=>d(t)+": "+e)).concat(t((t=>t.mouseZoomAction)).map((({button:t,description:e})=>d(t)+"Wheel: "+e)))}},f=function(t){a=t,a.onmousedown=t=>{if(u)return;t.preventDefault();let e=l((t=>t.mouseDown),h(t,"button"));e&&e.callback(t)},a.onmousemove=t=>{if(u)return;t.preventDefault();let e=l((t=>t.mouseMoveAction),h(t,""));e&&e.callback(t)},a.onmouseup=t=>{if(u)return;t.preventDefault();let e=l((t=>t.mouseUp),h(t,"button"));e&&e.callback(t)},a.ondblclick=t=>{if(u)return;t.preventDefault();let e=l((t=>t.doubleclickAction),h(t,""));e&&e.callback(t)},window.oncontextmenu=t=>{u||t.preventDefault()},a.addEventListener("wheel",(t=>{if(u)return;t.preventDefault();let e=l((t=>t.mouseZoomAction),h(t,""));e&&e.callback(t)}),!1),a.addEventListener("mouseleave",(t=>{if(u)return;t.preventDefault();let e=l((t=>t.mouseLeave),"");e&&e.callback(t)}))},y=()=>{let t=new r;t._next=o,o=t},v=()=>o.clone(),b=t=>{o=t},w=()=>{o=new r},x=()=>u=!0,_=()=>u=!1;var S=s(381),T=s(925),k=s(134),C=s(464),M=s(485);class P{static __type="Level";level=1;missileMaxCount=1;missileProbability=.5;missilePeriod=1e3;outOfRangeRadius=6e3;game;init(t){this.game=t,this.tryToCreate(k.Cp,(()=>this.missileProbability),(()=>this.missileMaxCount),(()=>{const e=t.gameMap.visibleSize,s=1.2*t.gameMap.visibleSize,i=C.Z.add(t.plane.xy,C.Z.random(e+Math.random()*(s-e)));return new k.Cp(i,t.plane)}),(()=>this.missilePeriod)),z(this.game,10,(()=>this.game.plane.lifes+=1)),z(this.game,5,(()=>this.game.plane.fakeTargets+=1)),z(this.game,2,(()=>this.game.plane.booster+=2e3))}progress(t){switch(this.level){case 1:(this.game.plane.score>4||this.game.globalTime>3e4)&&(this.level=2,this.missileMaxCount=2);break;case 2:this.game.globalTime>6e4&&(this.level=3,this.missileMaxCount=3,this.missileProbability=1)}}onDeadMissile(t){this.game.plane.score+=1,this.game.achievement(i.t`+1`,i.T.scoreColor,2e3,t)}tryToCreate(t,e,s,i,r,n){if(n&&(this.game.localMode||this.game.masterGameNode)&&Math.random()<e()&&this.game.flies.filter((e=>e instanceof t)).length<s()){let t,e;do{t=i(),e=!1;for(const s of this.game.flies)s.collideWith(t)&&(e=!0);if(!e)for(const s of this.game.gameMap.find(t.xy,t.linearSize()))s.collideWith(t)&&(e=!0)}while(e);this.game.addEntity(t)}T.Z.set((()=>this.tryToCreate(t,e,s,i,r,!0)),r())}__serialize(){return{level:this.level,missileMaxCount:this.missileMaxCount,missilePeriod:this.missilePeriod,missileProbability:this.missileProbability}}__unserialize(t){this.level=t.level,this.missileMaxCount=t.missileMaxCount,this.missilePeriod=t.missilePeriod,this.missileProbability=t.missileProbability}}function z(t,e,s){let i=t.plane.score;t.plane.subscribe((r=>{r instanceof k.Vz&&t.plane.score-i>=e&&(i=t.plane.score,s())}))}function I(t,e){let s;s=v(),w(),p("Space",[],i.t`Hide the message`,(()=>o())),p("Escape",[],i.t`Hide the message`,(()=>o())),p("Enter",[],i.t`Hide the message`,(()=>o())),g(0,[],i.t`Hide the message`,(()=>o()));let r=document.getElementById("message");r.innerHTML="";let n=document.createElement("div");n.innerText=t,r.appendChild(n),r.style.display="block",n.onclick=()=>o();let a=!1;function o(){a||(a=!0,r.style.display="none",void 0!==s&&b(s),e&&e())}return o}M.Z.registerConstructor(P.__type,(t=>new P));class E{r;map=new Map;constructor(t){this.r=t}insert(t,e,s){let i=Math.floor((t[0]-e)/this.r),r=Math.floor((t[0]+e)/this.r),n=Math.floor((t[1]-e)/this.r),a=Math.floor((t[1]+e)/this.r);for(let t=i,e=i*this.r;t<=r;t++,e+=this.r)for(let e=n,i=n*this.r;e<=a;e++,i+=this.r){let i=this.map.get(t);i||(i=new Map,this.map.set(t,i));let r=i.get(e);r||(r=new Set,i.set(e,r)),r.add(s)}}find(t,e){let s=Math.floor((t[0]-e)/this.r),i=Math.floor((t[0]+e)/this.r),r=Math.floor((t[1]-e)/this.r),n=Math.floor((t[1]+e)/this.r),a=new Set;for(let t=s;t<=i;t++)for(let e=r;e<=n;e++){let s=this.map.get(t);if(!s)continue;let i=s.get(e);i&&i.forEach((t=>a.add(t)))}return a}remove(t,e,s){let i=Math.floor((t[0]-e)/this.r),r=Math.floor((t[0]+e)/this.r),n=Math.floor((t[1]-e)/this.r),a=Math.floor((t[1]+e)/this.r);for(let t=i;t<=r;t++)for(let e=n;e<=a;e++){let i=this.map.get(t);if(!i)return;let r=i.get(e);if(!r)return;r.delete(s)}}clear(){this.map.clear()}}var Z=s(751),A=s(350);class F{loading=new Map;newTask(t,e){const s=this.loading.get(t);if(void 0!==s){const i=s.then((()=>e()));return this.loading.set(t,i),i}const i=e().then((e=>(this.loading.delete(t),e)));return this.loading.set(t,i),i}}class B{clear(t){return Object.keys(localStorage).filter((e=>e.startsWith(`parts[${t}]`))).forEach((t=>localStorage.removeItem(t))),Promise.resolve()}load(t,e){return Promise.resolve(localStorage.getItem(B.key(t,e)))}save(t,e,s){return localStorage.setItem(B.key(t,e),s),Promise.resolve()}static key(t,e){return`parts[${t}][${e}]`}restoreFromSnapshot(t,e){this.clear(t),JSON.parse(e).forEach((({key:t,value:e})=>localStorage.setItem(t,e)))}snapshot(t){const e=[];for(let s in localStorage)s.startsWith(`parts[${t}]`)&&e.push({key:s,value:localStorage[s]});return JSON.stringify(e)}}class O{firebase;constructor(t){this.firebase=t}clear(t){throw new Error("Unsupported operation")}load(t,e){return this.firebase.loadString(`/maps/${encodeURIComponent(t)}/${encodeURIComponent(e)}`)}save(t,e,s){return this.firebase.saveString(`/maps/${encodeURIComponent(t)}/${encodeURIComponent(e)}`,s)}restoreFromSnapshot(t,e){throw new Error("Unsupported operation")}snapshot(t){throw new Error("Unsupported operation")}}class N{source;cache;writeBoth=!1;constructor(t,e){this.source=t,this.cache=e}clear(t){return this.cache.clear(t)}load(t,e){return this.cache.load(t,e).then((s=>null===s?this.source.load(t,e).then((s=>null===s?null:this.cache.save(t,e,s).then((()=>s)))):s))}save(t,e,s){return this.writeBoth?Promise.all([this.cache.save(t,e,s),this.source.save(t,e,s)]):this.cache.save(t,e,s)}restoreFromSnapshot(t,e){this.cache.restoreFromSnapshot(t,e)}snapshot(t){return this.cache.snapshot(t)}}class R{backend;seqTasks=new F;constructor(t=new B){this.backend=t}load(t,e,s,i){if(Number.isNaN(e)||Number.isNaN(s))throw new Error("Can't load the part: "+e+", "+s);return this.seqTasks.newTask(`${t},${e},${s}`,(()=>this.backend.load(t,`${e},${s}`).then((t=>{if(null===t||"null"===t)return null;const r=M.Z.unserializeWithLinks((()=>M.Z.unserialize(t)),(()=>new Map([["game",i]])));return console.log("loaded",e,s),r}))))}save(t,e,s,i){if(Number.isNaN(e)||Number.isNaN(s))throw new Error("Can't save the part: "+e+", "+s);return this.seqTasks.newTask(`${t},${e},${s}`,(()=>this.backend.save(t,`${e},${s}`,M.Z.serialize(i)).then((t=>console.log("saved",e,s)))))}clear(t){return this.backend.clear(t)}}class U{game;_visibleSize;gameSeed;parts=new Map;byId=new Map;tree;lastPx;lastPy;partsStore;seqTasks=new F;constructor(t,e,s,i,r=new B){this.game=t,this._visibleSize=s,this.gameSeed=i,this.tree=new E(e),this.partsStore=new R(r)}get visibleSize(){return this._visibleSize}find(t,e){return this.tree.find(t,e)}findById(t){return this.byId.get(t)}reset(t=!1){t&&(this.lastPx=this.lastPy=1/0),this.parts.clear(),this.tree.clear(),this.byId.clear()}isPartAvailableForXy(t){const[e,s]=this.toPartCoordinates(t),i=this.parts.get(e);return void 0!==i&&void 0!==i.get(s)}deleteAllCustomContent(){return this.reset(!0),this.partsStore.clear(this.gameSeed)}partTask(t,e){return this.seqTasks.newTask(`${t.px},${t.py}`,(()=>e(t)))}async iAmHere(t){const[e,s]=this.toPartCoordinates(t);if(this.lastPx==e&&this.lastPy==s)return;const i=this.lastPx,r=this.lastPy;this.lastPx=e,this.lastPy=s;let n=!1;Math.max(Math.abs(i-e),Math.abs(r-s))>2&&(console.log("teleportation detected from",i,r,"to",e,s),await this.saveChanged(),this.reset(),n=!0);const a=await this.loadNeighborhood(e,s);n||await this.unloadNonNeighbors(i,r,a)}unloadNonNeighbors(t,e,s){const i=[];for(let r of[-1,0,1])for(let n of[-1,0,1]){const a=t+r,o=e+n;if(s.has(`${a},${o}`))continue;const l=this.parts.get(a);if(void 0===l)continue;const h=l.get(o);if(!h)continue;const c=()=>{this.removePart(h),console.log("unloaded",h.px,h.py)};h.random?c():i.push(this.savePart(h).then((()=>c())))}return Promise.all(i).then()}loadNeighborhood(t,e){const s=new Set,i=[];for(let r of[0,-1,1])for(let n of[0,-1,1]){const a=t+r,o=e+n;s.add(`${a},${o}`);let[l,h]=this.getOrCreatePart(a,o);if("new"===h){const t=this.loadPart(l);i.push(t)}}return Promise.all(i).then((()=>s))}withTemporaryEntity(t,e){const s=this.getPartByXy(t.xy);null!==s&&(this.add(s,t),e(),this.remove(s,t,!0))}addEntity(t){const e=this.getPartByXy(t.xy);null!==e&&(this.add(e,t),e.random=!1)}entityChanged(t){const e=this.getPartByXy(t.xy);null!==e&&(e.random=!1)}changeEntityGeometry(t,e){this.removeEntity(t),e(t),this.addEntity(t)}changeEntityGeometryAndSave(t,e){this.changeEntityGeometry(t,e),this.saveChanged()}addEntityAndSave(t){this.addEntity(t),this.saveChanged()}removeEntity(t){const e=this.getPartByXy(t.xy);null!==e&&this.remove(e,t,!0)}removeEntityAndSave(t){this.removeEntity(t),this.saveChanged()}saveChanged(){const t=[];for(const e of this.parts.values())for(const s of e.values())s.random||t.push(this.savePart(s));return Promise.all(t)}toPartCoordinates(t){return[Math.floor(t[0]/this._visibleSize),Math.floor(t[1]/this._visibleSize)]}*all(){for(const t of this.parts.values())for(const e of t.values())for(let t of e.entities)yield t}drawParts(t){t.strokeStyle="#cccccc";for(const[e,s]of this.parts)for(const i of s.keys())t.strokeRect(e*this._visibleSize,i*this._visibleSize,this._visibleSize,this._visibleSize)}savePart(t){return this.partTask(t,(t=>this.partsStore.save(this.gameSeed,t.px,t.py,t.entities)))}loadPart(t){return this.partTask(t,(t=>this.partsStore.load(this.gameSeed,t.px,t.py,this.game).then((e=>{if(e){for(let s of e)this.add(t,s);t.random=!1}else this.generate(t)}))))}randomXy(t,e,s){return[(t+s.nextFloat())*this._visibleSize,(e+s.nextFloat())*this._visibleSize]}generate(t){const e=new A.K(`${t.px},${t.py},${this.gameSeed}`);return this.tryToCreate(t,this._visibleSize/2e3,(()=>new k.Ux(this.randomXy(t.px,t.py,e))),e),this.tryToCreate(t,this._visibleSize/4e3,(()=>new k.Vk(this.randomXy(t.px,t.py,e))),e),this.randomObstacles(t,4*this._visibleSize/1e3,e),this.randomClouds(t,10*this._visibleSize/500,e),console.log("generated",t.px,t.py),t.random=!0,t}tryToCreate(t,e,s,i){const r=Math.floor(i.nextFloat()*(e+1));for(let e=0;e<r;e++){let e,i;do{e=s(),i=!1;for(const t of this.tree.find(e.xy,e.linearSize()))t.collideWith(e)&&(i=!0)}while(i);this.add(t,e)}}randomObstacles(t,e,s){const i=Math.floor(s.nextFloat()*(e+1));for(let e=0;e<i;e++){let e,i=!1;do{let r=this.randomXy(t.px,t.py,s),n=20+30*s.nextFloat();const a=Math.round(3+10*s.nextFloat()),o=[];for(let t=0;t<a;t++){const e=n*Math.cos(2*Math.PI/a*t),s=n*Math.sin(2*Math.PI/a*t);o.push([r[0]+e,r[1]+s])}e=new k.JA(new Z.OI(o)),i=!1;for(let t of this.tree.find(r,n))t.collideWith(e)&&(i=!0)}while(i);this.add(t,e)}}randomClouds(t,e,s){const i=Math.floor(s.nextFloat()*(e+1));for(let e=0;e<i;e++)this.add(t,new k.ZJ(this.randomXy(t.px,t.py,s),s))}removePart(t){t.entities.forEach((e=>this.remove(t,e,!1))),t.entities=[];const e=this.parts.get(t.px);void 0!==e&&(e.delete(t.py),0==e.size&&this.parts.delete(t.px))}remove(t,e,s){if(s){const s=t.entities.indexOf(e);if(s<0)throw new Error("Can't remove non-existing entity");t.entities.splice(s,1)}t.random=!1,e.setGame(null),this.tree.remove(e.xy,e.linearSize(),e),this.byId.delete(e.id)}getPartByXy(t){const e=Math.floor(t[0]/this._visibleSize),s=Math.floor(t[1]/this._visibleSize),i=this.getPart(e,s,!1);return null===i?null:i[0]}getOrCreatePart(t,e){const s=this.getPart(t,e,!0);if(null===s)throw new Error("Part must be gotten or created: "+t+NaN+e);return s}getPart(t,e,s){let i=this.parts.get(t);void 0===i&&this.parts.set(t,i=new Map);let r=i.get(e);return void 0===r?s?(r={entities:[],random:!0,px:t,py:e},i.set(e,r),[r,"new"]):null:[r,"existing"]}add(t,e){if(this.byId.has(e.id))throw new Error("Entity with the id already exists: "+e.id);this.byId.set(e.id,e),e.setGame(this.game),this.tree.insert(e.xy,e.linearSize(),e),t.entities.push(e),t.entities.sort(((t,e)=>t.layer>e.layer?1:t.layer==e.layer?0:-1))}}function D(t){const e=H(new W(t));return t=>e.map((e=>e.eval(t))).join("")}class L{}class $ extends L{value;constructor(t){super(),this.value=t}eval(t){return this.value}}class j extends L{varName;optional=!1;constructor(t){super(),this.varName=t,this.varName.endsWith("?")&&(this.varName=this.varName.substr(0,this.varName.length-1),this.optional=!0)}eval(t){if(t.has(this.varName))return t.get(this.varName);const e=this.varName.split(".");if(1==e.length){if(this.optional)return"";throw new Error("Var is not defined: "+this.varName)}if(!t.has(e[0])){if(this.optional)return"";throw new Error("Var is not defined: "+this.varName)}let s=t.get(e[0]);for(let t=1;t<e.length;t++){const i=s[e[t]];if(void 0===i){if(this.optional)return"";throw new Error("Var is not defined: "+this.varName)}s=i}return s}}class V extends L{varName;arrayVarNode;body;constructor(t,e,s){super(),this.varName=t,this.arrayVarNode=e,this.body=s}eval(t){let e="";const s=new Map(t),i=this.arrayVarNode.eval(t);for(const t of i)s.set(this.varName,t),e+=this.body.map((t=>t.eval(s))).join("");return e}}class G extends L{node;value;body;constructor(t,e,s){super(),this.node=t,this.value=e,this.body=s}eval(t){return this.node.eval(t)==this.value?this.body.map((e=>e.eval(t))).join(""):""}}class W{_s;_pos;_captured=null;constructor(t,e=0){this._s=t,this._pos=e}get captured(){if(null===this._captured)throw new Error("Nothing captured");return this._captured}captureUntil(t){const e=this._s.indexOf(t,this._pos);if(-1==e)return this._captured=this._s.substr(this._pos),this._pos=this._s.length,!1;const s=e-this._pos;return this._captured=s>0?this._s.substr(this._pos,s):"",this._pos=e+t.length,!0}hasMore(){return this._pos<this._s.length}}function H(t){const e=[];for(;t.hasMore();){let s=t.captureUntil("{{");if(t.captured&&e.push(new $(t.captured)),!s)break;if(s=t.captureUntil("}}"),!s)throw new Error("No closing }} found: "+t);const i=t.captured;if(":end"==i)break;if(i.startsWith(":for")){const s=i.match(/^:for\s+([^: ]+):([^: ]+)$/);if(!s)throw new Error("Bad :for: "+t);const r=s[1],n=s[2],a=H(t);e.push(new V(r,new j(n),a))}else if(i.startsWith(":if")){const s=i.match(/^:if\s+([^: ]+)\s*=\s*([^: ]+)$/);if(!s)throw new Error("Bad :for: "+t);const r=s[1],n=s[2],a=H(t);e.push(new G(new j(r),n,a))}else e.push(new j(i))}return e}class J{ta;tokenizer=new K;constructor(t){this.ta=t,x(),t.onkeydown=t=>this.onKeyDown(t),t.onkeyup=t=>this.onKeyUp(t)}detach(){this.ta.onkeydown=this.ta.onkeyup=this.ta.onfocus=this.ta.onblur=null,_()}timerId;onKeyUp(t){void 0!==this.timerId&&(window.clearTimeout(this.timerId),this.timerId=void 0),"."==t.key&&(this.timerId=window.setTimeout((()=>this.trySuggest()),500))}onKeyDown(t){" "==t.key&&t.ctrlKey&&(t.preventDefault(),this.trySuggest())}trySuggest(){const t=this.suggest();t&&this.showSuggestions(t,(t=>{this.ta.setRangeText(t);const e=this.cursorPos()+t.length;this.ta.setSelectionRange(e,e)}),"")}cursorPos(){return"forward"===this.ta.selectionDirection?this.ta.selectionStart:this.ta.selectionEnd}static suggestions;static initSuggestions(){J.suggestions=new Map([["api",["posOf()","playerHas()","playerSet()","playerRemove()","teleport()","after()","move()","showText()"]],["after()",["move()"]],["move()",["speed()","slow()","fast()","ease()","linear()","up()","down()","left()","right()","offset()","to()"]],["then()",["move()","after()"]],["offset()",["end()","then()","loop()"]],["to()",["end()","then()","loop()"]]]);for(const t in["offset","to","up","down","left","right"])J.suggestions.set(t+"()",["end()","then()","loop()"])}suggest(){const t=this.tokenizer.tokenLeft(this.ta.value,this.cursorPos()-1);switch(t.type){case".":{let e=t.value.replace(/^(.+)\(.*\)$/,"$1()");return J.suggestions.get(e)||[]}}return[]}showSuggestions(t,e,s){if(0==t.length)return e("");if(1==t.length)return e(t[0]);const i=document.createElement("div");i.classList.add("suggestions"),i.style.position="absolute",i.style.zIndex="10000";const r=this.ta.getBoundingClientRect(),{left:n,top:a}=getCaretCoordinates(this.ta,this.cursorPos());i.style.left=r.x+n+"px",i.style.top=r.y+a+"px";let o=0;const l=[];for(let e=0;e<t.length;e++){const s=t[e],r=document.createElement("div");l.push(r),r.classList.add("line"),o==e&&r.classList.add("selected"),r.innerText=s,i.appendChild(r)}document.body.appendChild(i);const h=t=>{l[o].classList.remove("selected"),o=t,l[o].classList.add("selected")},c=r=>{if(r.preventDefault(),r.key.match(/^[a-zA-Z]$/)){s+=r.key;for(let e=0;e<t.length;e++)if(t[e].startsWith(s)){h(e);break}}else s="","ArrowUp"==r.key?h((o+t.length-1)%t.length):"ArrowDown"==r.key?h((o+1)%t.length):"Enter"==r.key?(document.body.removeEventListener("keydown",c),i.remove(),e(t[o])):"Escape"==r.key&&(document.body.removeEventListener("keydown",c),i.remove(),e(""))};document.body.addEventListener("keydown",c)}}class K{constructor(){}tokenLeft(t,e){let s;for(s=e;s>=0&&!t[s].match(/[^ \n]/);s--);return"."==t[s]?{type:".",value:this.scanLeft(t,s-1)}:{type:"unknown",value:""}}scanLeft(t,e){let s="",i=e;for(;i>=0&&!t[i].match(/[^ \n]/);i--);for(;i>=0;i--)if('"'==t[i]){for(;i>=0&&'"'!=t[i];i--)s=t[i]+s;i>=0&&(s=t[i]+s)}else if(")"==t[i]){for(;i>=0&&"("!=t[i];i--)s=t[i]+s;i>=0&&(s=t[i]+s)}else{if(!t[i].match(/[^.\n \t]/))break;s=t[i]+s}return s}}J.initSuggestions();class X extends class{_changeable=!0;changeable(){return this._changeable}setChangeable(t){this._changeable=t}}{_name;_value;constructor(t,e){super(),this._name=t,this._value=e}get(){return this._value}name(){return this._name}set(t){this._value=t.toString()}type(){return"text"}}function q(t,e=0){return new Promise((s=>{let i;null===e?i=0:"string"==typeof e?(i=t.indexOf(e),i<0&&(i=0)):i=e;const r=[],n=v();w(),p("ArrowUp",[],"Up",(()=>{i=(i+r.length-1)%r.length,r[i].onmouseover({target:r[i]})})),p("ArrowDown",[],"Down",(()=>{i=(i+1)%r.length,r[i].onmouseover({target:r[i]})}));const a=()=>r[i].onclick({target:r[i]});p("Enter",[],"Select",a),p("Space",[],"Select",a),p("Escape",[],"Exit",(()=>{r[i].onclick(null)}));let o=document.createElement("div");o.classList.add("modal");let l=document.createElement("div");l.classList.add("menu");for(let e=0;e<t.length;e++){const a=t[e];let h=document.createElement("a");h.innerText=a,h.onmouseover=t=>{[...l.querySelectorAll(".hover")].forEach((t=>t.classList.remove("hover"))),t.target.classList.add("hover")},h.onclick=i=>{o.remove(),l.remove(),b(n),s(null==i?null:t[e])},e==i&&h.classList.add("hover"),l.appendChild(h),r.push(h)}document.body.appendChild(o),document.body.appendChild(l)}))}var Y=s(32),Q=localStorage.missilesIdentity;function tt(t){Q=t,localStorage.missilesIdentity=t}const et={get:function(){return new Promise((t=>{if(Q)return void t(Q);const e=new XMLHttpRequest;e.open("POST","https://api.random.org/json-rpc/2/invoke"),e.onreadystatechange=function(){if(4===e.readyState)if(e.status.toString().startsWith("2")){let s;try{s=JSON.parse(e.responseText).result.random.data[0]}catch(t){s=(0,Y.h)()}s&&(tt(s),t(Q))}else tt((0,Y.h)()),t(Q)},e.setRequestHeader("Content-Type","application/json"),e.setRequestHeader("Accept","application/json"),e.send(JSON.stringify({jsonrpc:"2.0",method:"generateUUIDs",params:{apiKey:"c39b179c-7559-4512-8db3-6cfccd63c748",n:1},id:1}))}))},set:tt},st="first-game",it=new class{baseUrl;version;constructor(t,e="v1"){this.baseUrl=t,this.version=e}put(t,e){return new Promise(((s,i)=>{var r=new XMLHttpRequest;r.open("PUT",`${this.baseUrl}/${this.version}${t}.json`),r.onreadystatechange=()=>{4===r.readyState&&(r.status.toString().startsWith("2")?s(JSON.parse(r.responseText)):i(r))},r.setRequestHeader("Content-Type","application/json"),r.setRequestHeader("Accept","application/json"),r.send(e)}))}delete(t){return new Promise(((e,s)=>{var i=new XMLHttpRequest;i.open("DELETE",`${this.baseUrl}/${this.version}${t}.json`),i.onreadystatechange=()=>{4===i.readyState&&(i.status.toString().startsWith("2")?e(JSON.parse(i.responseText)):s(i))},i.setRequestHeader("Accept","application/json")}))}getString(t,e){return new Promise(((s,i)=>{var r=new XMLHttpRequest;r.open("GET",`${this.baseUrl}/${this.version}${t}.json`+(e?"?shallow=true":"")),r.onreadystatechange=()=>{4===r.readyState&&(r.status.toString().startsWith("2")?s(r.responseText):i(r))},r.setRequestHeader("Accept","application/json"),r.send()}))}get(t,e){return this.getString(t,e).then((t=>JSON.parse(t)))}load(t){return this.get(t,!1)}loadString(t){return this.getString(t,!1)}saveString(t,e){return this.put(t,e).then()}deleteString(t){return this.delete(t).then()}loadKeys(t){return this.get(t,!0).then((t=>null!=t?Object.keys(t):[]))}}("https://missiles-e8ad3.firebaseio.com");class rt{ctx;localMode;userId;gameState="not started";masterGameNode=!1;frameCallback=null;gameOverCallback=null;newGameCallback=null;paused=!1;flies;fliesById;fliesToAddAfterTick;overlays=[];triggers=[];inbetween=!1;lastT;timeScale;boosterIsUsed;globalTime;rotationDirection;fakeTargetTimerId;outOfRange;fps;plane;level;gameMap;radarCtx=null;constructor(t,e=!0,s){this.ctx=t,this.localMode=e,this.userId=s,this.init()}startFromTheBeginning(){this.gameState="in progress",this.paused=!0,T.Z.clearAll(),this.flies=[],this.fliesById=new Map,this.fliesToAddAfterTick=[],this.overlays=[],this.triggers=[],this.inbetween=!1,this.lastT=null,this.timeScale=1,this.boosterIsUsed=!1,this.globalTime=0,this.rotationDirection=null,this.fakeTargetTimerId=null,this.outOfRange=!1,this.fps=0,this.plane=new k.JO(i.T.planeStartPos),this.plane.subscribe((t=>this.onPlaneEvent(t))),this.userId&&(this.plane.id=this.userId),this.level=new P,this.recreateGameMap(200,1500,st),this.gameMap.deleteAllCustomContent(),this.addEntity(this.plane),this.level.init(this),S.Z.init(this),this.resume()}onPlaneEvent(t){t instanceof k.$7&&(t.amount>0&&this.achievement(i.t`${i.T.life} +${t.amount}`,i.T.lifeColor,2e3,t.target),null!==t.target&&t.target.lifes<=0&&this.explosionFor(t.target)),t instanceof k.gF&&t.amount>0&&t.target&&t.target.addInfo("fake targets",(()=>i.t`${i.T.fakeTarget} +${t.amount}`),3e3,i.T.fakeTargetColor),t instanceof k.qF&&t.amount>0&&t.target&&t.target.addInfo("booster",(()=>i.t`${i.T.booster} +${Math.round(t.amount/1e3)}`),3e3,i.T.boosterColor)}achievement(t,e,s,i){this.addEntity(new k.PE((i||this.plane).xy,t,e,s))}addInfo(t,e,s,i){this.plane.addInfo(t,e,s,i)}removeInfo(t){this.plane.removeInfo(t)}addEntity(t){if(t instanceof k.MB)throw new Error("Static entities can't be added here");t.setGame(this),this.inbetween?this.fliesToAddAfterTick.push(t):(this.flies.push(t),this.fliesById.set(t.id,t),this.sort())}teleportTo(t){this.plane.xy=t,this.gameMap.iAmHere(this.plane.xy).then((()=>console.log("teleported",t[0],t[1])))}addNewFlies(){this.fliesToAddAfterTick.length>0&&(this.fliesToAddAfterTick.forEach((t=>{this.flies.push(t),this.fliesById.set(t.id,t)})),this.sort(),this.fliesToAddAfterTick=[])}sort(){this.flies.sort(((t,e)=>t.layer>e.layer?1:t.layer==e.layer?0:-1))}addTrigger(t){this.triggers.push(t)}addOverlay(t){return this.overlays.push(t),()=>{const e=this.overlays.indexOf(t);e>=0&&this.overlays.splice(e,1)}}init(){var t,e;w(),y(),t=()=>this.pause(),e=()=>this.resume(),p("F1",[],i.t`Show this help message (F1 again to hide)`,(()=>{t&&t();const s=document.getElementById("help");let r;const n=()=>{b(r),s.style.display="none",e&&e()};if("block"==s.style.display)return void n();let a=m();r=v(),w(),p("Escape",[],i.t`Hide help message`,(()=>n())),p("F1",[],i.t`Hide help message`,(()=>n())),s.innerHTML="<h2>"+i.t`Keyboard`+"</h2>\n<pre>"+a.keys.join("\n</pre><pre>")+"</pre>",s.style.display="block"})),p("ArrowRight",[],i.t`Turn right`,(()=>{this.rotationDirection="right",this.plane.right()}),(()=>{"right"==this.rotationDirection&&this.plane.noRotate()})),p("ArrowLeft",[],i.t`Turn left`,(()=>{this.rotationDirection="left",this.plane.left()}),(()=>{"left"==this.rotationDirection&&this.plane.noRotate()})),p("KeyF",[],i.t`Fast/Unfast`,(()=>{this.timeScale<1?this.timeScale=1:this.timeScale=Math.max(this.timeScale/1.8,.01)})),p("KeyS",[],i.t`Slowmo/Unslowmo`,(()=>{this.timeScale>1?this.timeScale=1:this.timeScale=Math.min(2.5*this.timeScale,10)})),p("ArrowUp",[],i.t`Boost/Unboost`,(()=>{this.boosterIsUsed?(this.plane.maxVelocity=.1,this.plane.stopBoost()):(this.plane.maxVelocity=this.plane.booster>0?.15:.1,this.plane.startBoost()),this.boosterIsUsed=!this.boosterIsUsed})),p("ArrowDown",[],i.t`Unboost`,(()=>{this.boosterIsUsed&&(this.plane.maxVelocity=.1,this.plane.stopBoost(),this.boosterIsUsed=!1)})),p("Escape",[],i.t`Show Menu`,(()=>this.mainMenu())),p("KeyP",[],i.t`Pause`,(()=>{"in progress"===this.gameState&&(this.pause(),I(i.t`Paused`,(()=>this.resume())))})),p("Space",[],i.t`Launch fake targets`,(()=>this.launchFakeTarget()))}mainMenu(t=0){this.pause();let e=[];switch(this.gameState){case"in progress":e=["Continue","Save Game","Load Game","New Game","User ID"];break;case"game over":case"not started":e=["Load Game","New Game","User ID"];break;default:throw new Error("Unknown gameState: "+this.gameState)}q(e,t).then((t=>{switch(t){case null:case"Continue":"in progress"!==this.gameState?this.mainMenu():this.resume();break;case"Save Game":this.getSavedGames().then((e=>{e.push("New ...");const s=()=>{q(e).then((e=>{if(null===e)return this.mainMenu(t);let i=e;if("New ..."===e&&(i=window.prompt("Name"),!i))return s();this.saveGame(i).then((()=>window.setTimeout(I("Saved",(()=>this.resume())),3e3)))}))};s()}));break;case"Load Game":this.getSavedGames().then((e=>{if(0==e.length)return I("No Saved Games",(()=>this.mainMenu(t)));q(e).then((e=>{if(null===e)return this.mainMenu(t);this.loadGame(e).then((()=>{I("Loaded",(()=>this.resume()))}))}))}));break;case"New Game":"in progress"===this.gameState?this.gameOver(0,!0):this.startFromTheBeginning();break;case"User ID":et.get().then((e=>{const s=new X("Current ID",e);s.setChangeable(!1);const i=new X("New ID","");var r;(r=[s,i],new Promise((t=>{const e=v();w();const s=D(document.getElementById("formTemplate").innerHTML);let i=document.createElement("div");i.classList.add("modal");const n=document.createElement("div"),a=r.map((t=>({type:t.type(),name:t.name(),changeable:t.changeable()?"true":"false"}))),o=new Map([["fields",a],["ok","okBtn"],["cancel","cancelBtn"]]);let l;n.innerHTML=s(o),document.body.appendChild(i),document.body.appendChild(n);let h=!1;for(let t of r)switch(t.type()){case"boolean":document.getElementById("formField_"+t.name()).checked=t.get();break;case"text":case"textarea":case"js":const e=document.getElementById("formField_"+t.name());e.value=t.get().toString(),!h&&e.focus(),h=!0,"js"===t.type()&&(l=new J(e))}const c=()=>{l&&l.detach(),document.body.removeChild(n),document.body.removeChild(i),b(e)};document.getElementById("okBtn").onclick=()=>{for(let t of r)if(t.changeable())switch(t.type()){case"boolean":t.set(document.getElementById("formField_"+t.name()).checked);break;case"text":case"textarea":case"js":t.set(document.getElementById("formField_"+t.name()).value)}c(),t(!0)};const d=()=>{c(),t(!1)};p("Escape",[],"Cancel",(t=>d())),document.getElementById("cancelBtn").onclick=d}))).then((e=>{if(!e)return this.mainMenu(t);et.set(i.get()),I("User ID applied",(()=>this.mainMenu(t)))}))}))}}))}frame(t){if(this.paused)return;if(this.gameMap.iAmHere(this.plane.xy),!this.gameMap.isPartAvailableForXy(this.plane.xy))return void requestAnimationFrame((t=>this.frame(t)));this.inbetween=!0,null===this.lastT&&(this.lastT=t);let e=t-this.lastT;T.Z.progress(e),this.fps=e>0?(100*this.fps+1e3/e)/101:0,e/=this.timeScale,this.lastT=t,this.globalTime+=e,this.level.progress(e),this.updateBooster(e),this.progress(e),this.detectCollision(),this.triggers.forEach((t=>t(e))),this.removeDead(),this.addNewFlies(),this.draw(),this.frameCallback&&this.frameCallback(),requestAnimationFrame((t=>this.frame(t))),this.inbetween=!1}updateBooster(t){this.boosterIsUsed&&(this.plane.booster-=t,this.plane.booster<=0&&(this.plane.booster=0,this.boosterIsUsed=!1,this.plane.maxVelocity=.1,this.plane.stopBoost()))}progress(t){const e=e=>e.progress(t);for(let t of this.flies)e(t);for(let t of this.gameMap.all())e(t)}detectCollision(){if(this.localMode||this.masterGameNode)for(let t=0;t<this.flies.length;t++){const e=this.flies[t];for(let s=t+1;s<this.flies.length;s++){const t=this.flies[s];this.tryCollide(e,t)}for(const t of this.gameMap.find(e.xy,e.linearSize()))this.tryCollide(e,t)}}tryCollide(t,e){if(t!==e&&!(t instanceof k.JA&&e instanceof k.JA)&&t.collideWith(e)){if(t instanceof k.JO&&e instanceof k.JO)return t.lifes=1,e.lifes=1,t.lifes-=1,void(e.lifes-=1);if(t instanceof k.JO||e instanceof k.JO){const s=t instanceof k.JO?e:t,i=t instanceof k.JO?t:e;if(s instanceof k.Hs)return void s.collected(i);s instanceof k.JA?i.lifes=1:this.explosionFor(s),i.lifes-=1}else t instanceof k.Cp&&this.level.onDeadMissile(t),e instanceof k.Cp&&this.level.onDeadMissile(e),t instanceof k.JA||this.explosionFor(t),e instanceof k.JA||this.explosionFor(e)}}removeDead(){const t=[];for(const e of this.gameMap.all())e.dead&&t.push(e);t.length>0&&t.forEach((t=>this.gameMap.removeEntity(t)));const e=this.flies.filter((t=>t.dead));if(e.length>0){let t=!1;e.forEach((e=>{e===this.plane&&(t=!0),this.flies.splice(this.flies.indexOf(e),1).forEach((t=>{t.setGame(null),this.fliesById.delete(t.id)}))})),t&&this.gameOver()}}gameOver(t,e=!1){this.gameMap.saveChanged().then((()=>{null!==this.gameOverCallback&&this.gameOverCallback();const s=setTimeout((()=>{this.pause(),this.gameState="game over",I(i.t`Game Over`,(()=>{clearTimeout(s),null!==this.newGameCallback?this.newGameCallback():e?this.startFromTheBeginning():this.mainMenu()}))}),void 0!==t?t:2e3)}))}explosionFor(t){t.dead=!0,this.addEntity(new k.OQ(t.xy,t instanceof k.JO?5:1))}draw(){this.ctx.fillStyle=this.outOfRange?i.T.skyOutOfRangeColor:i.T.skyColor,this.ctx.fillRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.overlays.forEach((t=>{this.ctx.save(),t.drawPre(this.ctx),this.ctx.restore()})),this.ctx.save(),this.ctx.translate(-this.plane.xy[0]+this.ctx.canvas.width/2,-this.plane.xy[1]+this.ctx.canvas.height/2),this.flies.forEach((t=>{this.ctx.save(),t.draw(this.ctx),this.ctx.restore()}));for(const t of this.gameMap.all())this.ctx.save(),t.draw(this.ctx),this.ctx.restore();this.overlays.forEach((t=>{this.ctx.save(),t.drawOverMap(this.ctx),this.ctx.restore()})),this.ctx.restore(),this.ctx.save(),this.drawScore(this.ctx),this.ctx.restore(),this.ctx.save(),this.drawRadar(this.ctx),this.ctx.restore(),this.ctx.save(),this.overlays.forEach((t=>{this.ctx.save(),t.drawPost(this.ctx),this.ctx.restore()})),this.ctx.restore()}drawScore(t){const e=14*1.1;let s=e;t.font="14px serif",t.fillStyle="black",t.fillText("FPS: "+Math.round(this.fps),0,s),s+=e,t.fillStyle=i.T.timeColor,t.fillText(i.t`${i.T.time} ${Math.round(this.globalTime/1e3)}`,0,s),s+=e,t.fillStyle=i.T.scoreColor,t.fillText(i.t`${i.T.score} ${this.plane.score}`,0,s),s+=e,t.fillStyle=i.T.fakeTargetColor,t.fillText(i.t`${i.T.fakeTarget} ${this.plane.fakeTargets}`,0,s),s+=e,t.fillStyle=i.T.boosterColor,t.fillText(i.t`${i.T.booster} ${Math.round(this.plane.booster/1e3)}`,0,s),s+=e,t.fillStyle=i.T.lifeColor,t.fillText(i.t`${i.T.life} ${this.plane.lifes}`,0,s)}drawRadar(t){const e=i.T.radarSize,s=i.T.radarScale;if(null===this.radarCtx){const t=document.createElement("canvas");t.width=2*e+5,t.height=2*e+5,this.radarCtx=t.getContext("2d")}if(null===this.radarCtx)return;const r=this.radarCtx,n=r.canvas.width,a=r.canvas.height;r.save(),r.clearRect(0,0,n,a);const o=t.canvas.height/t.canvas.width;r.scale(1,o);const l=n/2,h=a/2;r.fillStyle=i.T.radarFillColor,r.strokeStyle=i.T.radarStrokeColor,r.beginPath(),r.arc(l,h,e,0,2*Math.PI),r.fill(),r.beginPath(),r.arc(l,h,e,0,2*Math.PI),r.stroke(),r.strokeStyle=i.T.radarSectorColor;for(let t=0;t<6;t++){r.beginPath(),r.moveTo(l,h);const s=2*Math.PI/6*t;r.lineTo(l+Math.cos(s)*e,h+Math.sin(s)*e),r.stroke()}r.beginPath(),r.arc(l,h,e,0,2*Math.PI),r.clip(),r.strokeStyle=i.T.radarVisibilityAreaColor,r.beginPath(),r.arc(l,h,t.canvas.height/2/s,0,2*Math.PI),r.stroke(),r.scale(1/s,1/s),r.translate(-this.plane.xy[0],-this.plane.xy[1]),r.translate(n/2*s,a/2*s),r.strokeStyle=i.T.radarPlaneColor,r.lineWidth=s,r.beginPath(),r.moveTo(this.plane.xy[0],this.plane.xy[1]-3*s/o),r.lineTo(this.plane.xy[0],this.plane.xy[1]+3*s/o),r.moveTo(this.plane.xy[0]-3*s,this.plane.xy[1]),r.lineTo(this.plane.xy[0]+3*s,this.plane.xy[1]),r.stroke();for(const t of this.gameMap.all())r.save(),r.globalAlpha=.4,t.draw(r),r.restore();for(let t of this.flies)r.save(),t!==this.plane&&t instanceof k.JO?(r.strokeStyle=i.T.radarEnemyColor,r.beginPath(),r.moveTo(t.xy[0]-3*s,t.xy[1]),r.lineTo(t.xy[0]+3*s,t.xy[1]),r.moveTo(t.xy[0],t.xy[1]-3*s/o),r.lineTo(t.xy[0],t.xy[1]+3*s/o),r.stroke()):(t instanceof k.Cp||t instanceof k.Hs)&&(r.fillStyle=t instanceof k.Cp?i.T.radarMissileColor:i.T.radarPerkColor,r.beginPath(),r.ellipse(t.xy[0],t.xy[1],2*s,2*s/o,0,0,2*Math.PI),r.fill()),r.restore();r.restore(),t.globalAlpha=i.T.radarAlpha,t.drawImage(r.canvas,t.canvas.width-2*e-10,10)}pause(){"in progress"!==this.gameState||this.paused||(this.paused=!0,this.gameMap.saveChanged())}resume(){this.paused&&(this.lastT=null,this.paused=!1,requestAnimationFrame((t=>this.frame(t))))}launchFakeTarget(){if(this.plane.fakeTargets<=0)return;if(!this.fakeTargetTimerId)return this.fakeTargetTimerId=T.Z.set((()=>{this.plane.hideFakeTargetRadius(),this.fakeTargetTimerId=null}),2e3),void this.plane.showFakeTargetRadius(i.T.fakeTargetRadius);this.plane.fakeTargets-=1;const t=new k.jA(this.plane);this.addEntity(t)}saveGame(t){return et.get().then((e=>{const s=Object.assign(new nt,{flies:this.flies,level:this.level,planeId:this.plane.id,boosterIsUsed:this.boosterIsUsed,globalTime:this.globalTime,lastT:this.lastT,rotationDirection:this.rotationDirection,statics:this.gameMap.partsStore.backend.snapshot(st)});return it.saveString(`/saves/${encodeURIComponent(e)}/${encodeURIComponent(t)}`,M.Z.serialize(s))}))}loadGame(t){return et.get().then((e=>{it.loadString(`/saves/${encodeURIComponent(e)}/${encodeURIComponent(t)}`).then((t=>{M.Z.unserializeWithLinks((()=>{const e=M.Z.unserialize(t);T.Z.clearAll(),this.recreateGameMap(200,1500,st),this.flies=[],this.fliesById=new Map,this.fliesToAddAfterTick=[],this.overlays=[],this.triggers=[],this.inbetween=!1,this.lastT=e.lastT,this.timeScale=1,this.boosterIsUsed=e.boosterIsUsed,this.globalTime=e.globalTime,this.rotationDirection=e.rotationDirection,this.fakeTargetTimerId=null,this.outOfRange=!1,this.fps=0,this.level=e.level,e.flies.forEach((t=>this.addEntity(t))),this.plane=this.fliesById.get(e.planeId),this.plane.subscribe((t=>this.onPlaneEvent(t))),this.level.init(this),this.gameMap.partsStore.backend.restoreFromSnapshot(st,e.statics),this.gameMap.deleteAllCustomContent(),this.paused=!0,S.Z.init(this),this.gameState="in progress"}),(()=>[this.fliesById,new Map([["game",this]])]))}))}))}getSavedGames(){return et.get().then((t=>it.loadKeys(`/saves/${encodeURIComponent(t)}`)))}recreateGameMap(t,e,s){this.gameMap=new U(this,t,e,s,new N(new O(it),new B))}}class nt{static __type="GameState";level;planeId;rotationDirection;globalTime;boosterIsUsed;lastT;flies;statics;__serialize(){return{level:M.Z.toPojo(this.level),planeId:this.planeId,rotationDirection:this.rotationDirection,globalTime:this.globalTime,boosterIsUsed:this.boosterIsUsed,lastT:this.lastT,flies:M.Z.toPojo(this.flies),statics:M.Z.toPojo(this.statics)}}__unserialize(t){this.level=M.Z.unserialize(t.level),this.planeId=t.planeId,this.rotationDirection=t.rotationDirection,this.globalTime=t.globalTime,this.boosterIsUsed=t.boosterIsUsed,this.lastT=t.lastT,this.flies=M.Z.unserialize(t.flies),this.statics=t.statics}}M.Z.registerConstructor(nt.__type,(t=>new nt)),setTimeout((function(){const t=document.getElementById("canvas"),e=t.getContext("2d");f(t);const s=document.createElement("canvas");s.getContext("2d"),window.onresize=()=>{t.width=window.innerWidth,t.height=window.innerHeight,t.style.position="fixed",t.style.left="0",t.style.top="0",s.width=t.width,s.height=t.height},window.onresize(new UIEvent("")),new rt(e).mainMenu()}),1)},134:(t,e,s)=>{s.d(e,{JO:()=>p,$7:()=>f,gF:()=>y,Vz:()=>v,qF:()=>b,jA:()=>w,Cp:()=>x,MB:()=>S,Hs:()=>T,Vk:()=>k,Ux:()=>C,OQ:()=>M,JA:()=>P,ZJ:()=>z,PE:()=>I});var i=s(917),r=s(751),n=s(464),a=s(925),o=s(32),l=s(485),h=s(165);class c{target;constructor(){this.target=null}}class d{static idPrefix=(0,o.h)();static idIndex=0;static __type="Entity";game=null;xy;dead;layer;id;attributes;infoItems;_subscribers;constructor(t){this.xy=n.Z.clone(t),this.dead=!1,this.layer=0,this.id=d.generateNewId(),this.infoItems=new Map,this._subscribers=[]}static generateNewId(){return d.idPrefix+"-"+d.idIndex++}setGame(t){this.game=t}getGame(){return this.game}emit(t){t.target=this,this._subscribers.forEach((e=>e(t)))}subscribe(t){this._subscribers.push(t)}__serialize(){return{xy:this.xy,dead:this.dead,id:this.id,layer:this.layer,attributes:this.attributes?[...this.attributes.entries()]:null}}__unserialize(t){this.xy=t.xy,this.dead=t.dead,this.id=t.id,this.layer=t.layer,this.attributes=t.attributes?new Map(t.attributes):void 0,l.Z.getLink("game",(t=>this.game=t))}getRegion(){return r.yp.EMPTY}getCollideRegion(){return this.getRegion()}progress(t){}draw(t){this.drawInfo(t)}addInfo(t,e,s,i){if("function"!=typeof e){let t=e.toString();e=()=>t}this.removeInfo(t);let r=void 0!==s&&s>0?a.Z.set((()=>this.removeInfo(t)),s):null;this.infoItems.set(t,{textSupplier:e,timerId:r,color:i})}removeInfo(t){let e=this.infoItems.get(t);void 0!==e&&(null!==e.timerId&&a.Z.clear(e.timerId),this.infoItems.delete(t))}getAttribute(t){return this.attributes?this.attributes.get(t):void 0}setAttribute(t,e){void 0===this.attributes&&(this.attributes=new Map),this.attributes.set(t,e)}deleteAttribute(t){void 0!==this.attributes&&this.attributes.delete(t)}drawInfo(t){if(0==this.infoItems.size)return;t.save();const e=h.T.infoFontSize,s=e+h.T.infoFontSize/2;let i=this.xy[0]+20,r=this.xy[1];t.font=`${e}px serif`,t.textBaseline="top",t.globalAlpha=h.T.infoAlpha;for(let e of this.infoItems.values()){let n=e.textSupplier();t.fillStyle=e.color||h.T.infoColor,t.fillText(n,i,r),r+=s}t.restore()}enhanceDrawWith(t){let e=this.draw;return this.draw=s=>{e.call(this,s),t.call(this,s)},()=>this.draw=e}collideWith(t){return r.yp.intersects(this.getCollideRegion(),t.getCollideRegion())}linearSize(){const t=this.getRegion().getBoundingBox();return Math.max(t[2]-t[0],t[3]-t[1])}}l.Z.registerConstructor(d.__type,(t=>new d(t.xy)));class u extends d{m;size;static __type="Fly";v;constructor(t,e,s,i){super(t),this.m=e,this.size=i,this.v=n.Z.clone(s)}__serialize(){let t=super.__serialize();return t.m=this.m,t.v=this.v,t.size=this.size,t}__unserialize(t){super.__unserialize(t),this.m=t.m,this.v=t.v,this.size=t.size}getRegion(){return new r.kb(this.xy,this.size)}progress(t){const e=n.Z.mulByScalar(this.v,t);this.xy=n.Z.add(this.xy,e)}applyForce(t,e){const s=n.Z.mulByScalar(t,e/this.m);this.v=n.Z.add(this.v,s)}applyRotation(t,e){this.v=n.Z.rotate(this.v,t*e)}}l.Z.registerConstructor(u.__type,(t=>new u(t.xy,t.m,t.v,t.size)));class g extends u{static __type="Trail";tail;lastXy=null;progressTrail;fadingAlpha;constructor(t,e,s,i){super(t,e,s,i),this.tail=[],this.lastXy=null,this.progressTrail=!0,this.fadingAlpha=null}__serialize(){return super.__serialize()}_stopTrailing(t){this.progressTrail=!1,(0,i.pf)([1],[0],t/10,t,i.Ms.linear(0),(t=>this.fadingAlpha=t[0]))}progress(t){super.progress(t),this.progressTrail&&(null===this.lastXy&&(this.lastXy=this.xy),n.Z.length(n.Z.subtract(this.xy,this.lastXy))>10&&(this.tail.push(this.xy),this.lastXy=this.xy,this.tail.length>20&&this.tail.splice(0,this.tail.length-20)))}draw(t){if(super.draw(t),null!==this.fadingAlpha&&(t.globalAlpha=this.fadingAlpha),0===this.tail.length)return;const e=(0,i.jt)(h.T.trailStartColor,h.T.trailEndColor,1,this.tail.length,i.Ms.linear(0));for(let s=1;s<this.tail.length;s++){const i=e(s);t.strokeStyle=(0,h.B)(i),t.beginPath(),t.moveTo(this.tail[s-1][0],this.tail[s-1][1]),t.lineTo(this.tail[s][0],this.tail[s][1]),t.stroke()}if(this.progressTrail){const s=e(this.tail.length);t.strokeStyle=(0,h.B)(s),t.beginPath(),t.moveTo(this.xy[0],this.xy[1]),t.lineTo(this.tail[this.tail.length-1][0],this.tail[this.tail.length-1][1]),t.stroke()}}}l.Z.registerConstructor(g.__type,(t=>new g(t.xy,t.m,t.v,t.size)));class p extends u{static __type="Plane";_lifes;_fakeTargets;_score;_booster;layer;omega;hangForce;boostForce;minVelocity;maxVelocity;void;fakeTargetRadius;constructor(t){super(t,1,[0,-.1],7),this._lifes=1,this._fakeTargets=2,this._score=0,this._booster=1e4,this.layer=100,this.omega=null,this.hangForce=null,this.boostForce=null,this.minVelocity=.01,this.maxVelocity=.1,this.void=!0,a.Z.set((()=>this.void=!1),h.T.planeBirthVoidPeriod)}set lifes(t){t<0&&(t=0);let e=t-this._lifes;this._lifes=t,this.emit(new f(e))}get lifes(){return this._lifes}set fakeTargets(t){t<0&&(t=0);let e=t-this._fakeTargets;this._fakeTargets=t,this.emit(new y(e))}get fakeTargets(){return this._fakeTargets}set score(t){t<0&&(t=0);let e=t-this._score;this._score=t,this.emit(new v(e))}get score(){return this._score}set booster(t){t<0&&(t=0);let e=t-this._booster;this._booster=t,this.emit(new b(e))}get booster(){return this._booster}getCollideRegion(){return this.void?r.yp.EMPTY:super.getCollideRegion()}__serialize(){let t=super.__serialize();return t.maxVelocity=this.maxVelocity,t.omega=this.omega,t.hangForce=this.hangForce,t.boostForce=this.boostForce,t.minVelocity=this.minVelocity,t.maxVelocity=this.maxVelocity,t.void=this.void,t.lifes=this.lifes,t.fakeTargets=this.fakeTargets,t.score=this.score,t.booster=this.booster,t}__unserialize(t){super.__unserialize(t),this.maxVelocity=t.maxVelocity,this.omega=t.omega||null,this.hangForce=t.hangForce||null,this.boostForce=t.boostForce||null,this.minVelocity=t.minVelocity,this.maxVelocity=t.maxVelocity,this.void=t.void,this.lifes=t.lifes,this.fakeTargets=t.fakeTargets,this.score=t.score,this.booster=t.booster}draw(t){super.draw(t);const e=n.Z.normalize(this.v),s=n.Z.subtract(this.xy,n.Z.mulByScalar(e,this.size/7*5)),i=n.Z.add(this.xy,n.Z.mulByScalar(e,this.size/7*10)),r=n.Z.subtract(this.xy,n.Z.mulByScalar(n.Z.normal(e),this.size)),a=n.Z.add(this.xy,n.Z.mulByScalar(n.Z.normal(e),this.size));if(t.lineWidth=3,this.void&&(t.globalAlpha=.2),t.strokeStyle=h.T.planeColor,t.beginPath(),t.moveTo(s[0],s[1]),t.lineTo(i[0],i[1]),t.moveTo(this.xy[0],this.xy[1]),t.lineTo(r[0],r[1]),t.moveTo(this.xy[0],this.xy[1]),t.lineTo(a[0],a[1]),t.stroke(),null!==this.boostForce){t.fillStyle=h.T.planeBoosterColor,t.globalAlpha=h.T.planeBoosterAlpha;for(let s=0;s<3;s++){t.beginPath();const i=n.Z.add(n.Z.subtract(this.xy,n.Z.mulByScalar(e,5+this.size/7*5*s/2)),n.Z.random(1));t.arc(i[0],i[1],2/(1+s/2),0,2*Math.PI),t.fill()}}this.fakeTargetRadius&&(t.globalAlpha=.2,t.fillStyle=h.T.planeFakeTargetRadiusColor,t.beginPath(),t.arc(this.xy[0],this.xy[1],this.fakeTargetRadius,0,2*Math.PI),t.fill())}progress(t){if(null!==this.omega&&this.applyRotation(this.omega,t),null!==this.hangForce){const e=n.Z.mulByScalar(n.Z.normalize(this.v),-this.hangForce);this.applyForce(e,t)}if(null!==this.boostForce){const e=n.Z.mulByScalar(n.Z.normalize(this.v),this.boostForce);this.applyForce(e,t)}const e=n.Z.length(this.v);e<this.minVelocity&&(this.v=n.Z.mulByScalar(n.Z.normalize(this.v),this.minVelocity)),e>this.maxVelocity&&(this.v=n.Z.mulByScalar(n.Z.normalize(this.v),this.maxVelocity)),super.progress(t)}left(){this.omega=-.004}right(){this.omega=.004}noRotate(){this.omega=null}startHang(){this.hangForce=1e-4}stopHang(){this.hangForce=null}startBoost(){this.boostForce=1e-4}stopBoost(){this.boostForce=null}showFakeTargetRadius(t){this.fakeTargetRadius=t}hideFakeTargetRadius(){this.fakeTargetRadius=null}}l.Z.registerConstructor(p.__type,(t=>new p(t.xy)));class m extends c{amount;constructor(t){super(),this.amount=t}}class f extends m{}class y extends m{}class v extends m{}class b extends m{}class w extends u{static __type="FakeTarget";omega;color;constructor(t){const e=n.Z.negate(n.Z.normalize(t.v)),s=2*Math.random()*Math.PI/10,r=s-2*s,a=n.Z.rotate(n.Z.mulByScalar(e,.1+50*Math.random()/1e3),r);super(n.Z.add(t.xy,n.Z.mulByScalar(e,2*t.size)),.1,a,3),this.layer=100,this.omega=.002-2*Math.random()*.002,this.color=h.T.fakeTargetStartColor,(0,i.pf)(h.T.fakeTargetStartColor,h.T.fakeTargetEndColor,100,5e3,i.Ms.ease(),(t=>this.color=t)),(0,i.pf)([n.Z.length(a)],[0],100,5e3,i.Ms.ease(),(t=>this.v=n.Z.mulByScalar(n.Z.normalize(this.v),t[0])),(()=>this.dead=!0))}__serialize(){let t=super.__serialize();return t.omega=this.omega,t.color=this.color,t}__unserialize(t){this.omega=t.omega,this.color=t.color}progress(t){super.progress(t),this.applyRotation(this.omega,t)}draw(t){super.draw(t),t.strokeStyle=(0,h.B)(this.color),t.beginPath();for(let e=0;e<3;e++){const e=n.Z.random(this.size);t.moveTo(this.xy[0],this.xy[1]),t.lineTo(this.xy[0]+e[0],this.xy[1]+e[1]),t.moveTo(this.xy[0],this.xy[1]),t.lineTo(this.xy[0]-e[0],this.xy[1]-e[1])}t.stroke()}}l.Z.registerConstructor(w.__type,(()=>new w({xy:[0,0],v:[0,0],size:1})));class x extends g{static __type="Missile";maxSpeed;minSpeed;oldTargets=[];target;maxOmega;lifeTime;dieAnimation;constructor(t,e){const s=.13;super(t,.1,[0,s+Math.random()*(.15-s)],3),this.layer=100,this.maxSpeed=.15,this.minSpeed=s,this.target=e,this.maxOmega=.002,this.lifeTime=1e4+3e4*Math.random()}__serialize(){return Object.assign(super.__serialize(),{maxSpeed:this.maxSpeed,minSpeed:this.minSpeed,maxOmega:this.maxOmega,lifeTime:this.lifeTime,target:this.target?this.target.id:null,oldTargets:this.oldTargets.map((t=>t.id))})}__unserialize(t){super.__unserialize(t),this.maxSpeed=t.maxSpeed,this.minSpeed=t.minSpeed,this.maxOmega=t.maxOmega,this.lifeTime=t.lifeTime,null!==t.target?l.Z.getLink(t.target,(t=>this.target=t)):this.target=new d([1/0,1/0]),t.oldTargets?(this.oldTargets=t.oldTargets.map((()=>null)),t.oldTargets.forEach(((t,e)=>l.Z.getLink(t,(t=>this.oldTargets[e]=t))))):this.oldTargets=[]}isDying(){return this.dead||this.dieAnimation}getCollideRegion(){return this.dieAnimation?r.yp.EMPTY:super.getCollideRegion()}progress(t){if(this.lifeTime-=t,this.lifeTime<=0&&(this.dead=!0),!this.dieAnimation&&this.lifeTime<2e3&&(this._stopTrailing(1500),this.dieAnimation=(0,i.pf)(h.T.missileDieStartColor,h.T.missileDieEndColor,100,2e3,i.Ms.linear(0))),void 0!==this.target&&(this.target.dead&&(this.target=this.oldTargets.pop()),void 0!==this.target)){const e=n.Z.subtract(this.target.xy,this.xy),s=n.Z.alignUp(e,this.v);this.applyRotation(this.maxOmega*(s[0]>0?1:-1),t)}super.progress(t)}retarget(t){if(this.target===t)return;let e,s=this;if(void 0!==this.target){let r=this.target.enhanceDrawWith((i=>{void 0!==s.target&&(i.fillStyle="#ff9999",i.globalAlpha=.3,i.strokeStyle="#ff9999",i.beginPath(),i.moveTo(s.xy[0],s.xy[1]),i.lineTo(s.target.xy[0],s.target.xy[1]),i.stroke(),i.beginPath(),i.arc(t.xy[0],t.xy[1],e()[0],0,2*Math.PI),i.fill())}));e=(0,i.pf)([50],[0],100,1e3,i.Ms.ease(),void 0,r),this.oldTargets.push(this.target)}this.target=t}draw(t){super.draw(t);const e=n.Z.normalize(this.v),s=n.Z.add(this.xy,n.Z.mulByScalar(e,5*this.size/3)),i=n.Z.subtract(this.xy,n.Z.mulByScalar(n.Z.normal(e),2*this.size/3)),r=n.Z.add(this.xy,n.Z.mulByScalar(n.Z.normal(e),2*this.size/3));let a="black";if(this.dieAnimation&&(a=(0,h.B)(this.dieAnimation())),t.strokeStyle=a,t.beginPath(),t.moveTo(i[0],i[1]),t.lineTo(s[0],s[1]),t.moveTo(r[0],r[1]),t.lineTo(s[0],s[1]),t.stroke(),!this.dieAnimation){const s=1/(this.maxSpeed-this.minSpeed),i=-this.minSpeed*s,r=n.Z.length(this.v)*s+i;t.fillStyle=(0,h.B)(255*(1-r),0,255*r),t.globalAlpha=.5;for(let s=0;s<3;s++){t.beginPath();const i=n.Z.add(n.Z.subtract(this.xy,n.Z.mulByScalar(e,5*this.size/3*s/2)),n.Z.random(1));t.arc(i[0],i[1],2/(1+s/2),0,2*Math.PI),t.fill()}}}}l.Z.registerConstructor(x.__type,(t=>new x(t.xy,void 0)));class _ extends c{target;constructor(t){super(),this.target=t}}class S extends d{constructor(t){super(t)}saveChanges(){const t=this.getGame();null!==t&&t.gameMap.entityChanged(this)}}class T extends S{static __type="Perk";size;constructor(t){super(t),this.layer=100,this.size=5}__serialize(){let t=super.__serialize();return t.size=this.size,t}__unserialize(t){super.__unserialize(t),this.size=t.size}getRegion(){return new r.kb(this.xy,this.size)}collected(t){this.dead=!0,this.emit(new _(this))}}l.Z.registerConstructor(T.__type,(t=>new T(t.xy)));class k extends T{static __type="Life";constructor(t){super(t)}draw(t){super.draw(t),t.strokeStyle=h.T.lifeColor,t.fillStyle=h.T.lifeColor,t.beginPath(),t.arc(this.xy[0],this.xy[1],this.size,0,2*Math.PI),t.stroke(),t.beginPath(),t.arc(this.xy[0],this.xy[1],this.size,0,2*Math.PI),t.fill()}collected(t){super.collected(t),t.lifes+=1}}l.Z.registerConstructor(k.__type,(t=>new k(t.xy)));class C extends T{static __type="Star";constructor(t){super(t)}draw(t){super.draw(t),t.strokeStyle=h.T.scoreColor,t.fillStyle=h.T.scoreColor,t.beginPath(),t.arc(this.xy[0],this.xy[1],this.size,0,2*Math.PI),t.stroke(),t.beginPath(),t.arc(this.xy[0],this.xy[1],this.size,0,2*Math.PI),t.fill()}collected(t){super.collected(t),t.score+=1}}l.Z.registerConstructor(C.__type,(t=>new C(t.xy)));class M extends u{static __type="Explosion";deadCount;circles;color;particles;constructor(t,e){super(t,1,[0,0],1),this.layer=100,this.deadCount=e,this.circles=[];let s=0;for(let r=0;r<e;r++){const e=10*this.size-2*Math.random()*10*this.size,r=10*this.size-2*Math.random()*10*this.size,o=[n.Z.add(t,[e,r]),0];a.Z.set((()=>{(0,i.pf)([0],[20*this.size],10,1e3,i.Ms.ease(),(t=>{o[1]=t[0],this.deadCount--}),(()=>this.dead=this.deadCount<=0))}),s+=100*Math.random()),this.circles.push(o)}this.color=(0,i.pf)(h.T.explosionStartColor,h.T.explosionEndColor,100,s+1e3,i.Ms.linear(0)),this.particles=[];for(let s=0;s<10*e;s++){const e=n.Z.random(.13+2*Math.random()*.13/3);this.particles.push([t,e])}}__serialize(){let t=super.__serialize();return t.deadCount=this.deadCount,t}__unserialize(t){super.__unserialize(t)}progress(t){this.particles.forEach((e=>e[0]=n.Z.add(e[0],n.Z.mulByScalar(e[1],t))))}getRegion(){return r.yp.EMPTY}draw(t){super.draw(t),t.globalAlpha=h.T.explosionAlpha,t.fillStyle=(0,h.B)(this.color()),this.circles.forEach((e=>{t.beginPath(),t.arc(e[0][0],e[0][1],e[1],0,2*Math.PI),t.fill()})),this.particles.forEach((e=>{t.beginPath(),t.arc(e[0][0],e[0][1],2,0,2*Math.PI),t.fill()}))}}l.Z.registerConstructor(M.__type,(t=>new M(t.xy,t.deadCount)));class P extends S{static __type="Obstacle";region;constructor(t){super(t.getCenter()),this.layer=100,this.region=t}getRegion(){return this.region}draw(t){super.draw(t),this.region.draw(t,h.T.obstacleFillColor,h.T.obstacleStrokeColor)}__serialize(){const t=super.__serialize();return t.region=l.Z.toPojo(this.region),t}__unserialize(t){super.__unserialize(t)}}l.Z.registerConstructor(P.__type,(t=>new P(l.Z.unserialize(t.region))));class z extends S{static __type="Cloud";size;color;circles;alpha=1;constructor(t,e=null){if(super(t),this.layer=200,this.size=50,this.color=h.T.cloudColor,this.circles=[],null!==e){const s=4+Math.round(6*e.nextFloat());for(let i=0;i<s;i++){const s=n.Z.add(t,n.Z.random(e.nextFloat()*this.size,(()=>e.nextFloat())));this.circles.push([s[0],s[1],e.nextFloat()*this.size])}this.alpha=.1+.4*e.nextFloat()}}getCollideRegion(){return r.yp.EMPTY}getRegion(){return r.yp.EMPTY}draw(t){super.draw(t),t.fillStyle=this.color,t.globalAlpha=this.alpha,this.circles.forEach((e=>{t.beginPath(),t.arc(e[0],e[1],e[2],0,2*Math.PI),t.fill()}))}__serialize(){const t=super.__serialize();return t.xy=this.xy,t.color=this.color,t.alpha=this.alpha,t.circles=this.circles,t.size=this.size,t}__unserialize(t){super.__unserialize(t),this.alpha=t.alpha,this.color=t.color,this.circles=t.circles,this.size=t.size}}l.Z.registerConstructor(z.__type,(t=>new z(t.xy,null)));class I extends d{message;color;fontSize;constructor(t,e,s,r){super(t),this.message=e,this.color=s,this.layer=300,this.fontSize=(0,i.pf)([10],[20],100,r||1e3,i.Ms.ease(),void 0,(()=>this.dead=!0))}getRegion(){return r.yp.EMPTY}draw(t){super.draw(t),t.globalAlpha=.5,t.fillStyle=this.color,t.font=this.fontSize()[0]+"px serif",t.fillText(this.message,this.xy[0],this.xy[1])}}},509:(t,e,s)=>{var i=s(381),r=s(811),n=s(607);class a{toState;condition;run;constructor(t,e,s){this.toState=t,this.condition=e,this.run=s}transit(t,e){return!this.condition||this.condition(t,e)?(this.run&&this.run(t,e),this.toState):null}}class o{name;transitions;constructor(t,e){this.name=t,this.transitions=e}}class l{startState;sampleFilter;debug=!1;constructor(t,e){this.startState=t,this.sampleFilter=e}process(t,e,s){s=s||0,e.stateReached=null;let i=new n.H(t,s);for(e._state=this.startState,this.debug&&console.groupCollapsed("FSA"),this.debug&&console.log("[start]",e._state.name);!i.atEnd();){let t=i.next();if(this.sampleFilter&&!this.sampleFilter(t,e)){this.debug&&console.log("[skip sample]",t);continue}this.debug&&console.log("[sample]",t);let s=null;for(let i of e._state.transitions)if(s=i.transit(t,e),null!==s){e.stateReached=s.name,this.debug&&console.log("[transition]",e._state.name," => ",s.name,"[context]",Object.assign({},e));break}if(null===s){this.debug&&console.log("[end]",e._state,"[context]",Object.assign({},e));break}e._state=s}return this.debug&&console.log("[buffer consumed]",i.atEnd()?"'till end":"'till "+i.idx),this.debug&&console.groupEnd(),i.atEnd()?-1:i.idx}step(t,e){if(void 0===e._state&&(e._state=this.startState),this.sampleFilter&&!this.sampleFilter(t,e))return this.debug&&console.log("[skip sample]",t),!0;this.debug&&console.log("[sample]",t);let s=null;for(let i of e._state.transitions)if(s=i.transit(t,e),null!==s)return e.stateReached=s.name,this.debug&&console.log("[transition]",e._state.name," => ",s.name,"[context]",Object.assign({},e)),e._state=s,!0;return this.debug&&console.log("[end]",e._state,"[context]",Object.assign({},e)),delete e._state,!1}}class h{name;builders;_sampleFilter;transitions=[];constructor(t="<ROOT>",e){this.name=t,this.builders=e?e.builders:new Map,this._sampleFilter=e?e._sampleFilter:null}sampleFilter(t){if(null!==this._sampleFilter)throw new Error("sampleFilter already set");return this._sampleFilter=t,this}transition(t,e,s){return this.state(t),this.transitions.push({toStateName:t,condition:e,run:s}),this}state(t){let e=this.builders.get(t);return void 0===e&&(e=new h(t,this),this.builders.set(t,e)),e}build(t){let e=new Map;for(let t of this.builders.values())e.has(t.name)||e.set(t.name,new o(t.name,[]));for(let t of this.builders.values()){let s=e.get(t.name);if(void 0===s)throw new Error("Can't find state: "+t.name);for(let i of t.transitions){let t=e.get(i.toStateName);if(void 0===t)throw new Error("Can't find state: "+i.toStateName);s.transitions.push(new a(t,i.condition,i.run))}}let s=e.get(t);if(void 0===s)throw new Error("Can't find state: "+t);return new l(s,this._sampleFilter)}}var c=s(658),d=s(165);i.Z.register("deadly-chasing",[r.g,c.N],((t,e)=>{const s=(t,e)=>t.sameDir&&t.dist<100&&t.behind,i=3*d.T.telemetrySamplesPerSecond;let r=(new h).sampleFilter(((t,e)=>t.t>e.lastFsaTriggerTime)).state("start").transition("start",((t,e)=>!s(t))).transition("chasing",s,((t,e)=>e.chasingCount=1)).state("chasing").transition("chasing",s,((t,e)=>e.chasingCount++)).transition("death",((t,e)=>t.missileIsDead),((t,e)=>e.deathTime=t.t)).transition("inbetween",((t,e)=>e.chasingCount>=i),((t,e)=>e.inbetweenCount=1)).state("inbetween").transition("death",((t,e)=>e.inbetweenCount<=.5*e.chasingCount&&t.missileIsDead),((t,e)=>e.deathTime=t.t)).transition("inbetween",((t,e)=>e.inbetweenCount<=.5*e.chasingCount&&!t.missileIsDead),((t,e)=>e.inbetweenCount++)).transition("failed").build("start"),n=new class{lastFsaTriggerTime;stateReached;chasingCount;deathTime;inbetweenCount;constructor(){this.reset(),this.lastFsaTriggerTime=0}reset(){this.stateReached=null,this.chasingCount=0,this.deathTime=void 0}};e.addStep((e=>{r.step(e,n)?("failed"==n.stateReached&&n.reset(),n.chasingCount>i?t.addInfo("chasingCount",(()=>d.t`Chase it to death!`),500):t.removeInfo("chasingCount"),void 0!==n.deathTime&&(t.addInfo("deadly chaser",d.t`Deadly chaser!`,3e3),t.plane.score+=10,n.lastFsaTriggerTime=n.deathTime,n.reset())):n.reset()}))}))},545:(t,e,s)=>{var i=s(381),r=s(811),n=s(658);i.Z.register(r.g,[n.N],((t,e)=>{let s=new r.g(e.capacity);return t.addTrigger((t=>s.step(e))),s}))},386:(t,e,s)=>{var i=s(381),r=s(925),n=s(134),a=s(464),o=s(165);i.Z.register("retarget-missiles",[],(t=>{r.Z.periodic((function(){let s=t.flies.filter((t=>t instanceof n.JO||t instanceof n.jA));s.length>1&&t.flies.filter((t=>t instanceof n.Cp)).forEach((t=>{let i=t.target?a.Z.dist(t.xy,t.target.xy):1/0,r=s.filter((e=>e!==t.target)).filter((e=>!(e instanceof n.JO)||a.Z.dotProduct(a.Z.subtract(e.xy,t.xy),t.v)>=0)).map((e=>(e.distToM=a.Z.dist(t.xy,e.xy),e)));r.length>0&&(r.sort(((t,e)=>t.distToM<e.distToM?-1:t.distToM>e.distToM?1:0)),r[0].distToM<e&&r[0].distToM<i&&t.retarget(r[0]))}))}),300);const e=o.T.fakeTargetRadius}))},976:(t,e,s)=>{var i=s(381),r=s(658),n=s(165);i.Z.register(r.N,[],(t=>{let e=n.T.telemetryWindowSeconds*n.T.telemetrySamplesPerSecond,s=new r.N(1e3/n.T.telemetrySamplesPerSecond,t,e);return t.addTrigger(s.toTrigger()),s}))},381:(t,e,s)=>{s.d(e,{Z:()=>o});const i={};class r{pluginId;dependencies;plugin;pluginValue;constructor(t,e,s){this.pluginId=t,this.dependencies=e,this.plugin=s,this.pluginValue=i}}const n=new Map;let a=!1;const o={register:function(t,e,s){if(n.has(t))throw new Error("Plugin with the id already exists: "+t);n.set(t,new r(t,e,s))},init:function(t){if(a)throw new Error("Calling plugin.init() inside plugin.init()");for(let e of function(){let t,e=[],s=[];n.forEach((t=>s.push(t)));do{t=[];for(let i of s)i.dependencies.filter((t=>-1==e.findIndex((e=>e.pluginId==t)))).length>0||(e.push(i),t.push(i));t.forEach((t=>s.splice(s.indexOf(t),1)))}while(t.length>0);return s.forEach((t=>e.push(t))),e}()){a=!0;try{let s=e.dependencies.filter((t=>n.has(t))).map((t=>n.get(t))).filter((t=>t.pluginValue!==i)).map((t=>t.pluginValue));if(s.length!=e.dependencies.length){let t=e.dependencies.filter((t=>!n.has(t)||n.get(t).pluginValue===i)).map((t=>"function"==typeof t?t.name:t)).map((t=>`'${t}'`)).join(", ");console.log("[PLUGINS]","Missed dependencies",t,"for plugin","'"+("function"==typeof e.pluginId?e.pluginId.name:e.pluginId)+"'.","Not loaded");continue}e.pluginValue=e.plugin(t,...s)}finally{a=!1}}},get:function(t){if(!n.has(t))return;let e=n.get(t).pluginValue;if(e===i)throw new Error("Plugin is not yet initialized: "+t);return e}}},751:(t,e,s)=>{s.d(e,{yp:()=>n,kb:()=>a,OI:()=>l});var i=s(464),r=s(485);class n{static __type="Region";static EMPTY=new n;void=!1;poly=null;boundingBox=null;static intersects(t,e){if(t===n.EMPTY||e==n.EMPTY)return!1;if(t.void||e.void)return!1;if(t instanceof a&&e instanceof a)return i.Z.length(i.Z.subtract(t.xy,e.xy))<t.r+e.r;const s=t.getBoundingBox(),r=e.getBoundingBox();if(s[0]>r[2]||r[0]>r[2])return!1;if(s[1]>r[3]||r[1]>r[3])return!1;const o=t.toPolygonRegion(),l=e.toPolygonRegion();for(const t of o.vertices)if(l.containsPoint(t))return!0;for(const t of l.vertices)if(o.containsPoint(t))return!0;return!1}toPolygonRegion(){return null===this.poly&&(this.poly=this.__toPolygonRegion()),this.poly}getBoundingBox(){if(null===this.boundingBox){const t=this.toPolygonRegion();if(0==t.vertices.length)return[0,0,0,0];let e=1e20,s=-1e20,i=1e20,r=-1e20;for(let n of t.vertices)n[0]<e&&(e=n[0]),n[0]>s&&(s=n[0]),n[1]<i&&(i=n[1]),n[1]>r&&(r=n[1]);this.boundingBox=[e,i,s,r]}return this.boundingBox}getCenter(){const t=this.getBoundingBox();return[(t[0]+t[2])/2,(t[1]+t[3])/2]}__toPolygonRegion(){return l.EMPTY}draw(t,e,s){t.fillStyle=e,t.strokeStyle=this.void?e:s;const i=this.toPolygonRegion();if(0!=i.vertices.length){t.beginPath(),t.moveTo(i.vertices[0][0],i.vertices[0][1]);for(let e=1;e<=i.vertices.length;e++){const s=e%i.vertices.length;t.lineTo(i.vertices[s][0],i.vertices[s][1])}t.fill(),t.beginPath(),t.moveTo(i.vertices[0][0],i.vertices[0][1]);for(let e=1;e<=i.vertices.length;e++){const s=e%i.vertices.length;t.lineTo(i.vertices[s][0],i.vertices[s][1])}t.stroke()}}__serialize(){return{void:this.void}}__unserialize(t){this.void=t.void}resetCache(){this.boundingBox=null,this.poly=null}moveTo(t){this.resetCache()}scale(t){this.resetCache()}rotate(t){this.resetCache()}}r.Z.registerConstructor(n.__type,(t=>new n));class a extends n{static __type="CircleRegion";xy;r;constructor(t,e){super(),this.xy=t,this.r=e}__toPolygonRegion(){const t=[],e=Math.max(5,Math.min(30,Math.round(2*Math.PI*this.r/5)));for(let s=0;s<e;s++){const i=this.xy[0]+this.r*Math.cos(2*Math.PI/e*s),r=this.xy[1]+this.r*Math.sin(2*Math.PI/e*s);t.push([i,r])}return new l(t)}scale(t){this.r*=t,super.scale(t)}moveTo(t){this.xy=t,super.moveTo(t)}rotate(t){}__serialize(){const t=super.__serialize();return t.xy=this.xy,t.r=this.r,t}__unserialize(t){super.__unserialize(t)}}r.Z.registerConstructor(a.__type,(t=>new a(t.xy,t.r)));class o{v0;v;static __type="Semispace";direction;constructor(t,e,s){this.v0=t,this.v=e,this.direction=this._direction(s)}containsPoint(t){return this.direction*this._direction(t)>=0}_direction(t){if(Math.abs(this.v[0])<1e-6)return Math.sign(t[0]-this.v0[0]);const e=this.v0[1]+(t[0]-this.v0[0])/this.v[0]*this.v[1];return Math.sign(t[1]-e)}__serialize(){return{v0:this.v0,v:this.v,direction:this.direction}}__unserialize(t){this.direction=t.direction}}r.Z.registerConstructor(o.__type,(t=>new o(t.v0,t.v,[0,0])));class l extends n{static __type="ConvexPolygonRegion";static EMPTY=new l([]);vertices;semispaces;constructor(t){super(),this.vertices=t,this.calculateSemispaces()}calculateSemispaces(){const t=this.vertices;this.semispaces=[];for(let e=0;e<t.length;e++){const s=t[e],r=i.Z.subtract(t[(e+1)%t.length],t[e]),n=t[(e+2)%t.length];this.semispaces.push(new o(s,r,n))}}scale(t){const e=this.getCenter();this.vertices=this.vertices.map((s=>i.Z.add(i.Z.mulByScalar(i.Z.subtract(s,e),t),e))),this.calculateSemispaces(),super.scale(t)}moveTo(t){const e=i.Z.subtract(t,this.getCenter());this.vertices=this.vertices.map((t=>i.Z.add(t,e))),this.calculateSemispaces(),super.moveTo(t)}rotate(t){const e=this.getCenter(),s=t/360*Math.PI;this.vertices=this.vertices.map((t=>i.Z.add(i.Z.rotate(i.Z.subtract(t,e),s),e))),this.calculateSemispaces(),super.rotate(t)}containsPoint(t){for(let e of this.semispaces)if(!e.containsPoint(t))return!1;return!0}__toPolygonRegion(){return this}__serialize(){const t=super.__serialize();return t.vertices=this.vertices,t}__unserialize(t){super.__unserialize(t)}}r.Z.registerConstructor(l.__type,(t=>new l(t.vertices)))},607:(t,e,s)=>{s.d(e,{d:()=>i,H:()=>r});class i{buffer;startIdx=0;endIdx=0;size=0;constructor(t){this.buffer=new Array(t)}get(t){if(t>=this.size)throw new Error("Index out of bound: "+t);return this.buffer[(this.startIdx+t)%this.buffer.length]}set(t,e){this.buffer[(this.startIdx+t)%this.buffer.length]=e}push(...t){for(let e of t){const t=this.buffer.length;this.size<t?(this.buffer[this.endIdx++]=e,this.size++):(this.buffer[this.startIdx]=e,this.startIdx=(this.startIdx+1)%t)}}forEach(t){for(let e=0;e<this.size;e++)t(this.get(e),e)}toArray(){const t=new Array(this.size);return this.forEach(((e,s)=>t[s]=e)),t}}class r{buffer;idx;constructor(t,e=0){this.buffer=t,this.idx=e}atEnd(){return this.idx==this.buffer.size}next(){if(this.atEnd())throw new Error("Consumption after the end");return this.buffer.get(this.idx++)}}},350:(t,e,s)=>{s.d(e,{K:()=>h});const i=256,r=Math.pow(i,6),n=Math.pow(2,52),a=2*n,o=255;class l{i=0;j=0;S=[];constructor(t){let e,s=t.length,r=0,n=0;for(s||(t=[s++]);r<i;)this.S[r]=r++;for(r=0;r<i;r++)e=this.S[r],n=o&n+t[r%s]+e,this.S[r]=this.S[n],this.S[n]=e;this.g(i)}g(t){let e,s=0,r=this.i,n=this.j,a=this.S;for(;t--;)r=o&r+1,n=o&n+a[r],e=a[r],a[r]=a[n],a[n]=e,s=s*i+a[o&a[r]+a[n]];return this.i=r,this.j=n,s}}class h{pool=[];arc4;constructor(t){const e=[];this.mixkey(this.flatten(null==t?this.autoseed():t,3),e),this.arc4=new l(e),this.mixkey(this.tostring(this.arc4.S),this.pool)}nextFloat(){let t=this.arc4.g(6),e=r,s=0;for(;t<n;)t=(t+s)*i,e*=i,s=this.arc4.g(1);for(;t>=a;)t/=2,e/=2,s>>>=1;return(t+s)/e}flatten(t,e){const s=[];if(e&&"object"==typeof t)for(const i in t)try{s.push(this.flatten(t[i],e-1))}catch(t){}return s.length?s:"string"==typeof t?t:t+"\0"}mixkey(t,e){let s=t+"",i=0,r=0;for(;r<s.length;)e[o&r]=o&(i^=19*e[o&r])+s.charCodeAt(r++);return this.tostring(e)}autoseed(t){return window.crypto.getRandomValues(t=new Uint8Array(i)),this.tostring(t)}tostring(t){return String.fromCharCode.apply(0,t)}}},550:(t,e,s)=>{s.d(e,{Xf:()=>l,z2:()=>d,Ox:()=>u,As:()=>g,Cs:()=>p});var i=s(134),r=s(751),n=s(917),a=s(485),o=s(464);class l extends i.MB{node;static __type="Script";region;constructor(t,e){super(t),this.node=e,this.region=new r.kb(t,3)}getRegion(){return this.region}getCollideRegion(){return r.yp.EMPTY}progress(t){if(this.dead)return;super.progress(t);const e=this.getGame();null!==e&&(this.node.progress(t,e)||(this.dead=!0,e.gameMap.removeEntity(this)))}__serialize(){const t=super.__serialize();return t.node=a.Z.toPojo(this.node),t}__unserialize(t){super.__unserialize(t)}}a.Z.registerConstructor(l.__type,(t=>new l(t.xy,a.Z.unserialize(t.node))));class h{game;progress(t,e){return void 0===this.game&&(this.game=e,this.init()),this.doProgress(t)}}class c extends h{animation;init(){if(!this.game)return;if(this.animation)return void(this.animation.onAnimationProgress=t=>this.onAnimationProgress(t));const t=this.buildSettings(),e=t.speed>0?Math.round(o.Z.dist(t.startPos,t.endPos)/t.speed*1e3):1;this.animation=new n.fw(t.startPos,t.endPos,10,e,t.timingFunctionName),this.animation.onAnimationProgress=t=>this.onAnimationProgress(t)}reset(){this.game=void 0,this.animation=void 0}doProgress(t){return!!this.animation&&this.animation.progress(t)}moveEntityTo(t,e){this.game&&t instanceof i.JA&&this.game.gameMap.changeEntityGeometry(t,(t=>{t.xy=e,t.region.moveTo(e)}))}__serialize(){return{animation:a.Z.toPojo(this.animation)}}__unserialize(t){this.animation=a.Z.unserialize(t.animation)}}class d extends c{entityId;endPosOrId;speed;timingFunctionName;startPos;static __type="MoveEntityNode";entity;constructor(t,e,s,i,r){super(),this.entityId=t,this.endPosOrId=e,this.speed=s,this.timingFunctionName=i,this.startPos=r}buildSettings(){const t=this.game,e=t.gameMap.findById(this.entityId);if(!e)throw new Error("Can't find: "+this.entityId);let s;if(this.entity=e,"string"==typeof this.endPosOrId){const e=t.gameMap.findById(this.endPosOrId);if(!e)throw new Error("Can't find: "+this.endPosOrId);this.endPosOrId=e.xy,s=e.xy}else s=this.endPosOrId;return this.startPos||(this.startPos=this.entity.xy),{endPos:s,startPos:this.startPos,speed:this.speed,timingFunctionName:this.timingFunctionName}}onAnimationProgress(t){this.moveEntityTo(this.entity,t)}__serialize(){return Object.assign(super.__serialize(),{entityId:this.entityId,endPosOrId:this.endPosOrId,speed:this.speed,timingFunctionName:this.timingFunctionName,startPos:this.startPos})}__unserialize(t){}}a.Z.registerConstructor(d.__type,(t=>new d(t.entityId,t.endPosOrId,t.speed,t.timingFunctionName,t.startPos)));class u extends c{entityId;offset;speed;timingFunctionName;static __type="OffsetEntityNode";entity;constructor(t,e,s,i){super(),this.entityId=t,this.offset=e,this.speed=s,this.timingFunctionName=i}buildSettings(){const t=this.game.gameMap.findById(this.entityId);if(!t)throw new Error("Can't find: "+this.entityId);this.entity=t;const e=o.Z.add(t.xy,this.offset);return{startPos:t.xy,endPos:e,speed:this.speed,timingFunctionName:this.timingFunctionName}}onAnimationProgress(t){this.moveEntityTo(this.entity,t)}__serialize(){return Object.assign(super.__serialize(),{entityId:this.entityId,offset:this.offset,speed:this.speed,timingFunctionName:this.timingFunctionName})}}a.Z.registerConstructor(u.__type,(t=>new u(t.entityId,t.offset,t.speed,t.timingFunctionName)));class g extends h{nodes;loop;currentIdx;static __type="ChainNode";constructor(t,e=!1,s=0){super(),this.nodes=t,this.loop=e,this.currentIdx=s}__serialize(){return{nodes:a.Z.toPojo(this.nodes),currentIdx:this.currentIdx,loop:this.loop}}__unserialize(t){}progress(t,e){if(this.currentIdx>=this.nodes.length)return!1;let s=this.nodes[this.currentIdx].progress(t,e);return s||this.currentIdx++,s=this.currentIdx<this.nodes.length,this.loop&&!s?(this.reset(),!0):s}doProgress(t){return!0}init(){}reset(){this.currentIdx=0,this.nodes.forEach((t=>t.reset()))}}a.Z.registerConstructor(g.__type,(t=>new g(t.nodes.map((t=>a.Z.unserialize(t))),t.loop,t.currentIdx)));class p extends h{thenNode;interval;timePassed;static __type="TimerNode";constructor(t,e,s=0){super(),this.thenNode=t,this.interval=e,this.timePassed=s}__serialize(){return{thenNode:a.Z.toPojo(this.thenNode),interval:this.interval,timePassed:this.timePassed}}__unserialize(t){}progress(t,e){return this.timePassed+=t,this.timePassed<=this.interval||this.thenNode.progress(t,e)}doProgress(t){return!0}init(){}reset(){this.timePassed=0,this.thenNode.reset()}}a.Z.registerConstructor(p.__type,(t=>new p(a.Z.unserialize(t.condition),t.inerval,t.timePassed)))},485:(t,e,s)=>{s.d(e,{Z:()=>c});const i=new Map;function r(t){if(null===t)return null;if(void 0===t)return;if(t instanceof Array)return t.map((t=>r(t)));switch(typeof t){case"boolean":case"number":case"string":return t}const e=Object.getPrototypeOf(t);if("function"==typeof t.__serialize&&e.constructor.__type)return{type:e.constructor.__type,data:t.__serialize()};{const e={};for(const s in t)e[s]=r(t[s]);return e}}let n=0;function a(t){if(null===t)return null;if(void 0!==t){switch(typeof t){case"boolean":case"number":case"string":return t}if(t instanceof Array)return t.map((t=>a(t)));if(t.type){let e=i.get(t.type);if(void 0===e)throw new Error("No constructor registered for type: "+t.type);let s=e(t.data);return s.__unserialize(t.data),s}{const e={};for(const s in t){const i=t[s];e[s]=void 0===i?void 0:a(i)}return e}}}let o=[],l=0;function h(t,e){for(let s of e){let e=s.get(t);if(void 0!==e)return e}}const c={toPojo:r,serialize:function(t){return JSON.stringify(r(t))},registerConstructor:function(t,e){if(i.has(t))throw new Error("The constructor already exist: "+t);i.set(t,e)},unserialize:function(t){try{return n++,a("string"==typeof t?JSON.parse(t):t)}finally{n--}},unserializeExisting:function(t,e){if(!e.type)throw new Error("Can't unserialize "+e);t.__unserialize(e.data)},getLink:function(t,e,s=(()=>{})){if(0==l)throw new Error("getLink can only be called inside unserializeWithLinks");if(s=s||(()=>{}),0==n)throw new Error("getLink can only be called inside __unserialize method");o.push({id:t,consumer:e,defaultProducer:s})},unserializeWithLinks:function(t,e){if(0!=n)throw new Error("unserializeWithLinks can only be called outside __unserialize method");l++,o=[];const s=t(),i=e();if(function(t){if(0!=n)throw new Error("resolveLinks can only be called outside __unserialize mathod");o.forEach((e=>{let s;if(e.id instanceof Array)s=e.id.map((s=>{let i=h(s,t);if(void 0===i){if(!e.defaultProducer)throw new Error("Unresolved link: "+e.id);i=e.defaultProducer()}}));else if(s=h(e.id,t),void 0===s){if(!e.defaultProducer)throw new Error("Unresolved link: "+e.id);s=e.defaultProducer()}e.consumer(s)})),o=[]}(i instanceof Array?i:[i]),0!=n)throw new Error("unserializeWithLinks: bad nesting");if(o.length>0)throw new Error("unserializeWithLinks: not all links are resolved: "+o);return l--,s}}},299:(t,e,s)=>{var i=s(134),r=s(751),n=s(485),a=s(550),o=s(350);class l extends i.MB{xy;id;static __type="Marker";region;constructor(t,e){super(t),this.xy=t,this.id=e,this.region=new r.kb(t,5)}getRegion(){return this.region}getCollideRegion(){return r.yp.EMPTY}__serialize(){return super.__serialize()}__unserialize(t){super.__unserialize(t)}}n.Z.registerConstructor(l.__type,(t=>new l(t.xy,t.id)));class h extends i.MB{region;once=!0;triggerOnEnter=!0;triggerOnLeave=!1;triggered=0;inside=!1;constructor(t){super(t.getCenter()),this.region=t}getRegion(){return this.region}getCollideRegion(){return r.yp.EMPTY}progress(t){if(this.triggered>0&&this.once)return;const e=this.getGame();if(null===e)return;const s=r.yp.intersects(e.plane.getRegion(),this.region);!this.inside&&s?(this.inside=!0,this.triggerOnEnter&&(this.triggered++,this.onTrigger()),this.saveChanges()):this.inside&&!s&&(this.inside=!1,this.triggerOnLeave&&(this.triggered++,this.onTrigger()),this.saveChanges())}__serialize(){const t=super.__serialize();return t.region=n.Z.toPojo(this.region),t.triggered=this.triggered,t.once=this.once,t.triggerOnEnter=this.triggerOnEnter,t.triggerOnLeave=this.triggerOnLeave,t.inside=this.inside,t}__unserialize(t){super.__unserialize(t),this.triggered=t.triggered,this.inside=t.inside,this.once=t.once,this.triggerOnEnter=t.triggerOnEnter,this.triggerOnLeave=t.triggerOnLeave}}class c{game;triggerSource;chain=[];terminalCallback;constructor(t,e){this.game=t,this.triggerSource=e}posOf(t){const e=this.game.gameMap.findById(t);if(void 0===e)throw new Error("Not found: "+t);return e.xy}playerHas(t,e){return void 0===e?void 0!==this.game.plane.getAttribute(t):this.game.plane.getAttribute(t)==e}playerSet(t,e){this.game.plane.setAttribute(t,void 0===e?"":e)}playerRemove(t){this.game.plane.deleteAttribute(t)}teleport(t){if("string"==typeof t){const e=1e6,s=new o.K(t);t=[Math.round((s.nextFloat()>.5?-1:1)*s.nextFloat()*e),Math.round((s.nextFloat()>.5?-1:1)*s.nextFloat()*e)]}this.game.teleportTo(t)}after(t){const e=new c(this.game,this.triggerSource);return e.terminalCallback=s=>e.game.gameMap.addEntity(new a.Xf(e.triggerSource.xy,new a.Cs(s,t))),e}move(t){const e=this,s={end(){const t=e.chain.length>1?new a.As(e.chain):e.chain[0];e.chain=[],void 0===e.terminalCallback?e.game.gameMap.addEntity(new a.Xf(e.triggerSource.xy,t)):e.terminalCallback(t)},then:()=>e,loop(){const t=new a.As(e.chain,!0);e.chain=[],void 0===e.terminalCallback?e.game.gameMap.addEntity(new a.Xf(e.triggerSource.xy,t)):e.terminalCallback(t)}};return{_speed:0,_timingFunctionName:"ease",speed(t){return this._speed=t,this},slow(){return this._speed=100,this},fast(){return this._speed=500,this},ease(){return this._timingFunctionName="ease",this},linear(){return this._timingFunctionName="linear",this},up(t=100){return this.offset([0,-t])},down(t=100){return this.offset([0,t])},left(t=100){return this.offset([-t,0])},right(t=100){return this.offset([t,0])},offset(i){return e.chain.push(new a.Ox(t,i,this._speed,this._timingFunctionName)),s},to(i){return e.chain.push(new a.z2(t,i,this._speed,this._timingFunctionName)),s}}}static id=0;showText(t,e,s=3e3,i){this.game.addInfo("gameApi"+(e||c.id++),t,s,i)}}class d extends h{static __type="CallbackTrigger";callback=null;source;constructor(t){super(t)}progress(t){super.progress(t)}onTrigger(){const t=this.getGame();null!==t&&this.callback&&this.callback(new c(t,this))}setCallback(t){this.callback=t,this.source=t.toString()}getCallbackSource(){return this.source}setCallbackSource(t){this.source=t,this.callback=new Function("api",'"use strict";('+t+")(api)")}__serialize(){const t=super.__serialize();return t.callback=this.source,t}__unserialize(t){super.__unserialize(t)}}n.Z.registerConstructor(d.__type,(t=>{const e=new d(n.Z.unserialize(t.region));return e.setCallbackSource(t.callback),e}))},165:(t,e,s)=>{function i(t,...e){return t instanceof Array?(t=t.join("{}"),(r[t]||t).split("{}").map(((t,s,i)=>t+(i.length-1==s?"":e[s]))).join("")):r[t]||t}s.d(e,{t:()=>i,T:()=>r,B:()=>n});const r={booster:"",boosterColor:"black",score:"",scoreColor:"green",time:"",timeColor:"black",fakeTarget:"",fakeTargetColor:"black",fakeTargetStartColor:[255,0,0],fakeTargetEndColor:[255,200,200],fakeTargetRadius:200,life:"",lifeColor:"#ff471a",planeColor:"black",planeBoosterColor:"#ff3333",planeBoosterAlpha:.5,planeStartPos:[0,0],planeFakeTargetRadiusColor:"#cccccc",planeBirthVoidPeriod:4e3,trailStartColor:[255,255,255],trailEndColor:[200,200,200],missileDieStartColor:[0,0,0],missileDieEndColor:[255,255,255],explosionStartColor:[255,0,0],explosionEndColor:[255,200,200],explosionAlpha:.5,obstacleFillColor:"#cccccc",obstacleStrokeColor:"#333333",skyColor:"#f0ffff",skyOutOfRangeColor:"#fff0f0",cloudColor:"#eeeeee",radarFillColor:"#fff2e6",radarStrokeColor:"#663300",radarSectorColor:"#ffcc99",radarVisibilityAreaColor:"#999999",radarPlaneColor:"#663300",radarMissileColor:"#ff0000",radarPerkColor:"#000000",radarEnemyColor:"#0000ff",radarAlpha:.9,radarSize:100,radarScale:20,infoFontSize:15,infoBgColor:"#ffff88",infoColor:"#000000",infoAlpha:.8,telemetrySamplesPerSecond:5,telemetryWindowSeconds:10,detectorIntervalMs:300};function n(t,e,s){if(void 0===e&&void 0===s){const e=t;return`rgb(${e[0]}, ${e[1]}, ${e[2]})`}return`rgb(${t}, ${e}, ${s})`}},658:(t,e,s)=>{s.d(e,{N:()=>a});var i=s(607),r=s(134),n=s(464);class a{interval;game;capacity;lastTime=0;time=0;planeState;missileState;lastClosestMissile=null;constructor(t,e,s){this.interval=t,this.game=e,this.capacity=s,this.planeState=new i.d(this.capacity),this.missileState=new i.d(this.capacity)}toTrigger(){return t=>this.progress(t)}progress(t){this.time+=t,this.time-this.lastTime>=this.interval&&(this.lastTime=this.time,this._collect())}_collect(){let t=1e20,e=null;const s=this.game.plane;for(let i of this.game.flies)if(i instanceof r.Cp){const r=s.xy[0]-i.xy[0],n=s.xy[1]-i.xy[1],a=r*r+n*n;a<t&&(t=a,e=i)}let i=!1;this.lastClosestMissile!==e&&(null!==this.lastClosestMissile&&this.lastClosestMissile.isDying()&&(i=!0),this.lastClosestMissile=e),this.planeState.push({t:this.time,xy:s.xy,v:n.Z.normalize(s.v)}),null!==e?this.missileState.push({t:this.time,xy:e.xy,v:n.Z.normalize(e.v),lastMissileIsDead:i}):this.missileState.push({t:this.time,xy:[1/0,1/0],v:[0,0],lastMissileIsDead:i})}getLatestPlaneState(){return this.planeState.size>0?this.planeState.get(this.planeState.size-1):null}getLatestMissileState(){return this.missileState.size>0?this.missileState.get(this.missileState.size-1):null}}},925:(t,e,s)=>{s.d(e,{Z:()=>m});let i=0;const r=[],n=new Map;let a=!1,o=0,l=!1;function h(t,e,s){return void 0===s&&(i++,s=i),c({id:s,time:o+e,duration:e,f:t,paused:!1,progressBeforePause:0}),s}function c(t){let e;for(e=0;e<r.length&&!(r[e].time>t.time);e++);n.set(t.id,t),r.splice(e,0,t)}function d(t){const e=n.get(t);return void 0===e?0:e.paused?e.progressBeforePause:0===e.duration?0:1-(e.time-o)/e.duration}function u(t){let e=n.get(t);if(void 0===e)return;if(e.paused)return;e.progressBeforePause=d(t),e.paused=!0;let s=r.findIndex((e=>e.id===t));r.splice(s,1)}function g(t){let e=n.get(t);void 0!==e&&e.paused&&(e.time=o+(1-e.progressBeforePause)*e.duration,e.paused=!1,e.progressBeforePause=0,c(e))}function p(t){return function(){if(!l)return t.apply(null,arguments);setTimeout((()=>t.apply(null,arguments)),0)}}const m={set:h,periodic:function t(e,s,i){let r=h((()=>{e(),t(e,s,r)}),s,i);return r},clear:p((function(t){let e=r.findIndex((e=>e.id===t));-1!==e&&(r.splice(e,1),n.delete(t))})),clearAll:p((function(){n.clear(),r.splice(0,r.length),a=!1})),pause:p(u),pauseAll:p((function(){for(let[t,e]of n)u(t);a=!0})),resume:p(g),resumeAll:p((function(){for(let[t,e]of n)g(t);a=!1})),allPaused:()=>a,getProgress:d,progress:function(t){if(o+=t,!a){l=!0;try{!function(){if(a)return;let t;for(t=0;t<r.length&&!(r[t].time>o);t++);t>0&&r.splice(0,t).forEach((t=>t.f()))}()}finally{l=!1}}},now:()=>o}},32:(t,e,s)=>{s.d(e,{h:()=>h});const i="input is invalid type",r="0123456789abcdef".split(""),n=[-2147483648,8388608,32768,128],a=[24,16,8,0],o=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298];class l{h0;h1;h2;h3;h4;h5;h6;h7;blocks;block=0;start=0;bytes=0;hBytes=0;finalized=!1;hashed=!1;first=!0;lastByteIndex;is224;constructor(t=!1){this.init(t)}init(t){this.is224=t,this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],t?(this.h0=3238371032,this.h1=914150663,this.h2=812702999,this.h3=4144912697,this.h4=4290775857,this.h5=1750603025,this.h6=1694076839,this.h7=3204075428):(this.h0=1779033703,this.h1=3144134277,this.h2=1013904242,this.h3=2773480762,this.h4=1359893119,this.h5=2600822924,this.h6=528734635,this.h7=1541459225)}update(t){if(this.finalized)return this;var e,s=typeof t;if("string"!==s){if("object"!==s)throw new Error(i);if(null===t)throw new Error(i);if(t.constructor===ArrayBuffer)t=new Uint8Array(t);else if(!Array.isArray(t)&&!ArrayBuffer.isView(t))throw new Error(i);e=!0}for(var r,n,o=0,l=t.length,h=this.blocks;o<l;){if(this.hashed&&(this.hashed=!1,h[0]=this.block,h[16]=h[1]=h[2]=h[3]=h[4]=h[5]=h[6]=h[7]=h[8]=h[9]=h[10]=h[11]=h[12]=h[13]=h[14]=h[15]=0),e)for(n=this.start;o<l&&n<64;++o)h[n>>2]|=t[o]<<a[3&n++];else for(n=this.start;o<l&&n<64;++o)(r=t.charCodeAt(o))<128?h[n>>2]|=r<<a[3&n++]:r<2048?(h[n>>2]|=(192|r>>6)<<a[3&n++],h[n>>2]|=(128|63&r)<<a[3&n++]):r<55296||r>=57344?(h[n>>2]|=(224|r>>12)<<a[3&n++],h[n>>2]|=(128|r>>6&63)<<a[3&n++],h[n>>2]|=(128|63&r)<<a[3&n++]):(r=65536+((1023&r)<<10|1023&t.charCodeAt(++o)),h[n>>2]|=(240|r>>18)<<a[3&n++],h[n>>2]|=(128|r>>12&63)<<a[3&n++],h[n>>2]|=(128|r>>6&63)<<a[3&n++],h[n>>2]|=(128|63&r)<<a[3&n++]);this.lastByteIndex=n,this.bytes+=n-this.start,n>=64?(this.block=h[16],this.start=n-64,this.hash(),this.hashed=!0):this.start=n}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296<<0,this.bytes=this.bytes%4294967296),this}finalize(){if(!this.finalized){this.finalized=!0;var t=this.blocks,e=this.lastByteIndex;t[16]=this.block,t[e>>2]|=n[3&e],this.block=t[16],e>=56&&(this.hashed||this.hash(),t[0]=this.block,t[16]=t[1]=t[2]=t[3]=t[4]=t[5]=t[6]=t[7]=t[8]=t[9]=t[10]=t[11]=t[12]=t[13]=t[14]=t[15]=0),t[14]=this.hBytes<<3|this.bytes>>>29,t[15]=this.bytes<<3,this.hash()}}hash(){var t,e,s,i,r,n,a,l,h,c=this.h0,d=this.h1,u=this.h2,g=this.h3,p=this.h4,m=this.h5,f=this.h6,y=this.h7,v=this.blocks;for(t=16;t<64;++t)e=((r=v[t-15])>>>7|r<<25)^(r>>>18|r<<14)^r>>>3,s=((r=v[t-2])>>>17|r<<15)^(r>>>19|r<<13)^r>>>10,v[t]=v[t-16]+e+v[t-7]+s<<0;for(h=d&u,t=0;t<64;t+=4)this.first?(this.is224?(n=300032,y=(r=v[0]-1413257819)-150054599<<0,g=r+24177077<<0):(n=704751109,y=(r=v[0]-210244248)-1521486534<<0,g=r+143694565<<0),this.first=!1):(e=(c>>>2|c<<30)^(c>>>13|c<<19)^(c>>>22|c<<10),i=(n=c&d)^c&u^h,y=g+(r=y+(s=(p>>>6|p<<26)^(p>>>11|p<<21)^(p>>>25|p<<7))+(p&m^~p&f)+o[t]+v[t])<<0,g=r+(e+i)<<0),e=(g>>>2|g<<30)^(g>>>13|g<<19)^(g>>>22|g<<10),i=(a=g&c)^g&d^n,f=u+(r=f+(s=(y>>>6|y<<26)^(y>>>11|y<<21)^(y>>>25|y<<7))+(y&p^~y&m)+o[t+1]+v[t+1])<<0,e=((u=r+(e+i)<<0)>>>2|u<<30)^(u>>>13|u<<19)^(u>>>22|u<<10),i=(l=u&g)^u&c^a,m=d+(r=m+(s=(f>>>6|f<<26)^(f>>>11|f<<21)^(f>>>25|f<<7))+(f&y^~f&p)+o[t+2]+v[t+2])<<0,e=((d=r+(e+i)<<0)>>>2|d<<30)^(d>>>13|d<<19)^(d>>>22|d<<10),i=(h=d&u)^d&g^l,p=c+(r=p+(s=(m>>>6|m<<26)^(m>>>11|m<<21)^(m>>>25|m<<7))+(m&f^~m&y)+o[t+3]+v[t+3])<<0,c=r+(e+i)<<0;this.h0=this.h0+c<<0,this.h1=this.h1+d<<0,this.h2=this.h2+u<<0,this.h3=this.h3+g<<0,this.h4=this.h4+p<<0,this.h5=this.h5+m<<0,this.h6=this.h6+f<<0,this.h7=this.h7+y<<0}hex(){this.finalize();var t=this.h0,e=this.h1,s=this.h2,i=this.h3,n=this.h4,a=this.h5,o=this.h6,l=this.h7,h=r[t>>28&15]+r[t>>24&15]+r[t>>20&15]+r[t>>16&15]+r[t>>12&15]+r[t>>8&15]+r[t>>4&15]+r[15&t]+r[e>>28&15]+r[e>>24&15]+r[e>>20&15]+r[e>>16&15]+r[e>>12&15]+r[e>>8&15]+r[e>>4&15]+r[15&e]+r[s>>28&15]+r[s>>24&15]+r[s>>20&15]+r[s>>16&15]+r[s>>12&15]+r[s>>8&15]+r[s>>4&15]+r[15&s]+r[i>>28&15]+r[i>>24&15]+r[i>>20&15]+r[i>>16&15]+r[i>>12&15]+r[i>>8&15]+r[i>>4&15]+r[15&i]+r[n>>28&15]+r[n>>24&15]+r[n>>20&15]+r[n>>16&15]+r[n>>12&15]+r[n>>8&15]+r[n>>4&15]+r[15&n]+r[a>>28&15]+r[a>>24&15]+r[a>>20&15]+r[a>>16&15]+r[a>>12&15]+r[a>>8&15]+r[a>>4&15]+r[15&a]+r[o>>28&15]+r[o>>24&15]+r[o>>20&15]+r[o>>16&15]+r[o>>12&15]+r[o>>8&15]+r[o>>4&15]+r[15&o];return this.is224||(h+=r[l>>28&15]+r[l>>24&15]+r[l>>20&15]+r[l>>16&15]+r[l>>12&15]+r[l>>8&15]+r[l>>4&15]+r[15&l]),h}toString(){return this.hex()}digest(){this.finalize();var t=this.h0,e=this.h1,s=this.h2,i=this.h3,r=this.h4,n=this.h5,a=this.h6,o=this.h7,l=[t>>24&255,t>>16&255,t>>8&255,255&t,e>>24&255,e>>16&255,e>>8&255,255&e,s>>24&255,s>>16&255,s>>8&255,255&s,i>>24&255,i>>16&255,i>>8&255,255&i,r>>24&255,r>>16&255,r>>8&255,255&r,n>>24&255,n>>16&255,n>>8&255,255&n,a>>24&255,a>>16&255,a>>8&255,255&a];return this.is224||l.push(o>>24&255,o>>16&255,o>>8&255,255&o),l}array(){return this.digest()}arrayBuffer(){this.finalize();var t=new ArrayBuffer(this.is224?28:32),e=new DataView(t);return e.setUint32(0,this.h0),e.setUint32(4,this.h1),e.setUint32(8,this.h2),e.setUint32(12,this.h3),e.setUint32(16,this.h4),e.setUint32(20,this.h5),e.setUint32(24,this.h6),this.is224||e.setUint32(28,this.h7),t}}function h(){return function(){var t=new l;if(t.update((new Date).getTime().toString()),window.crypto){var e=new Uint32Array(16);window.crypto.getRandomValues(e);for(let s of e)t.update(s.toString())}else for(var s=0;s<16;s++)t.update(Math.random().toString());return t.update(navigator.userAgent||""),t.update(navigator.language||""),t.update((window.screen.colorDepth||-1).toString()),t.update((window.devicePixelRatio||"").toString()),t.update((new Date).getTimezoneOffset().toString()),t.update(navigator.hardwareConcurrency.toString()||""),t.update(navigator.platform||""),t.update((navigator.hardwareConcurrency||"").toString()),t.hex()}()}},464:(t,e,s)=>{s.d(e,{Z:()=>r});const i={add:(t,e)=>t.map(((t,s)=>t+e[s])),negate:t=>t.map((t=>-t)),subtract:(t,e)=>i.add(t,i.negate(e)),length:t=>Math.sqrt(t.map((t=>t*t)).reduce(((t,e)=>t+e),0)),normalize:t=>i.mulByScalar(t,1/i.length(t)),mulByScalar:(t,e)=>t.map((t=>t*e)),dotProduct:(t,e)=>t.map(((t,s)=>t*e[s])).reduce(((t,e)=>t+e),0),clone:t=>t.slice(0),random:(t,e=(()=>Math.random()))=>{let s=void 0===t?1:t,i=e()*Math.PI*2;return[s*Math.sin(i),s*Math.cos(i)]},normal:t=>{let e=i.length(t),s=i.normalize(t);return[e*-s[1],e*s[0]]},rotate:(t,e)=>[t[0]*Math.cos(e)-t[1]*Math.sin(e),t[1]*Math.cos(e)+t[0]*Math.sin(e)],alignUp:(t,e)=>{const s=i.length(t),r=t[0]/s,n=t[1]/s;return[e[0]*n-e[1]*r,e[1]*n+e[0]*r]},angle:(t,e)=>{const s=i.dotProduct(t,e)/i.length(t)/i.length(e);return 180*Math.acos(s)/Math.PI},dist:(t,e)=>i.length(i.subtract(t,e)),behind:(t,e,s)=>{const r=i.normal(t);if(Math.abs(r[0])<1e-6)return s[1]<Math.sign(r[1])*e[1];const n=s[0],a=r[1]*(n-e[0])/r[0]+e[1],o=t[0]+e[0],l=r[1]*(o-e[0])/r[0]+e[1];return Math.sign(a-s[1])!=Math.sign(l-e[1])}},r=i}},e={};function s(i){var r=e[i];if(void 0!==r)return r.exports;var n=e[i]={exports:{}};return t[i](n,n.exports,s),n.exports}s.d=(t,e)=>{for(var i in e)s.o(e,i)&&!s.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:e[i]})},s.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),s(182),s(299),s(550),s(386),s(976),s(545),s(509)})();