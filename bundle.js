(()=>{"use strict";var t={917:(t,e,s)=>{s.d(e,{jt:()=>n,pf:()=>o,Ms:()=>a,fw:()=>c});var i=s(925),r=s(485);function n(t,e,s,i,r){if(i<=s)return()=>e;const n=t.map(((t,s)=>r().init(t,e[s])));return t=>n.map((e=>e.progress((t-s)/(i-s))))}function o(t,e,s,r,o,a,l){let h=n(t,e,0,r,o),c=i.Z.now(),d=t.slice(),u=null,p=()=>{null!==u&&(i.Z.clear(u),u=null,l&&l(d))},g=()=>{let t=Math.min(i.Z.now()-c,r);d=h(t),a&&a(d),t==r&&p()};return u=i.Z.periodic(g,s),g(),Object.assign((()=>d),{cancel:p})}class a{static ease=()=>()=>new h;static linear=(t=0)=>()=>new l(t);static byName(t){switch(t){case"ease":return a.ease();case"linear":return a.linear(0);default:throw new Error("Unknown timing function: "+t)}}from;to;init(t,e){return this.from=t,this.to=e,this.doInit(),this}}class l extends a{shift;t1s;t2s;step;constructor(t){super(),this.shift=t}doInit(){this.t1s=0,this.t2s=1,this.shift<0&&(this.t1s=0+1*-this.shift),this.shift>0&&(this.t2s=0+1*(1-this.shift)),this.step=(this.to-this.from)/(this.t2s-this.t1s)}progress(t){return t<=this.t1s?this.from:t>=this.t2s?this.to:this.from+this.step*(t-this.t1s)}}class h extends a{doInit(){}progress(t){return this.from+Math.sin(Math.PI/2*t)*(this.to-this.from)}}class c{v1;v2;progressMs;intervalMs;timingFunctionName;timePassed;timePassedSinceLastFrame;static __type="Animation";animation;_onAnimationProgress=()=>{};constructor(t,e,s,i,r,o=0,l=0){this.v1=t,this.v2=e,this.progressMs=s,this.intervalMs=i,this.timingFunctionName=r,this.timePassed=o,this.timePassedSinceLastFrame=l,this.animation=n(t,e,o,i,a.byName(this.timingFunctionName))}progress(t){return this.timePassed+=t,this.timePassed>=this.intervalMs?(this._onAnimationProgress(this.animation(this.intervalMs)),!1):(this.timePassedSinceLastFrame+=t,this.timePassedSinceLastFrame>=this.progressMs&&this._onAnimationProgress(this.animation(this.timePassed)),!0)}set onAnimationProgress(t){this._onAnimationProgress=t}__serialize(){return{v1:this.v1,v2:this.v2,progressMs:this.progressMs,intervalMs:this.intervalMs,timingFunctionName:this.timingFunctionName,timePassed:this.timePassed,timePassedSinceLastFrame:this.timePassedSinceLastFrame}}__unserialize(t){}}r.Z.registerConstructor(c.__type,(t=>new c(t.v1,t.v2,t.progressMs,t.intervalMs,t.timingFunctionName,t.timePassed,t.timePassedSinceLastFrame)))},811:(t,e,s)=>{s.d(e,{g:()=>n});var i=s(607),r=s(464);class n{history;checks;steps;lastPlaneState;constructor(t,...e){this.history=new i.d(t),this.checks=e,this.steps=[]}addCheck(t){this.checks.push(t)}addStep(t){this.steps.push(t)}detect(t){t.planeState.size>0&&(t.planeState.forEach(((e,s)=>{const i=t.missileState.get(s),n=r.Z.length(r.Z.subtract(e.xy,i.xy)),o=r.Z.angle(e.v,i.v),a=Math.sign(r.Z.dotProduct(e.v,i.v))>=0,l=r.Z.behind(i.v,i.xy,e.xy),h=i.lastMissileIsDead;this.history.push({t:e.t,dist:n,angle:o,sameDir:a,behind:l,missileIsDead:h})})),this.checks.forEach((t=>t(this.history))))}step(t){if(t.planeState.size>0){const e=t.getLatestPlaneState(),s=t.getLatestMissileState();if(null===e||null===s)return;if(this.lastPlaneState===e)return;this.lastPlaneState=e;const i=r.Z.length(r.Z.subtract(e.xy,s.xy)),n=r.Z.angle(e.v,s.v),o=Math.sign(r.Z.dotProduct(e.v,s.v))>=0,a=r.Z.behind(s.v,s.xy,e.xy),l=s.lastMissileIsDead;let h={t:e.t,dist:i,angle:n,sameDir:o,behind:a,missileIsDead:l};this.steps.forEach((t=>t(h)))}}}},238:(t,e,s)=>{var i=s(165);class r{keyUp=new Map;keyDown=new Map;mouseUp=new Map;mouseDown=new Map;mouseLeave=new Map;mouseMoveAction=new Map;mouseZoomAction=new Map;doubleclickAction=new Map;_next=null;clone(){const t=new r;return t.keyUp=new Map(this.keyUp),t.keyDown=new Map(this.keyDown),t.mouseUp=new Map(this.mouseUp),t.mouseDown=new Map(this.mouseDown),t.mouseLeave=new Map(this.mouseLeave),t.mouseMoveAction=new Map(this.mouseMoveAction),t.mouseZoomAction=new Map(this.mouseZoomAction),t.doubleclickAction=new Map(this.doubleclickAction),null!=this._next&&(t._next=this._next.clone()),t}}let n=0,o=new Set,a=null,l=new r;function h(t,e){let s=l;do{let i=t(s);if(i.has(e))return i.get(e);s=s._next}while(null!==s);return null}function c(t,e){return(void 0===t[e]?"":t[e]).toString()+","+t.altKey.toString()+","+t.ctrlKey.toString()+","+t.metaKey.toString()+","+t.shiftKey.toString()}const d=[i.t`Left`,i.t`Middle`,i.t`Right`];function u(t){let e=t.split(","),s=parseInt(e[0]);return("true"==e[1]?"Alt + ":"")+("true"==e[2]?"Ctrl + ":"")+("true"==e[3]?"Win + ":"")+("true"==e[4]?"Shift + ":"")+(d[s]?d[s]:(0,i.t)(e[0]).replace(/^Key/,""))}let p=!1;window.onkeydown=t=>{if(p)return;if(o.has(t.code))return;o.add(t.code);let e=h((t=>t.keyDown),c(t,"code"));e&&(t.preventDefault(),e.callback(t))},window.onkeyup=t=>{if(p)return;o.delete(t.code);let e=h((t=>t.keyUp),c(t,"code"));e&&(t.preventDefault(),e.callback(t))};const g={doubleclick:function(t,e,s){const i=c({button:"Left",altKey:-1!==t.indexOf("Alt"),ctrlKey:-1!==t.indexOf("Ctrl"),metaKey:-1!==t.indexOf("Win")||-1!==t.indexOf("Meta"),shiftKey:-1!==t.indexOf("Shift")},"");l.doubleclickAction.set(i,{description:e,callback:s})},mouse:function(t,e,s,i,r){const n=c({button:t,altKey:-1!==e.indexOf("Alt"),ctrlKey:-1!==e.indexOf("Ctrl"),metaKey:-1!==e.indexOf("Win")||-1!==e.indexOf("Meta"),shiftKey:-1!==e.indexOf("Shift")},"button");r&&l.mouseDown.set(n,{description:s,callback:r}),i&&l.mouseUp.set(n,{description:s,callback:i})},mouseMove:function(t,e,s){const i=c({button:"",altKey:-1!==t.indexOf("Alt"),ctrlKey:-1!==t.indexOf("Ctrl"),metaKey:-1!==t.indexOf("Win")||-1!==t.indexOf("Meta"),shiftKey:-1!==t.indexOf("Shift")},"button");l.mouseMoveAction.set(i,{description:e,callback:s})},mouseLeave:function(t,e){l.mouseLeave.set("",{description:t,callback:e})},mouseZoom:function(t,e,s){const i=c({button:"",altKey:-1!==t.indexOf("Alt"),ctrlKey:-1!==t.indexOf("Ctrl"),metaKey:-1!==t.indexOf("Win")||-1!==t.indexOf("Meta"),shiftKey:-1!==t.indexOf("Shift")},"button");l.mouseZoomAction.set(i,{description:e,callback:s})},key:function(t,e,s,i,r){const n=c({code:t.toString(),altKey:-1!==e.indexOf("Alt"),ctrlKey:-1!==e.indexOf("Ctrl"),metaKey:-1!==e.indexOf("Win")||-1!==e.indexOf("Meta"),shiftKey:-1!==e.indexOf("Shift")},"code");i&&l.keyDown.set(n,{description:s,callback:i}),r&&l.keyUp.set(n,{description:s,callback:r})},help:function(){const t=t=>{let e=[];for(let[s,i]of function*(t){let e=new Set;for(let s=l;null!=s;s=s._next){let i=t(s);for(let[t,s]of i)e.has(t)||(e.add(t),yield[t,s])}}(t))e.push({description:i.description,button:s});return e};return{keys:t((t=>t.keyDown)).map((({button:t,description:e})=>u(t)+": "+e)),mouse:t((t=>t.mouseUp)).map((({button:t,description:e})=>u(t)+": "+e)).concat(t((t=>t.mouseZoomAction)).map((({button:t,description:e})=>u(t)+"Wheel: "+e)))}},init:function(t){a=t,a.onmousedown=t=>{if(p)return;t.preventDefault();let e=h((t=>t.mouseDown),c(t,"button"));e&&e.callback(t)},a.onmousemove=t=>{if(p)return;t.preventDefault();let e=h((t=>t.mouseMoveAction),c(t,""));e&&e.callback(t)},a.onmouseup=t=>{if(p)return;t.preventDefault();let e=h((t=>t.mouseUp),c(t,"button"));e&&e.callback(t)},a.ondblclick=t=>{if(p)return;t.preventDefault();let e=h((t=>t.doubleclickAction),c(t,""));e&&e.callback(t)},window.oncontextmenu=t=>{p||t.preventDefault()},a.addEventListener("wheel",(t=>{if(p)return;t.preventDefault();let e=h((t=>t.mouseZoomAction),c(t,""));e&&e.callback(t)}),!1),a.addEventListener("mouseleave",(t=>{if(p)return;t.preventDefault();let e=h((t=>t.mouseLeave),"");e&&e.callback(t)}))},push:()=>{let t=new r;t._next=l,l=t},pop:()=>{null!==l._next&&(l=l._next)},snapshot:()=>l.clone(),restoreFromSnapshot:t=>{l=t},resetToRoot:()=>{l=new r},off:()=>{0==n++&&(p=!0)},on:()=>{if(0===n)throw new Error("Can't on without off");0==--n&&(p=!1)},dragAndDrop:(t,e,s,i,r,n,o)=>{let l,h=[0,0];g.mouse(t,e,s,(t=>{if(null===a)return;const e=o([t.clientX,t.clientY]);g.pop(),void 0!==l&&n([e[0]-h[0],e[1]-h[1]],l)}),(t=>{if(null===a)return;const n=o([t.clientX,t.clientY]);if(l=i(n),void 0===l)return;const c=l.getCenter();h[0]=n[0]-c[0],h[1]=n[1]-c[1],r(c,l),g.push(),g.mouseMove(e,s,(t=>{if(null===a||void 0===l)return;const e=o([t.clientX,t.clientY]);r([e[0]-h[0],e[1]-h[1]],l)}))}))}},m=g;var f=s(381),y=s(925),v=s(134),x=s(464),w=s(485);class b{static __type="Level";level=1;missileMaxCount=1;missileProbability=.5;missilePeriod=1e3;outOfRangeRadius=6e3;game;init(t){this.game=t,this.tryToCreate(v.Cp,(()=>this.missileProbability),(()=>this.missileMaxCount),(()=>{const e=t.gameMap.visibleSize,s=1.2*t.gameMap.visibleSize,i=x.Z.add(t.plane.xy,x.Z.random(e+Math.random()*(s-e)));return new v.Cp(i,t.plane)}),(()=>this.missilePeriod)),_(this.game,10,(()=>this.game.plane.lifes+=1)),_(this.game,5,(()=>this.game.plane.fakeTargets+=1)),_(this.game,2,(()=>this.game.plane.booster+=2e3))}progress(t){switch(this.level){case 1:(this.game.plane.score>4||this.game.globalTime>3e4)&&(this.level=2,this.missileMaxCount=2);break;case 2:this.game.globalTime>6e4&&(this.level=3,this.missileMaxCount=3,this.missileProbability=1)}}onDeadMissile(t){this.game.plane.score+=1,this.game.achievement(i.t`+1`,i.T.scoreColor,2e3,t)}tryToCreate(t,e,s,i,r,n){if(n&&(this.game.localMode||this.game.masterGameNode)&&Math.random()<e()&&this.game.flies.filter((e=>e instanceof t)).length<s()){let t,e;do{t=i(),e=!1;for(const s of this.game.flies)s.collideWith(t)&&(e=!0);if(!e)for(const s of this.game.gameMap.find(t.xy,t.linearSize()))s.collideWith(t)&&(e=!0)}while(e);this.game.addEntity(t)}y.Z.set((()=>this.tryToCreate(t,e,s,i,r,!0)),r())}__serialize(){return{level:this.level,missileMaxCount:this.missileMaxCount,missilePeriod:this.missilePeriod,missileProbability:this.missileProbability}}__unserialize(t){this.level=t.level,this.missileMaxCount=t.missileMaxCount,this.missilePeriod=t.missilePeriod,this.missileProbability=t.missileProbability}}function _(t,e,s){let i=t.plane.score;t.plane.subscribe((r=>{r instanceof v.Vz&&t.plane.score-i>=e&&(i=t.plane.score,s())}))}function T(t,e){let s;s=m.snapshot(),m.resetToRoot(),m.key("Space",[],i.t`Hide the message`,(()=>a())),m.key("Escape",[],i.t`Hide the message`,(()=>a())),m.key("Enter",[],i.t`Hide the message`,(()=>a())),m.mouse(0,[],i.t`Hide the message`,(()=>a()));let r=document.getElementById("message");r.innerHTML="";let n=document.createElement("div");n.innerText=t,r.appendChild(n),r.style.display="block",n.onclick=()=>a();let o=!1;function a(){o||(o=!0,r.style.display="none",void 0!==s&&m.restoreFromSnapshot(s),e&&e())}return a}w.Z.registerConstructor(b.__type,(t=>new b));class S{r;map=new Map;constructor(t){this.r=t}insert(t,e,s){let i=Math.floor((t[0]-e)/this.r),r=Math.floor((t[0]+e)/this.r),n=Math.floor((t[1]-e)/this.r),o=Math.floor((t[1]+e)/this.r);for(let t=i,e=i*this.r;t<=r;t++,e+=this.r)for(let e=n,i=n*this.r;e<=o;e++,i+=this.r){let i=this.map.get(t);i||(i=new Map,this.map.set(t,i));let r=i.get(e);r||(r=new Set,i.set(e,r)),r.add(s)}}find(t,e){let s=Math.floor((t[0]-e)/this.r),i=Math.floor((t[0]+e)/this.r),r=Math.floor((t[1]-e)/this.r),n=Math.floor((t[1]+e)/this.r),o=new Set;for(let t=s;t<=i;t++)for(let e=r;e<=n;e++){let s=this.map.get(t);if(!s)continue;let i=s.get(e);i&&i.forEach((t=>o.add(t)))}return o}remove(t,e,s){let i=Math.floor((t[0]-e)/this.r),r=Math.floor((t[0]+e)/this.r),n=Math.floor((t[1]-e)/this.r),o=Math.floor((t[1]+e)/this.r);for(let t=i;t<=r;t++)for(let e=n;e<=o;e++){let i=this.map.get(t);if(!i)return;let r=i.get(e);if(!r)return;r.delete(s)}}clear(){this.map.clear()}}var P=s(751),M=s(350);class C{loading=new Map;newTask(t,e){const s=this.loading.get(t);if(void 0!==s){const i=s.then((()=>e()));return this.loading.set(t,i),i}const i=e().then((e=>(this.loading.delete(t),e)));return this.loading.set(t,i),i}}class k{clear(t){return Object.keys(localStorage).filter((e=>e.startsWith(`parts[${t}]`))).forEach((t=>localStorage.removeItem(t))),Promise.resolve()}load(t,e){return Promise.resolve(localStorage.getItem(k.key(t,e)))}save(t,e,s){return localStorage.setItem(k.key(t,e),s),Promise.resolve()}static key(t,e){return`parts[${t}][${e}]`}restoreFromSnapshot(t,e){this.clear(t),JSON.parse(e).forEach((({key:t,value:e})=>localStorage.setItem(t,e)))}snapshot(t){const e=[];for(let s in localStorage)s.startsWith(`parts[${t}]`)&&e.push({key:s,value:localStorage[s]});return JSON.stringify(e)}}class z{firebase;constructor(t){this.firebase=t}clear(t){throw new Error("Unsupported operation")}load(t,e){return this.firebase.loadString(`/maps/${encodeURIComponent(t)}/${encodeURIComponent(e)}`)}save(t,e,s){return this.firebase.saveString(`/maps/${encodeURIComponent(t)}/${encodeURIComponent(e)}`,s)}restoreFromSnapshot(t,e){throw new Error("Unsupported operation")}snapshot(t){throw new Error("Unsupported operation")}}class I{source;cache;writeBoth=!1;constructor(t,e){this.source=t,this.cache=e}clear(t){return this.cache.clear(t)}load(t,e){return this.cache.load(t,e).then((s=>null===s?this.source.load(t,e).then((s=>null===s?null:this.cache.save(t,e,s).then((()=>s)))):s))}save(t,e,s){return this.writeBoth?Promise.all([this.cache.save(t,e,s),this.source.save(t,e,s)]):this.cache.save(t,e,s)}restoreFromSnapshot(t,e){this.cache.restoreFromSnapshot(t,e)}snapshot(t){return this.cache.snapshot(t)}}class E{backend;seqTasks=new C;constructor(t=new k){this.backend=t}load(t,e,s,i){if(Number.isNaN(e)||Number.isNaN(s))throw new Error("Can't load the part: "+e+", "+s);return this.seqTasks.newTask(`${t},${e},${s}`,(()=>this.backend.load(t,`${e},${s}`).then((t=>{if(null===t||"null"===t)return null;const r=w.Z.unserializeWithLinks((()=>w.Z.unserialize(t).filter((t=>null!==t))),(()=>new Map([["game",i]])));return console.log("loaded",e,s),r}))))}save(t,e,s,i){if(Number.isNaN(e)||Number.isNaN(s))throw new Error("Can't save the part: "+e+", "+s);return this.seqTasks.newTask(`${t},${e},${s}`,(()=>this.backend.save(t,`${e},${s}`,w.Z.serialize(i)).then((t=>console.log("saved",e,s)))))}clear(t){return this.backend.clear(t)}}class Z{game;_visibleSize;gameSeed;parts=new Map;byId=new Map;tree;lastPx;lastPy;partsStore;seqTasks=new C;constructor(t,e,s,i,r=new k){this.game=t,this._visibleSize=s,this.gameSeed=i,this.tree=new S(e),this.partsStore=new E(r)}get visibleSize(){return this._visibleSize}find(t,e){return this.tree.find(t,e)}findById(t){return this.byId.get(t)}reset(t=!1){t&&(this.lastPx=this.lastPy=1/0),this.parts.clear(),this.tree.clear(),this.byId.clear()}isPartAvailableForXy(t){const[e,s]=this.toPartCoordinates(t),i=this.parts.get(e);if(void 0===i)return!1;return void 0!==i.get(s)}deleteAllCustomContent(){return this.reset(!0),this.partsStore.clear(this.gameSeed)}partTask(t,e){return this.seqTasks.newTask(`${t.px},${t.py}`,(()=>e(t)))}async iAmHere(t){const[e,s]=this.toPartCoordinates(t);if(this.lastPx==e&&this.lastPy==s)return;const i=this.lastPx,r=this.lastPy;this.lastPx=e,this.lastPy=s;let n=!1;Math.max(Math.abs(i-e),Math.abs(r-s))>2&&(console.log("teleportation detected from",i,r,"to",e,s),await this.saveChanged(),this.reset(),n=!0);const o=await this.loadNeighborhood(e,s);n||await this.unloadNonNeighbors(i,r,o)}unloadNonNeighbors(t,e,s){const i=[];for(let r of[-1,0,1])for(let n of[-1,0,1]){const o=t+r,a=e+n;if(s.has(`${o},${a}`))continue;const l=this.parts.get(o);if(void 0===l)continue;const h=l.get(a);if(!h)continue;const c=()=>{this.removePart(h),console.log("unloaded",h.px,h.py)};h.random?c():i.push(this.savePart(h).then((()=>c())))}return Promise.all(i).then()}loadNeighborhood(t,e){const s=new Set,i=[];for(let r of[0,-1,1])for(let n of[0,-1,1]){const o=t+r,a=e+n;s.add(`${o},${a}`);let[l,h]=this.getOrCreatePart(o,a);if("new"===h){const t=this.loadPart(l);i.push(t)}}return Promise.all(i).then((()=>s))}withTemporaryEntity(t,e){const s=this.getPartByXy(t.xy);null!==s&&(this.add(s,t),e(),this.remove(s,t,!0))}addEntity(t){const e=this.getPartByXy(t.xy);null!==e&&(this.add(e,t),e.random=!1)}entityChanged(t){const e=this.getPartByXy(t.xy);null!==e&&(e.random=!1)}changeEntityGeometry(t,e){this.removeEntity(t),e(t),this.addEntity(t)}removeEntity(t){const e=this.getPartByXy(t.xy);null!==e&&this.remove(e,t,!0)}saveChanged(){const t=[];for(const e of this.parts.values())for(const s of e.values())s.random||t.push(this.savePart(s));return Promise.all(t)}toPartCoordinates(t){return[Math.floor(t[0]/this._visibleSize),Math.floor(t[1]/this._visibleSize)]}*all(){for(const t of this.parts.values())for(const e of t.values())for(let t of e.entities)yield t}drawParts(t){t.fillStyle=t.strokeStyle="#cccccc",t.font="13px sans";for(const[e,s]of this.parts)for(const i of s.keys()){const s=e*this._visibleSize,r=i*this._visibleSize;t.strokeRect(s,r,this._visibleSize,this._visibleSize),t.fillText(`(${e}, ${i})`,s+10,r-10)}}savePart(t){return t.entities=t.entities.filter((t=>null!=t)),this.partTask(t,(t=>this.partsStore.save(this.gameSeed,t.px,t.py,t.entities)))}loadPart(t){return this.partTask(t,(t=>this.partsStore.load(this.gameSeed,t.px,t.py,this.game).then((e=>{if(e){for(let s of e)this.add(t,s);t.random=!1}else this.generate(t)}))))}randomXy(t,e,s){return[(t+s.nextFloat())*this._visibleSize,(e+s.nextFloat())*this._visibleSize]}generate(t){const e=new M.K(`${t.px},${t.py},${this.gameSeed}`);return this.tryToCreate(t,this._visibleSize/2e3,(()=>new v.Ux(this.randomXy(t.px,t.py,e))),e),this.tryToCreate(t,this._visibleSize/4e3,(()=>new v.Vk(this.randomXy(t.px,t.py,e))),e),this.randomObstacles(t,4*this._visibleSize/1e3,e),this.randomClouds(t,10*this._visibleSize/500,e),console.log("generated",t.px,t.py),t.random=!0,t}tryToCreate(t,e,s,i){const r=Math.floor(i.nextFloat()*(e+1));for(let e=0;e<r;e++){let e,i;do{e=s(),i=!1;for(const t of this.tree.find(e.xy,e.linearSize()))t.collideWith(e)&&(i=!0)}while(i);this.add(t,e)}}randomObstacles(t,e,s){const i=Math.floor(s.nextFloat()*(e+1));for(let e=0;e<i;e++){let e,i=!1;do{let r=this.randomXy(t.px,t.py,s),n=20+30*s.nextFloat();const o=Math.round(3+10*s.nextFloat()),a=[];for(let t=0;t<o;t++){const e=n*Math.cos(2*Math.PI/o*t),s=n*Math.sin(2*Math.PI/o*t);a.push([r[0]+e,r[1]+s])}e=new v.JA(new P.OI(a)),i=!1;for(let t of this.tree.find(r,n))t.collideWith(e)&&(i=!0)}while(i);this.add(t,e)}}randomClouds(t,e,s){const i=Math.floor(s.nextFloat()*(e+1));for(let e=0;e<i;e++)this.add(t,new v.ZJ(this.randomXy(t.px,t.py,s),s))}removePart(t){t.entities.forEach((e=>this.remove(t,e,!1))),t.entities=[];const e=this.parts.get(t.px);void 0!==e&&(e.delete(t.py),0==e.size&&this.parts.delete(t.px))}remove(t,e,s){if(s){const s=t.entities.indexOf(e);if(s<0)throw new Error("Can't remove non-existing entity");t.entities.splice(s,1)}t.random=!1,e.setGame(null),this.tree.remove(e.xy,e.linearSize(),e),this.byId.delete(e.id)}getPartByXy(t){const e=Math.floor(t[0]/this._visibleSize),s=Math.floor(t[1]/this._visibleSize),i=this.getPart(e,s,!1);return null===i?null:i[0]}getOrCreatePart(t,e){const s=this.getPart(t,e,!0);if(null===s)throw new Error("Part must be gotten or created: "+t+NaN+e);return s}getPart(t,e,s){let i=this.parts.get(t);void 0===i&&this.parts.set(t,i=new Map);let r=i.get(e);return void 0===r?s?(r={entities:[],random:!0,px:t,py:e},i.set(e,r),[r,"new"]):null:[r,"existing"]}add(t,e){if(this.byId.has(e.id))throw new Error("Entity with the id already exists: "+e.id);this.byId.set(e.id,e),e.setGame(this.game),this.tree.insert(e.xy,e.linearSize(),e),t.entities.push(e),t.entities.sort(((t,e)=>t.layer>e.layer?1:t.layer==e.layer?0:-1))}}var A=s(32),O=localStorage.missilesIdentity;function F(t){O=t,localStorage.missilesIdentity=t}const B={get:function(){return new Promise((t=>{if(O)return void t(O);const e=new XMLHttpRequest;e.open("POST","https://api.random.org/json-rpc/2/invoke"),e.onreadystatechange=function(){if(4===e.readyState)if(e.status.toString().startsWith("2")){let s;try{s=JSON.parse(e.responseText).result.random.data[0]}catch(t){s=(0,A.h)()}s&&(F(s),t(O))}else F((0,A.h)()),t(O)},e.setRequestHeader("Content-Type","application/json"),e.setRequestHeader("Accept","application/json"),e.send(JSON.stringify({jsonrpc:"2.0",method:"generateUUIDs",params:{apiKey:"c39b179c-7559-4512-8db3-6cfccd63c748",n:1},id:1}))}))},set:F};function N(t,e,s=0){let i;null===s?i=0:"number"==typeof s?i=s:(i=t.indexOf(s),i<0&&(i=0));const r=[],n=m.snapshot();m.resetToRoot(),m.key("ArrowUp",[],"Up",(()=>{i=(i+r.length-1)%r.length,r[i].onmouseover({target:r[i]})})),m.key("ArrowDown",[],"Down",(()=>{i=(i+1)%r.length,r[i].onmouseover({target:r[i]})}));const o=()=>r[i].onclick({target:r[i]});m.key("Enter",[],"Select",o),m.key("Space",[],"Select",o),m.key("Escape",[],"Exit",(()=>{r[i].onclick(null)}));let a=document.createElement("div");a.classList.add("modal");let l=document.createElement("div");l.classList.add("menu");for(let s=0;s<t.length;s++){const o=t[s];let h=document.createElement("a");h.innerText=o.name,h.onmouseover=t=>{[...l.querySelectorAll(".hover")].forEach((t=>t.classList.remove("hover"))),t.target.classList.add("hover")},h.onclick=t=>{a.remove(),l.remove(),m.restoreFromSnapshot(n),null!==t?o.selected(o):e()},s==i&&h.classList.add("hover"),l.appendChild(h),r.push(h)}document.body.appendChild(a),document.body.appendChild(l)}function R(t){const e=G(new V(t));return t=>e.map((e=>e.eval(t))).join("")}class D{}class L extends D{value;constructor(t){super(),this.value=t}eval(t){return this.value}}class U extends D{varName;optional=!1;constructor(t){super(),this.varName=t,this.varName.endsWith("?")&&(this.varName=this.varName.substr(0,this.varName.length-1),this.optional=!0)}eval(t){if(t.has(this.varName))return t.get(this.varName);const e=this.varName.split(".");if(1==e.length){if(this.optional)return"";throw new Error("Var is not defined: "+this.varName)}if(!t.has(e[0])){if(this.optional)return"";throw new Error("Var is not defined: "+this.varName)}let s=t.get(e[0]);for(let t=1;t<e.length;t++){const i=s[e[t]];if(void 0===i){if(this.optional)return"";throw new Error("Var is not defined: "+this.varName)}s=i}return s}}class $ extends D{varName;arrayVarNode;body;constructor(t,e,s){super(),this.varName=t,this.arrayVarNode=e,this.body=s}eval(t){let e="";const s=new Map(t),i=this.arrayVarNode.eval(t);for(const t of i)s.set(this.varName,t),e+=this.body.map((t=>t.eval(s))).join("");return e}}class j extends D{node;value;body;constructor(t,e,s){super(),this.node=t,this.value=e,this.body=s}eval(t){return this.node.eval(t)==this.value.eval(t)?this.body.map((e=>e.eval(t))).join(""):""}}class V{_s;_pos;_captured=null;constructor(t,e=0){this._s=t,this._pos=e}get captured(){if(null===this._captured)throw new Error("Nothing captured");return this._captured}captureUntil(t){const e=this._s.indexOf(t,this._pos);if(-1==e)return this._captured=this._s.substr(this._pos),this._pos=this._s.length,!1;const s=e-this._pos;return this._captured=s>0?this._s.substr(this._pos,s):"",this._pos=e+t.length,!0}hasMore(){return this._pos<this._s.length}}function G(t){const e=[];for(;t.hasMore();){let s=t.captureUntil("{{");if(t.captured&&e.push(new L(t.captured)),!s)break;if(s=t.captureUntil("}}"),!s)throw new Error("No closing }} found: "+t);const i=t.captured;if(":end"==i)break;if(i.startsWith(":for")){const s=i.match(/^:for\s+([^: ]+):([^: ]+)$/);if(!s)throw new Error("Bad :for: "+t);const r=s[1],n=s[2],o=G(t);e.push(new $(r,new U(n),o))}else if(i.startsWith(":if")){const s=i.match(/^:if\s+([^: ]+)\s*=\s*([^: ]+)$/);if(!s)throw new Error("Bad :for: "+t);const r=s[1],n=s[2],o=G(t),a=n.match('^".*"$')?new L(n.substr(1,n.length-2)):new U(n);e.push(new j(new U(r),a,o))}else e.push(new U(i))}return e}class K{ta=void 0;listeners=new Map;attach(t){void 0!==this.ta&&this.detach(),this.ta=t,m.off(),this.doAttach()}detach(){if(void 0===this.ta)throw new Error("Detached");const t=this.ta;this.listeners.forEach(((e,s)=>e.forEach((e=>t.removeEventListener(s,e))))),m.on(),this.ta=void 0}cursorPos(){if(void 0===this.ta)throw new Error("Detached");return"forward"===this.ta.selectionDirection?this.ta.selectionStart:this.ta.selectionEnd}getSelection(){if(void 0===this.ta)throw new Error("Detached");return"forward"===this.ta.selectionDirection?{startPos:this.ta.selectionStart,endPos:this.ta.selectionEnd}:{startPos:this.ta.selectionEnd,endPos:this.ta.selectionStart}}setSelection(t){if(void 0===this.ta)throw new Error("Detached");this.ta.selectionStart=t.startPos,this.ta.selectionEnd=t.endPos,this.ta.selectionDirection="forward"}moveCursorTo(t){if(void 0===this.ta)throw new Error("Detached");this.ta.setSelectionRange(t,t)}isAttached(){return void 0!==this.ta}listener(t,e){if(void 0===this.ta)throw new Error("Detached");this.ta.addEventListener(t,e);let s=this.listeners.get(t);return void 0===s&&this.listeners.set(t,s=[]),s.push(e),e}}class W extends K{tokenizer=new H;constructor(){super()}doAttach(){this.listener("keydown",(t=>{this.onKeyDown(t)})),this.listener("keyup",(t=>{this.onKeyUp(t)}))}timerId;onKeyUp(t){void 0!==this.timerId&&(window.clearTimeout(this.timerId),this.timerId=void 0),"."==t.key&&(this.timerId=window.setTimeout((()=>this.trySuggest()),500))}onKeyDown(t){" "==t.key&&t.ctrlKey&&(t.preventDefault(),this.trySuggest())}trySuggest(){if(void 0===this.ta)throw new Error("Detached");const t=this.ta,e=this.suggest();e&&this.showSuggestions(e,(e=>{t.setRangeText(e),this.moveCursorTo(this.cursorPos()+e.length)}),"")}static suggestions;static initSuggestions(){W.suggestions=new Map([["api()",["posOf()","playerHas()","playerSet()","playerRemove()","teleport()","missileFrom()","after()","move()","showText()","forPlayer()","putText()","remove()"]],["move()",["speed()","slow()","fast()","ease()","linear()","up()","down()","left()","right()","offset()","to()"]],["then()",["playerSet()","playerRemove()","teleport()","missileFrom()","after()","move()","showText()","putText()","remove()"]],["after()",["playerSet()","playerRemove()","teleport()","missileFrom()","move()","showText()","putText()","remove()"]],["forPlayer()",["playerSet()","playerRemove()","teleport()","missileFrom()","move()","showText()","after()","putText()","remove()"]]]);for(const t of["offset","to","up","down","left","right","teleport","missileFrom","showText","playerSet","playerRemove","putText","remove"])W.suggestions.set(t+"()",["end()","then()","loop()"])}suggest(){if(void 0===this.ta)throw new Error("Detached");const t=this.tokenizer.tokenLeft(this.ta.value,this.cursorPos()-1);switch(t.type){case".":{let e=t.value.replace(/^(.+)\(.*\)$/,"$1()");return W.suggestions.get(e)||[]}}return[]}showSuggestions(t,e,s){if(void 0===this.ta)throw new Error("Detached");if(0==t.length)return e("");if(1==t.length)return e(t[0]);const i=document.createElement("div");i.classList.add("suggestions"),i.style.position="absolute",i.style.zIndex="10000";const r=this.ta.getBoundingClientRect(),{left:n,top:o}=getCaretCoordinates(this.ta,this.cursorPos());i.style.left=r.x+n+"px",i.style.top=r.y+o+"px";let a=0;const l=[];for(let e=0;e<t.length;e++){const s=t[e],r=document.createElement("div");l.push(r),r.classList.add("line"),a==e&&r.classList.add("selected"),r.innerText=s,i.appendChild(r)}document.body.appendChild(i);const h=t=>{l[a].classList.remove("selected"),a=t,l[a].classList.add("selected")},c=r=>{if(r.preventDefault(),r.key.match(/^[a-zA-Z]$/)){s+=r.key;for(let e=0;e<t.length;e++){if(t[e].startsWith(s)){h(e);break}}}else s="","ArrowUp"==r.key?h((a+t.length-1)%t.length):"ArrowDown"==r.key?h((a+1)%t.length):"Enter"==r.key?(document.body.removeEventListener("keydown",c),i.remove(),e(t[a])):"Escape"==r.key&&(document.body.removeEventListener("keydown",c),i.remove(),e(""))};document.body.addEventListener("keydown",c)}}class H{constructor(){}tokenLeft(t,e){let s;for(s=e;s>=0&&!t[s].match(/[^ \n]/);s--);return"."==t[s]?{type:".",value:this.scanLeft(t,s-1)}:{type:"unknown",value:""}}scanLeft(t,e){let s="",i=e;for(;i>=0&&!t[i].match(/[^ \n]/);i--);for(;i>=0;i--)if('"'==t[i]){for(;i>=0&&'"'!=t[i];i--)s=t[i]+s;i>=0&&(s=t[i]+s)}else if(")"==t[i]){for(;i>=0&&"("!=t[i];i--)s=t[i]+s;i>=0&&(s=t[i]+s)}else{if(!t[i].match(/[^.\n \t]/))break;s=t[i]+s}return s}}W.initSuggestions();class X extends K{autocomplete;defaultIndent=2;constructor(t=new W){super(),this.autocomplete=t}attach(t){super.attach(t),this.autocomplete.attach(t)}detach(){super.detach(),this.autocomplete.detach()}doAttach(){this.listener("keydown",(t=>{"Tab"==t.key&&(t.shiftKey?(t.preventDefault(),this.indentSelected()):(t.preventDefault(),this.unindentSelected()))})),this.listener("keypress",(t=>{if(void 0===this.ta)throw new Error("Detached");if("Enter"===t.key){t.preventDefault();const e=this.cursorPos(),s=this.getCurrentLineIndent();this.ta.value=this.ta.value.substr(0,e)+"\n"+" ".repeat(s)+this.ta.value.substr(e),this.moveCursorTo(e+s+1)}}))}unindentSelected(){const t=this.getSelectedLines();this.selectLines(t),this.modifyLines(t,(t=>" ".repeat(this.defaultIndent)+t))}indentSelected(){const t=this.getSelectedLines();this.modifyLines(t,(t=>t.replace(new RegExp("^ {0,"+this.defaultIndent+"}"),"")))}selectLines(t){if(0==t.length)return;const e=t.reduce(((t,e)=>t+e.length+1),t[0].startPos);this.setSelection({startPos:t[0].startPos,endPos:e})}modifyLines(t,e){let s=0;const i=[];for(let r of t){const t=this.modifyLine({startPos:r.startPos+s,length:r.length},e);i.push(t),s+=t.length-r.length}}modifyLine(t,e){if(void 0===this.ta)throw new Error("Detached");const s=this.cursorPos(),i=(this.getSelection(),this.ta.value.substr(t.startPos,t.length)),r=e(i);if(i!=r){this.ta.value=this.ta.value.substr(0,t.startPos)+r+this.ta.value.substr(t.startPos+t.length);const e=r.length-i.length;return this.moveCursorTo(s+e),{startPos:t.startPos,length:t.length+e}}return t}getSelectedLines(){const{startPos:t,endPos:e}=this.getSelection(),s=[];for(let i=t;i<=e;){const t=this.getLineAt(i);s.push(t),i=t.startPos+t.length+1}return s}getCurrentLine(){return this.getLineAt(this.cursorPos())}getLineAt(t){if(void 0===this.ta)throw new Error("Detached");let e=t-1;for(;e>=0&&"\n"!==this.ta.value[e];)e--;const s=e+1;for(e=t;e<this.ta.value.length&&"\n"!==this.ta.value[e];)e++;return{startPos:s,length:e-s}}getCurrentLineIndent(){if(void 0===this.ta)throw new Error("Detached");const t=this.getCurrentLine(),e=this.ta.value.substr(t.startPos,t.length).match(/^( +)/);return e?e[1].length:0}}class J{_changeable=!0;changeable(){return this._changeable}setChangeable(t){this._changeable=t}}class q extends J{_name;_items;_selected;constructor(t,e,s){super(),this._name=t,this._items=e,this._selected=s}get items(){return this._items}get(){return this._selected}name(){return this._name}set(t){this._selected=t}type(){return"drop-down"}}class Y extends J{_name;_value;constructor(t,e){super(),this._name=t,this._value=e}get(){return this._value}name(){return this._name}set(t){this._value=t.toString()}type(){return"text"}}const Q="first-game",tt=new class{baseUrl;version;constructor(t,e="v1"){this.baseUrl=t,this.version=e}put(t,e){return new Promise(((s,i)=>{var r=new XMLHttpRequest;r.open("PUT",`${this.baseUrl}/${this.version}${t}.json`),r.onreadystatechange=()=>{4===r.readyState&&(r.status.toString().startsWith("2")?s(JSON.parse(r.responseText)):i(r))},r.setRequestHeader("Content-Type","application/json"),r.setRequestHeader("Accept","application/json"),r.send(e)}))}delete(t){return new Promise(((e,s)=>{var i=new XMLHttpRequest;i.open("DELETE",`${this.baseUrl}/${this.version}${t}.json`),i.onreadystatechange=()=>{4===i.readyState&&(i.status.toString().startsWith("2")?e(JSON.parse(i.responseText)):s(i))},i.setRequestHeader("Accept","application/json")}))}getString(t,e){return new Promise(((s,i)=>{var r=new XMLHttpRequest;r.open("GET",`${this.baseUrl}/${this.version}${t}.json`+(e?"?shallow=true":"")),r.onreadystatechange=()=>{4===r.readyState&&(r.status.toString().startsWith("2")?s(r.responseText):i(r))},r.setRequestHeader("Accept","application/json"),r.send()}))}get(t,e){return this.getString(t,e).then((t=>JSON.parse(t)))}load(t){return this.get(t,!1)}loadString(t){return this.getString(t,!1)}saveString(t,e){return this.put(t,e).then()}deleteString(t){return this.delete(t).then()}loadKeys(t){return this.get(t,!0).then((t=>null!=t?Object.keys(t):[]))}}("https://missiles-e8ad3.firebaseio.com");class et{ctx;localMode;userId;gameState="not started";masterGameNode=!1;frameCallback=null;gameOverCallback=null;newGameCallback=null;paused=!1;flies;fliesById;fliesToAddAfterTick;overlays=[];triggers=[];inbetween=!1;lastT;timeScale;boosterIsUsed;globalTime;rotationDirection;fakeTargetTimerId;outOfRange;fps;plane;level;gameMap;radarCtx=null;gameSeed=Q;constructor(t,e=!0,s){this.ctx=t,this.localMode=e,this.userId=s,this.init()}startFromTheBeginning(){this.gameState="in progress",this.paused=!0,y.Z.clearAll(),this.flies=[],this.fliesById=new Map,this.fliesToAddAfterTick=[],this.overlays=[],this.triggers=[],this.inbetween=!1,this.lastT=null,this.timeScale=1,this.boosterIsUsed=!1,this.globalTime=0,this.rotationDirection=null,this.fakeTargetTimerId=null,this.outOfRange=!1,this.fps=0,this.plane=new v.JO(i.T.planeStartPos),this.plane.subscribe((t=>this.onPlaneEvent(t))),this.userId&&(this.plane.id=this.userId),this.level=new b,this.recreateGameMap(200,1500,Q),this.gameMap.deleteAllCustomContent(),this.addEntity(this.plane),this.level.init(this),f.Z.init(this),this.resume()}onPlaneEvent(t){t instanceof v.$7&&(t.amount>0&&this.achievement(i.t`${i.T.life} +${t.amount}`,i.T.lifeColor,2e3,t.target),null!==t.target&&t.target.lifes<=0&&this.explosionFor(t.target)),t instanceof v.gF&&t.amount>0&&t.target&&t.target.addInfo("fake targets",(()=>i.t`${i.T.fakeTarget} +${t.amount}`),3e3,i.T.fakeTargetColor),t instanceof v.qF&&t.amount>0&&t.target&&t.target.addInfo("booster",(()=>i.t`${i.T.booster} +${Math.round(t.amount/1e3)}`),3e3,i.T.boosterColor)}achievement(t,e,s,i){this.addEntity(new v.PE((i||this.plane).xy,t,e,s))}addInfo(t,e,s,i){this.plane.addInfo(t,e,s,i)}removeInfo(t){this.plane.removeInfo(t)}addEntity(t){if(t instanceof v.MB)throw new Error("Static entities can't be added here");t.setGame(this),this.inbetween?this.fliesToAddAfterTick.push(t):(this.flies.push(t),this.fliesById.set(t.id,t),this.sort())}teleportTo(t){this.plane.xy=t,this.gameMap.iAmHere(this.plane.xy).then((()=>console.log("teleported",t[0],t[1])))}addNewFlies(){this.fliesToAddAfterTick.length>0&&(this.fliesToAddAfterTick.forEach((t=>{this.flies.push(t),this.fliesById.set(t.id,t)})),this.sort(),this.fliesToAddAfterTick=[])}sort(){this.flies.sort(((t,e)=>t.layer>e.layer?1:t.layer==e.layer?0:-1))}addTrigger(t){this.triggers.push(t)}addOverlay(t){return this.overlays.push(t),()=>{const e=this.overlays.indexOf(t);e>=0&&this.overlays.splice(e,1)}}init(){var t,e;m.resetToRoot(),m.push(),t=()=>this.pause(),e=()=>this.resume(),m.key("F1",[],i.t`Show this help message (F1 again to hide)`,(()=>{t&&t();const s=document.getElementById("help");let r;const n=()=>{m.restoreFromSnapshot(r),s.style.display="none",e&&e()};if("block"==s.style.display)return void n();let o=m.help();r=m.snapshot(),m.resetToRoot(),m.key("Escape",[],i.t`Hide help message`,(()=>n())),m.key("F1",[],i.t`Hide help message`,(()=>n())),s.innerHTML="<h2>"+i.t`Keyboard`+"</h2>\n<pre>"+o.keys.join("\n</pre><pre>")+"</pre>",s.style.display="block"})),m.key("ArrowRight",[],i.t`Turn right`,(()=>{this.rotationDirection="right",this.plane.right()}),(()=>{"right"==this.rotationDirection&&this.plane.noRotate()})),m.key("ArrowLeft",[],i.t`Turn left`,(()=>{this.rotationDirection="left",this.plane.left()}),(()=>{"left"==this.rotationDirection&&this.plane.noRotate()})),m.key("KeyF",[],i.t`Fast/Unfast`,(()=>{this.timeScale<1?this.timeScale=1:this.timeScale=Math.max(this.timeScale/1.8,.01)})),m.key("KeyS",[],i.t`Slowmo/Unslowmo`,(()=>{this.timeScale>1?this.timeScale=1:this.timeScale=Math.min(2.5*this.timeScale,10)})),m.key("ArrowUp",[],i.t`Boost/Unboost`,(()=>{this.boosterIsUsed?(this.plane.maxVelocity=.1,this.plane.stopBoost()):(this.plane.maxVelocity=this.plane.booster>0?.15:.1,this.plane.startBoost()),this.boosterIsUsed=!this.boosterIsUsed})),m.key("ArrowDown",[],i.t`Unboost`,(()=>{this.boosterIsUsed&&(this.plane.maxVelocity=.1,this.plane.stopBoost(),this.boosterIsUsed=!1)})),m.key("Escape",[],i.t`Show Menu`,(()=>this.mainMenu())),m.key("KeyP",[],i.t`Pause`,(()=>{"in progress"===this.gameState&&(this.pause(),T(i.t`Paused`,(()=>this.resume())))})),m.key("Space",[],i.t`Launch fake targets`,(()=>this.launchFakeTarget()))}mainMenu(t=0){this.pause();const e={name:"Continue",selected:()=>this.resume()},s={name:"Save Game",selected:t=>{this.getSavedGames().then((e=>{const s=t=>this.saveGame(t).then((()=>T("Saved",(()=>this.resume())))),i={name:"New ...",selected:()=>{const t=window.prompt("Name");if(!t)return n();s(t)}},r=e.map((t=>({name:t,selected:t=>s(t.name)})));r.push(i);const n=()=>N(r,(()=>this.mainMenu(t)));n()}))}},i={name:"Load Game",selected:t=>{this.getSavedGames().then((e=>{if(0==e.length)return T("No Saved Games",(()=>this.mainMenu(t)));N(e.map((t=>({name:t,selected:t=>this.loadGame(t.name).then((()=>{T("Loaded",(()=>this.resume()))}))}))),(()=>this.mainMenu(t)))}))}},r={name:"New Game",selected:()=>{"in progress"===this.gameState?this.gameOver(0,!0):this.startFromTheBeginning()}},n={name:"User ID",selected:t=>{B.get().then((e=>{const s=new Y("Current ID",e);s.setChangeable(!1);const i=new Y("New ID","");var r;(r=[s,i],new Promise((t=>{const e=m.snapshot();m.resetToRoot();const s=R(document.getElementById("formTemplate").innerHTML);let i=document.createElement("div");i.classList.add("modal");const n=document.createElement("div"),o=r.map((t=>{const e={type:t.type(),name:t.name(),changeable:t.changeable()?"true":"false"};return t instanceof q&&(e.items=t.items.map((t=>({value:t,name:t})))),e})),a=new Map([["fields",o],["ok","okBtn"],["cancel","cancelBtn"]]);n.innerHTML=s(a),document.body.appendChild(i),document.body.appendChild(n);let l=[],h=!1;for(let t of r)switch(t.type()){case"boolean":document.getElementById("formField_"+t.name()).checked=t.get();break;case"text":case"textarea":case"js":const e=document.getElementById("formField_"+t.name());if(e.value=t.get().toString(),"js"===t.type()){const t=new X;l.push(t),e.addEventListener("focus",(()=>t.attach(e))),e.addEventListener("blur",(()=>t.detach()))}!h&&e.focus(),h=!0;break;case"drop-down":const s=document.getElementById("formField_"+t.name()),i=t.items;s.selectedIndex=i.indexOf(t.get()),-1===s.selectedIndex&&(s.selectedIndex=0);break;default:throw new Error("Unsupported field type: "+t.type())}const c=()=>{l.forEach((t=>t.isAttached()&&t.detach())),document.body.removeChild(n),document.body.removeChild(i),m.restoreFromSnapshot(e)};document.getElementById("okBtn").onclick=()=>{for(let t of r)if(t.changeable())switch(t.type()){case"boolean":t.set(document.getElementById("formField_"+t.name()).checked);break;case"text":case"textarea":case"js":t.set(document.getElementById("formField_"+t.name()).value);break;case"drop-down":const e=document.getElementById("formField_"+t.name());t.set(e.options[e.selectedIndex].value);break;default:throw new Error("okBtn: Unsupported field type: "+t.type())}c(),t(!0)};const d=()=>{c(),t(!1)};m.key("Escape",[],"Cancel",(t=>d())),document.getElementById("cancelBtn").onclick=d}))).then((e=>{if(!e)return this.mainMenu(t);B.set(i.get()),T("User ID applied",(()=>this.mainMenu(t)))}))}))}};let o=[];switch(this.gameState){case"in progress":o=[e,s,i,r,n];break;case"game over":case"not started":o=[i,r,n];break;default:throw new Error("Unknown gameState: "+this.gameState)}N(o,(()=>"in progress"===this.gameState?this.resume():this.mainMenu()),t)}frame(t){if(this.paused)return;if(this.gameMap.iAmHere(this.plane.xy),!this.gameMap.isPartAvailableForXy(this.plane.xy))return void requestAnimationFrame((t=>this.frame(t)));this.inbetween=!0,null===this.lastT&&(this.lastT=t);let e=t-this.lastT;y.Z.progress(e),this.fps=e>0?(100*this.fps+1e3/e)/101:0,e/=this.timeScale,this.lastT=t,this.globalTime+=e,this.level.progress(e),this.updateBooster(e),this.progress(e),this.detectCollision(),this.triggers.forEach((t=>t(e))),this.removeDead(),this.addNewFlies(),this.draw(),this.frameCallback&&this.frameCallback(),requestAnimationFrame((t=>this.frame(t))),this.inbetween=!1}updateBooster(t){this.boosterIsUsed&&(this.plane.booster-=t,this.plane.booster<=0&&(this.plane.booster=0,this.boosterIsUsed=!1,this.plane.maxVelocity=.1,this.plane.stopBoost()))}progress(t){const e=e=>e.progress(t);for(let t of this.flies)e(t);for(let t of this.gameMap.all())e(t)}detectCollision(){if(this.localMode||this.masterGameNode)for(let t=0;t<this.flies.length;t++){const e=this.flies[t];for(let s=t+1;s<this.flies.length;s++){const t=this.flies[s];this.tryCollide(e,t)}for(const t of this.gameMap.find(e.xy,e.linearSize()))this.tryCollide(e,t)}}tryCollide(t,e){if(t!==e&&!(t instanceof v.JA&&e instanceof v.JA)&&t.collideWith(e)){if(t instanceof v.JO&&e instanceof v.JO)return t.lifes=1,e.lifes=1,t.lifes-=1,void(e.lifes-=1);if(t instanceof v.JO||e instanceof v.JO){const s=t instanceof v.JO?e:t,i=t instanceof v.JO?t:e;if(s instanceof v.Hs)return void s.collected(i);s instanceof v.JA?i.lifes=1:this.explosionFor(s),i.lifes-=1}else t instanceof v.Cp&&this.level.onDeadMissile(t),e instanceof v.Cp&&this.level.onDeadMissile(e),t instanceof v.JA||this.explosionFor(t),e instanceof v.JA||this.explosionFor(e)}}removeDead(){const t=[];for(const e of this.gameMap.all())e.dead&&t.push(e);t.length>0&&t.forEach((t=>this.gameMap.removeEntity(t)));const e=this.flies.filter((t=>t.dead));if(e.length>0){let t=!1;e.forEach((e=>{e===this.plane&&(t=!0),this.flies.splice(this.flies.indexOf(e),1).forEach((t=>{t.setGame(null),this.fliesById.delete(t.id)}))})),t&&this.gameOver()}}gameOver(t,e=!1){this.gameMap.saveChanged().then((()=>{null!==this.gameOverCallback&&this.gameOverCallback();const s=setTimeout((()=>{this.pause(),this.gameState="game over",T(i.t`Game Over`,(()=>{clearTimeout(s),null!==this.newGameCallback?this.newGameCallback():e?this.startFromTheBeginning():this.mainMenu()}))}),void 0!==t?t:2e3)}))}explosionFor(t){t.dead=!0,this.addEntity(new v.OQ(t.xy,t instanceof v.JO?5:1))}draw(){this.ctx.fillStyle=this.outOfRange?i.T.skyOutOfRangeColor:i.T.skyColor,this.ctx.fillRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.overlays.forEach((t=>{this.ctx.save(),t.drawPre(this.ctx),this.ctx.restore()})),this.ctx.save(),this.ctx.translate(-this.plane.xy[0]+this.ctx.canvas.width/2,-this.plane.xy[1]+this.ctx.canvas.height/2),this.flies.forEach((t=>{this.ctx.save(),t.draw(this.ctx),this.ctx.restore()}));for(const t of this.gameMap.all())this.ctx.save(),t.draw(this.ctx),this.ctx.restore();this.overlays.forEach((t=>{this.ctx.save(),t.drawOverMap(this.ctx),this.ctx.restore()})),this.ctx.restore(),this.ctx.save(),this.drawScore(this.ctx),this.ctx.restore(),this.ctx.save(),this.drawRadar(this.ctx),this.ctx.restore(),this.ctx.save(),this.overlays.forEach((t=>{this.ctx.save(),t.drawPost(this.ctx),this.ctx.restore()})),this.ctx.restore()}drawScore(t){const e=14*1.1;let s=e;t.font="14px serif",t.fillStyle="black",t.fillText("FPS: "+Math.round(this.fps),0,s),s+=e,t.fillStyle=i.T.timeColor,t.fillText(i.t`${i.T.time} ${Math.round(this.globalTime/1e3)}`,0,s),s+=e,t.fillStyle=i.T.scoreColor,t.fillText(i.t`${i.T.score} ${this.plane.score}`,0,s),s+=e,t.fillStyle=i.T.fakeTargetColor,t.fillText(i.t`${i.T.fakeTarget} ${this.plane.fakeTargets}`,0,s),s+=e,t.fillStyle=i.T.boosterColor,t.fillText(i.t`${i.T.booster} ${Math.round(this.plane.booster/1e3)}`,0,s),s+=e,t.fillStyle=i.T.lifeColor,t.fillText(i.t`${i.T.life} ${this.plane.lifes}`,0,s)}drawRadar(t){const e=i.T.radarSize,s=i.T.radarScale;if(null===this.radarCtx){const t=document.createElement("canvas");t.width=2*e+5,t.height=2*e+5,this.radarCtx=t.getContext("2d")}if(null===this.radarCtx)return;const r=this.radarCtx,n=r.canvas.width,o=r.canvas.height;r.save(),r.clearRect(0,0,n,o);const a=t.canvas.height/t.canvas.width;r.scale(1,a);const l=n/2,h=o/2;r.fillStyle=i.T.radarFillColor,r.strokeStyle=i.T.radarStrokeColor,r.beginPath(),r.arc(l,h,e,0,2*Math.PI),r.fill(),r.beginPath(),r.arc(l,h,e,0,2*Math.PI),r.stroke(),r.strokeStyle=i.T.radarSectorColor;for(let t=0;t<6;t++){r.beginPath(),r.moveTo(l,h);const s=2*Math.PI/6*t;r.lineTo(l+Math.cos(s)*e,h+Math.sin(s)*e),r.stroke()}r.beginPath(),r.arc(l,h,e,0,2*Math.PI),r.clip(),r.strokeStyle=i.T.radarVisibilityAreaColor,r.beginPath(),r.arc(l,h,t.canvas.height/2/s,0,2*Math.PI),r.stroke(),r.scale(1/s,1/s),r.translate(-this.plane.xy[0],-this.plane.xy[1]),r.translate(n/2*s,o/2*s);r.strokeStyle=i.T.radarPlaneColor,r.lineWidth=s,r.beginPath(),r.moveTo(this.plane.xy[0],this.plane.xy[1]-3*s/a),r.lineTo(this.plane.xy[0],this.plane.xy[1]+3*s/a),r.moveTo(this.plane.xy[0]-3*s,this.plane.xy[1]),r.lineTo(this.plane.xy[0]+3*s,this.plane.xy[1]),r.stroke();for(const t of this.gameMap.all())r.save(),r.globalAlpha=.4,t.draw(r),r.restore();for(let t of this.flies)r.save(),t!==this.plane&&t instanceof v.JO?(r.strokeStyle=i.T.radarEnemyColor,r.beginPath(),r.moveTo(t.xy[0]-3*s,t.xy[1]),r.lineTo(t.xy[0]+3*s,t.xy[1]),r.moveTo(t.xy[0],t.xy[1]-3*s/a),r.lineTo(t.xy[0],t.xy[1]+3*s/a),r.stroke()):(t instanceof v.Cp||t instanceof v.Hs)&&(r.fillStyle=t instanceof v.Cp?i.T.radarMissileColor:i.T.radarPerkColor,r.beginPath(),r.ellipse(t.xy[0],t.xy[1],2*s,2*s/a,0,0,2*Math.PI),r.fill()),r.restore();r.restore(),t.globalAlpha=i.T.radarAlpha,t.drawImage(r.canvas,t.canvas.width-2*e-10,10)}pause(){"in progress"!==this.gameState||this.paused||(this.paused=!0,this.gameMap.saveChanged())}resume(){this.paused&&(this.lastT=null,this.paused=!1,requestAnimationFrame((t=>this.frame(t))))}launchFakeTarget(){if(this.plane.fakeTargets<=0)return;if(!this.fakeTargetTimerId)return this.fakeTargetTimerId=y.Z.set((()=>{this.plane.hideFakeTargetRadius(),this.fakeTargetTimerId=null}),2e3),void this.plane.showFakeTargetRadius(i.T.fakeTargetRadius);this.plane.fakeTargets-=1;const t=new v.jA(this.plane);this.addEntity(t)}saveGame(t){return B.get().then((e=>{const s=Object.assign(new st,{flies:this.flies,level:this.level,planeId:this.plane.id,boosterIsUsed:this.boosterIsUsed,globalTime:this.globalTime,lastT:this.lastT,rotationDirection:this.rotationDirection,statics:this.gameMap.partsStore.backend.snapshot(Q)});return tt.saveString(`/saves/${encodeURIComponent(e)}/${encodeURIComponent(t)}`,w.Z.serialize(s))}))}loadGame(t){return B.get().then((e=>{tt.loadString(`/saves/${encodeURIComponent(e)}/${encodeURIComponent(t)}`).then((t=>{w.Z.unserializeWithLinks((()=>{const e=w.Z.unserialize(t);y.Z.clearAll(),this.recreateGameMap(200,1500,Q),this.flies=[],this.fliesById=new Map,this.fliesToAddAfterTick=[],this.overlays=[],this.triggers=[],this.inbetween=!1,this.lastT=e.lastT,this.timeScale=1,this.boosterIsUsed=e.boosterIsUsed,this.globalTime=e.globalTime,this.rotationDirection=e.rotationDirection,this.fakeTargetTimerId=null,this.outOfRange=!1,this.fps=0,this.level=e.level,e.flies.forEach((t=>this.addEntity(t))),this.plane=this.fliesById.get(e.planeId),this.plane.subscribe((t=>this.onPlaneEvent(t))),this.level.init(this),this.gameMap.partsStore.backend.restoreFromSnapshot(Q,e.statics),this.gameMap.deleteAllCustomContent(),this.paused=!0,f.Z.init(this),this.gameState="in progress"}),(()=>[this.fliesById,new Map([["game",this]])]))}))}))}getSavedGames(){return B.get().then((t=>tt.loadKeys(`/saves/${encodeURIComponent(t)}`)))}recreateGameMap(t,e,s){this.gameMap=new Z(this,t,e,s,new I(new z(tt),new k))}}class st{static __type="GameState";level;planeId;rotationDirection;globalTime;boosterIsUsed;lastT;flies;statics;__serialize(){return{level:w.Z.toPojo(this.level),planeId:this.planeId,rotationDirection:this.rotationDirection,globalTime:this.globalTime,boosterIsUsed:this.boosterIsUsed,lastT:this.lastT,flies:w.Z.toPojo(this.flies),statics:w.Z.toPojo(this.statics)}}__unserialize(t){this.level=w.Z.unserialize(t.level),this.planeId=t.planeId,this.rotationDirection=t.rotationDirection,this.globalTime=t.globalTime,this.boosterIsUsed=t.boosterIsUsed,this.lastT=t.lastT,this.flies=w.Z.unserialize(t.flies),this.statics=t.statics}}w.Z.registerConstructor(st.__type,(t=>new st)),setTimeout((function(){const t=document.getElementById("canvas"),e=t.getContext("2d");m.init(t);const s=()=>{t.width=window.innerWidth,t.height=window.innerHeight,t.style.position="fixed",t.style.left="0",t.style.top="0"};window.addEventListener("resize",s),s(),new et(e).mainMenu()}),1)},134:(t,e,s)=>{s.d(e,{JO:()=>p,$7:()=>m,gF:()=>f,Vz:()=>y,qF:()=>v,jA:()=>x,Cp:()=>w,MB:()=>b,Hs:()=>_,Vk:()=>T,Ux:()=>S,OQ:()=>P,JA:()=>M,ZJ:()=>C,PE:()=>k});var i=s(917),r=s(751),n=s(464),o=s(925),a=s(32),l=s(485),h=s(165);class c{static idPrefix=(0,a.h)();static idIndex=0;static __type="Entity";game=null;xy;dead;layer;id;attributes;infoItems;constructor(t){this.xy=n.Z.clone(t),this.dead=!1,this.layer=0,this.id=c.generateNewId(),this.infoItems=new Map}static generateNewId(){return c.idPrefix+"-"+c.idIndex++}setGame(t){this.game=t}getGame(){return this.game}__serialize(){return{xy:this.xy,dead:this.dead,id:this.id,layer:this.layer,attributes:this.attributes?[...this.attributes.entries()]:null}}__unserialize(t){this.xy=t.xy,this.dead=t.dead,this.id=t.id,this.layer=t.layer,this.attributes=t.attributes?new Map(t.attributes):void 0,l.Z.getLink("game",(t=>this.game=t))}getRegion(){return r.yp.EMPTY}getCollideRegion(){return this.getRegion()}getCenter(){return this.xy}progress(t){}draw(t){this.drawInfo(t)}addInfo(t,e,s,i){if("function"!=typeof e){let t=e.toString();e=()=>t}this.removeInfo(t);let r=void 0!==s&&s>0?o.Z.set((()=>this.removeInfo(t)),s):null;this.infoItems.set(t,{textSupplier:e,timerId:r,color:i})}removeInfo(t){let e=this.infoItems.get(t);void 0!==e&&(null!==e.timerId&&o.Z.clear(e.timerId),this.infoItems.delete(t))}getAttribute(t){return this.attributes?this.attributes.get(t):void 0}setAttribute(t,e){void 0===this.attributes&&(this.attributes=new Map),this.attributes.set(t,e)}deleteAttribute(t){void 0!==this.attributes&&this.attributes.delete(t)}drawInfo(t){if(0==this.infoItems.size)return;t.save();const e=h.T.infoFontSize,s=h.T.infoFontSize/2,i=e+s;let r=this.xy[0]+20,n=this.xy[1];t.font=`${e}px serif`,t.textBaseline="top",t.globalAlpha=h.T.infoAlpha;for(let e of this.infoItems.values()){let s=e.textSupplier();t.fillStyle=e.color||h.T.infoColor,t.fillText(s,r,n),n+=i}t.restore()}enhanceDrawWith(t){let e=this.draw;return this.draw=s=>{e.call(this,s),t.call(this,s)},()=>this.draw=e}collideWith(t){return r.yp.intersects(this.getCollideRegion(),t.getCollideRegion())}linearSize(){const t=this.getRegion().getBoundingBox();return Math.max(t.rightBottom[0]-t.leftTop[0],t.rightBottom[1]-t.rightBottom[1])}}l.Z.registerConstructor(c.__type,(t=>new c(t.xy)));class d extends c{m;size;static __type="Fly";v;constructor(t,e,s,i){super(t),this.m=e,this.size=i,this.v=n.Z.clone(s)}__serialize(){let t=super.__serialize();return t.m=this.m,t.v=this.v,t.size=this.size,t}__unserialize(t){super.__unserialize(t),this.m=t.m,this.v=t.v,this.size=t.size}getRegion(){return new r.kb(this.xy,this.size)}progress(t){const e=n.Z.mulByScalar(this.v,t);this.xy=n.Z.add(this.xy,e)}applyForce(t,e){const s=n.Z.mulByScalar(t,e/this.m);this.v=n.Z.add(this.v,s)}applyRotation(t,e){this.v=n.Z.rotate(this.v,t*e)}}l.Z.registerConstructor(d.__type,(t=>new d(t.xy,t.m,t.v,t.size)));class u extends d{static __type="Trail";tail;lastXy=null;progressTrail;fadingAlpha;constructor(t,e,s,i){super(t,e,s,i),this.tail=[],this.lastXy=null,this.progressTrail=!0,this.fadingAlpha=null}__serialize(){return super.__serialize()}_stopTrailing(t){this.progressTrail=!1,(0,i.pf)([1],[0],t/10,t,i.Ms.linear(0),(t=>this.fadingAlpha=t[0]))}progress(t){super.progress(t),this.progressTrail&&(null===this.lastXy&&(this.lastXy=this.xy),n.Z.length(n.Z.subtract(this.xy,this.lastXy))>10&&(this.tail.push(this.xy),this.lastXy=this.xy,this.tail.length>20&&this.tail.splice(0,this.tail.length-20)))}draw(t){if(super.draw(t),null!==this.fadingAlpha&&(t.globalAlpha=this.fadingAlpha),0===this.tail.length)return;const e=(0,i.jt)(h.T.trailStartColor,h.T.trailEndColor,1,this.tail.length,i.Ms.linear(0));for(let s=1;s<this.tail.length;s++){const i=e(s);t.strokeStyle=(0,h.B)(i),t.beginPath(),t.moveTo(this.tail[s-1][0],this.tail[s-1][1]),t.lineTo(this.tail[s][0],this.tail[s][1]),t.stroke()}if(this.progressTrail){const s=e(this.tail.length);t.strokeStyle=(0,h.B)(s),t.beginPath(),t.moveTo(this.xy[0],this.xy[1]),t.lineTo(this.tail[this.tail.length-1][0],this.tail[this.tail.length-1][1]),t.stroke()}}}l.Z.registerConstructor(u.__type,(t=>new u(t.xy,t.m,t.v,t.size)));class p extends d{static __type="Plane";_lifes;_fakeTargets;_score;_booster;_subscribers;layer;omega;hangForce;boostForce;minVelocity;maxVelocity;void;fakeTargetRadius;scripts;constructor(t){super(t,1,[0,-.1],7),this._lifes=1,this._fakeTargets=2,this._score=0,this._booster=1e4,this._subscribers=[],this.layer=100,this.omega=null,this.hangForce=null,this.boostForce=null,this.minVelocity=.01,this.maxVelocity=.1,this.void=!0,o.Z.set((()=>this.void=!1),h.T.planeBirthVoidPeriod)}emit(t){t.target=this,this._subscribers.forEach((e=>e(t)))}subscribe(t){this._subscribers.push(t)}set lifes(t){t<0&&(t=0);let e=t-this._lifes;this._lifes=t,this.emit(new m(e))}get lifes(){return this._lifes}set fakeTargets(t){t<0&&(t=0);let e=t-this._fakeTargets;this._fakeTargets=t,this.emit(new f(e))}get fakeTargets(){return this._fakeTargets}set score(t){t<0&&(t=0);let e=t-this._score;this._score=t,this.emit(new y(e))}get score(){return this._score}set booster(t){t<0&&(t=0);let e=t-this._booster;this._booster=t,this.emit(new v(e))}get booster(){return this._booster}getCollideRegion(){return this.void?r.yp.EMPTY:super.getCollideRegion()}__serialize(){let t=super.__serialize();return t.maxVelocity=this.maxVelocity,t.omega=this.omega,t.hangForce=this.hangForce,t.boostForce=this.boostForce,t.minVelocity=this.minVelocity,t.maxVelocity=this.maxVelocity,t.void=this.void,t.lifes=this.lifes,t.fakeTargets=this.fakeTargets,t.score=this.score,t.booster=this.booster,t.scrips=this.scripts,t}__unserialize(t){if(super.__unserialize(t),this.maxVelocity=t.maxVelocity,this.omega=t.omega||null,this.hangForce=t.hangForce||null,this.boostForce=t.boostForce||null,this.minVelocity=t.minVelocity,this.maxVelocity=t.maxVelocity,this.void=t.void,this.lifes=t.lifes,this.fakeTargets=t.fakeTargets,this.score=t.score,this.booster=t.booster,this.scripts=t.scripts,this.scripts){const t=this.scripts;l.Z.getLink("game",(e=>t.forEach((t=>t.setGame(e)))))}}draw(t){super.draw(t);const e=n.Z.normalize(this.v),s=n.Z.subtract(this.xy,n.Z.mulByScalar(e,this.size/7*5)),i=n.Z.add(this.xy,n.Z.mulByScalar(e,this.size/7*10)),r=n.Z.subtract(this.xy,n.Z.mulByScalar(n.Z.normal(e),this.size)),o=n.Z.add(this.xy,n.Z.mulByScalar(n.Z.normal(e),this.size));if(t.lineWidth=3,this.void&&(t.globalAlpha=.2),t.strokeStyle=h.T.planeColor,t.beginPath(),t.moveTo(s[0],s[1]),t.lineTo(i[0],i[1]),t.moveTo(this.xy[0],this.xy[1]),t.lineTo(r[0],r[1]),t.moveTo(this.xy[0],this.xy[1]),t.lineTo(o[0],o[1]),t.stroke(),null!==this.boostForce){t.fillStyle=h.T.planeBoosterColor,t.globalAlpha=h.T.planeBoosterAlpha;for(let s=0;s<3;s++){t.beginPath();const i=n.Z.add(n.Z.subtract(this.xy,n.Z.mulByScalar(e,5+this.size/7*5*s/2)),n.Z.random(1));t.arc(i[0],i[1],2/(1+s/2),0,2*Math.PI),t.fill()}}this.fakeTargetRadius&&(t.globalAlpha=.2,t.fillStyle=h.T.planeFakeTargetRadiusColor,t.beginPath(),t.arc(this.xy[0],this.xy[1],this.fakeTargetRadius,0,2*Math.PI),t.fill())}progress(t){if(null!==this.omega&&this.applyRotation(this.omega,t),null!==this.hangForce){const e=n.Z.mulByScalar(n.Z.normalize(this.v),-this.hangForce);this.applyForce(e,t)}if(null!==this.boostForce){const e=n.Z.mulByScalar(n.Z.normalize(this.v),this.boostForce);this.applyForce(e,t)}const e=n.Z.length(this.v);if(e<this.minVelocity&&(this.v=n.Z.mulByScalar(n.Z.normalize(this.v),this.minVelocity)),e>this.maxVelocity&&(this.v=n.Z.mulByScalar(n.Z.normalize(this.v),this.maxVelocity)),super.progress(t),this.scripts){this.scripts.forEach((e=>e.progress(t)));void 0!==this.scripts.find((t=>t.dead))&&(this.scripts=this.scripts.filter((t=>!t.dead)),0==this.scripts.length&&(this.scripts=void 0))}}addScript(t){void 0===this.scripts&&(this.scripts=[]),t.setGame(this.getGame()),this.scripts.push(t)}left(){this.omega=-.004}right(){this.omega=.004}noRotate(){this.omega=null}startHang(){this.hangForce=1e-4}stopHang(){this.hangForce=null}startBoost(){this.boostForce=1e-4}stopBoost(){this.boostForce=null}showFakeTargetRadius(t){this.fakeTargetRadius=t}hideFakeTargetRadius(){this.fakeTargetRadius=null}}l.Z.registerConstructor(p.__type,(t=>new p(t.xy)));class g extends class{target;constructor(){this.target=null}}{amount;constructor(t){super(),this.amount=t}}class m extends g{}class f extends g{}class y extends g{}class v extends g{}class x extends d{static __type="FakeTarget";omega;color;constructor(t){const e=n.Z.negate(n.Z.normalize(t.v)),s=2*Math.random()*Math.PI/10,r=s-2*s,o=n.Z.rotate(n.Z.mulByScalar(e,.1+50*Math.random()/1e3),r);super(n.Z.add(t.xy,n.Z.mulByScalar(e,2*t.size)),.1,o,3),this.layer=100,this.omega=.002-2*Math.random()*.002,this.color=h.T.fakeTargetStartColor,(0,i.pf)(h.T.fakeTargetStartColor,h.T.fakeTargetEndColor,100,5e3,i.Ms.ease(),(t=>this.color=t)),(0,i.pf)([n.Z.length(o)],[0],100,5e3,i.Ms.ease(),(t=>this.v=n.Z.mulByScalar(n.Z.normalize(this.v),t[0])),(()=>this.dead=!0))}__serialize(){let t=super.__serialize();return t.omega=this.omega,t.color=this.color,t}__unserialize(t){this.omega=t.omega,this.color=t.color}progress(t){super.progress(t),this.applyRotation(this.omega,t)}draw(t){super.draw(t),t.strokeStyle=(0,h.B)(this.color),t.beginPath();for(let e=0;e<3;e++){const e=n.Z.random(this.size);t.moveTo(this.xy[0],this.xy[1]),t.lineTo(this.xy[0]+e[0],this.xy[1]+e[1]),t.moveTo(this.xy[0],this.xy[1]),t.lineTo(this.xy[0]-e[0],this.xy[1]-e[1])}t.stroke()}}l.Z.registerConstructor(x.__type,(()=>new x({xy:[0,0],v:[0,0],size:1})));class w extends u{static __type="Missile";maxSpeed;minSpeed;oldTargets=[];target;maxOmega;lifeTime;dieAnimation;constructor(t,e){const s=.13;super(t,.1,[0,s+Math.random()*(.15-s)],3),this.layer=100,this.maxSpeed=.15,this.minSpeed=s,this.target=e,this.maxOmega=.002,this.lifeTime=1e4+3e4*Math.random()}__serialize(){return Object.assign(super.__serialize(),{maxSpeed:this.maxSpeed,minSpeed:this.minSpeed,maxOmega:this.maxOmega,lifeTime:this.lifeTime,target:this.target?this.target.id:null,oldTargets:this.oldTargets.map((t=>t.id))})}__unserialize(t){super.__unserialize(t),this.maxSpeed=t.maxSpeed,this.minSpeed=t.minSpeed,this.maxOmega=t.maxOmega,this.lifeTime=t.lifeTime,null!==t.target?l.Z.getLink(t.target,(t=>this.target=t)):this.target=new c([1/0,1/0]),t.oldTargets?(this.oldTargets=t.oldTargets.map((()=>null)),t.oldTargets.forEach(((t,e)=>l.Z.getLink(t,(t=>this.oldTargets[e]=t))))):this.oldTargets=[]}isDying(){return this.dead||this.dieAnimation}getCollideRegion(){return this.dieAnimation?r.yp.EMPTY:super.getCollideRegion()}progress(t){if(this.lifeTime-=t,this.lifeTime<=0&&(this.dead=!0),!this.dieAnimation&&this.lifeTime<2e3&&(this._stopTrailing(1500),this.dieAnimation=(0,i.pf)(h.T.missileDieStartColor,h.T.missileDieEndColor,100,2e3,i.Ms.linear(0))),void 0!==this.target&&(this.target.dead&&(this.target=this.oldTargets.pop()),void 0!==this.target)){const e=n.Z.subtract(this.target.xy,this.xy),s=n.Z.alignUp(e,this.v);this.applyRotation(this.maxOmega*(s[0]>0?1:-1),t)}super.progress(t)}retarget(t){if(this.target===t)return;let e,s=this;if(void 0!==this.target){let r=this.target.enhanceDrawWith((i=>{void 0!==s.target&&(i.fillStyle="#ff9999",i.globalAlpha=.3,i.strokeStyle="#ff9999",i.beginPath(),i.moveTo(s.xy[0],s.xy[1]),i.lineTo(s.target.xy[0],s.target.xy[1]),i.stroke(),i.beginPath(),i.arc(t.xy[0],t.xy[1],e()[0],0,2*Math.PI),i.fill())}));e=(0,i.pf)([50],[0],100,1e3,i.Ms.ease(),void 0,r),this.oldTargets.push(this.target)}this.target=t}draw(t){super.draw(t);const e=n.Z.normalize(this.v),s=n.Z.add(this.xy,n.Z.mulByScalar(e,5*this.size/3)),i=n.Z.subtract(this.xy,n.Z.mulByScalar(n.Z.normal(e),2*this.size/3)),r=n.Z.add(this.xy,n.Z.mulByScalar(n.Z.normal(e),2*this.size/3));let o="black";if(this.dieAnimation&&(o=(0,h.B)(this.dieAnimation())),t.strokeStyle=o,t.beginPath(),t.moveTo(i[0],i[1]),t.lineTo(s[0],s[1]),t.moveTo(r[0],r[1]),t.lineTo(s[0],s[1]),t.stroke(),!this.dieAnimation){const s=1/(this.maxSpeed-this.minSpeed),i=-this.minSpeed*s,r=n.Z.length(this.v)*s+i;t.fillStyle=(0,h.B)(255*(1-r),0,255*r),t.globalAlpha=.5;for(let s=0;s<3;s++){t.beginPath();const i=n.Z.add(n.Z.subtract(this.xy,n.Z.mulByScalar(e,5*this.size/3*s/2)),n.Z.random(1));t.arc(i[0],i[1],2/(1+s/2),0,2*Math.PI),t.fill()}}}}l.Z.registerConstructor(w.__type,(t=>new w(t.xy,void 0)));class b extends c{constructor(t){super(t)}saveChanges(){const t=this.getGame();null!==t&&t.gameMap.entityChanged(this)}}class _ extends b{static __type="Perk";size;constructor(t){super(t),this.layer=100,this.size=5}__serialize(){let t=super.__serialize();return t.size=this.size,t}__unserialize(t){super.__unserialize(t),this.size=t.size}getRegion(){return new r.kb(this.xy,this.size)}collected(t){this.dead=!0}}l.Z.registerConstructor(_.__type,(t=>new _(t.xy)));class T extends _{static __type="Life";constructor(t){super(t)}draw(t){super.draw(t),t.strokeStyle=h.T.lifeColor,t.fillStyle=h.T.lifeColor,t.beginPath(),t.arc(this.xy[0],this.xy[1],this.size,0,2*Math.PI),t.stroke(),t.beginPath(),t.arc(this.xy[0],this.xy[1],this.size,0,2*Math.PI),t.fill()}collected(t){super.collected(t),t.lifes+=1}}l.Z.registerConstructor(T.__type,(t=>new T(t.xy)));class S extends _{static __type="Star";constructor(t){super(t)}draw(t){super.draw(t),t.strokeStyle=h.T.scoreColor,t.fillStyle=h.T.scoreColor,t.beginPath(),t.arc(this.xy[0],this.xy[1],this.size,0,2*Math.PI),t.stroke(),t.beginPath(),t.arc(this.xy[0],this.xy[1],this.size,0,2*Math.PI),t.fill()}collected(t){super.collected(t),t.score+=1}}l.Z.registerConstructor(S.__type,(t=>new S(t.xy)));class P extends d{static __type="Explosion";deadCount;circles;color;particles;constructor(t,e){super(t,1,[0,0],1),this.layer=100,this.deadCount=e,this.circles=[];let s=0;for(let r=0;r<e;r++){const e=10*this.size-2*Math.random()*10*this.size,r=10*this.size-2*Math.random()*10*this.size,a=[n.Z.add(t,[e,r]),0];o.Z.set((()=>{(0,i.pf)([0],[20*this.size],10,1e3,i.Ms.ease(),(t=>{a[1]=t[0],this.deadCount--}),(()=>this.dead=this.deadCount<=0))}),s+=100*Math.random()),this.circles.push(a)}this.color=(0,i.pf)(h.T.explosionStartColor,h.T.explosionEndColor,100,s+1e3,i.Ms.linear(0)),this.particles=[];for(let s=0;s<10*e;s++){const e=n.Z.random(.13+2*Math.random()*.13/3);this.particles.push([t,e])}}__serialize(){let t=super.__serialize();return t.deadCount=this.deadCount,t}__unserialize(t){super.__unserialize(t)}progress(t){this.particles.forEach((e=>e[0]=n.Z.add(e[0],n.Z.mulByScalar(e[1],t))))}getRegion(){return r.yp.EMPTY}draw(t){super.draw(t),t.globalAlpha=h.T.explosionAlpha,t.fillStyle=(0,h.B)(this.color()),this.circles.forEach((e=>{t.beginPath(),t.arc(e[0][0],e[0][1],e[1],0,2*Math.PI),t.fill()})),this.particles.forEach((e=>{t.beginPath(),t.arc(e[0][0],e[0][1],2,0,2*Math.PI),t.fill()}))}}l.Z.registerConstructor(P.__type,(t=>new P(t.xy,t.deadCount)));class M extends b{static __type="Obstacle";region;constructor(t){super(t.getCenter()),this.layer=100,this.region=t}getRegion(){return this.region}draw(t){super.draw(t),this.region.draw(t,h.T.obstacleFillColor,h.T.obstacleStrokeColor)}__serialize(){const t=super.__serialize();return t.region=l.Z.toPojo(this.region),t}__unserialize(t){super.__unserialize(t)}}l.Z.registerConstructor(M.__type,(t=>new M(l.Z.unserialize(t.region))));class C extends b{static __type="Cloud";size;color;circles;alpha=1;constructor(t,e=null){if(super(t),this.layer=200,this.size=50,this.color=h.T.cloudColor,this.circles=[],null!==e){const s=4+Math.round(6*e.nextFloat());for(let i=0;i<s;i++){const s=n.Z.add(t,n.Z.random(e.nextFloat()*this.size,(()=>e.nextFloat())));this.circles.push([s[0],s[1],e.nextFloat()*this.size])}this.alpha=.1+.4*e.nextFloat()}}getCollideRegion(){return r.yp.EMPTY}getRegion(){return r.yp.EMPTY}draw(t){super.draw(t),t.fillStyle=this.color,t.globalAlpha=this.alpha,this.circles.forEach((e=>{t.beginPath(),t.arc(e[0],e[1],e[2],0,2*Math.PI),t.fill()}))}__serialize(){const t=super.__serialize();return t.xy=this.xy,t.color=this.color,t.alpha=this.alpha,t.circles=this.circles,t.size=this.size,t}__unserialize(t){super.__unserialize(t),this.alpha=t.alpha,this.color=t.color,this.circles=t.circles,this.size=t.size}}l.Z.registerConstructor(C.__type,(t=>new C(t.xy,null)));class k extends c{message;color;fontSize;constructor(t,e,s,r){super(t),this.message=e,this.color=s,this.layer=300,this.fontSize=(0,i.pf)([10],[20],100,r||1e3,i.Ms.ease(),void 0,(()=>this.dead=!0))}getRegion(){return r.yp.EMPTY}draw(t){super.draw(t),t.globalAlpha=.5,t.fillStyle=this.color,t.font=this.fontSize()[0]+"px serif",t.fillText(this.message,this.xy[0],this.xy[1])}}},509:(t,e,s)=>{var i=s(381),r=s(811),n=s(607);class o{toState;condition;run;constructor(t,e,s){this.toState=t,this.condition=e,this.run=s}transit(t,e){return!this.condition||this.condition(t,e)?(this.run&&this.run(t,e),this.toState):null}}class a{name;transitions;constructor(t,e){this.name=t,this.transitions=e}}class l{startState;sampleFilter;debug=!1;constructor(t,e){this.startState=t,this.sampleFilter=e}process(t,e,s){s=s||0,e.stateReached=null;let i=new n.H(t,s);for(e._state=this.startState,this.debug&&console.groupCollapsed("FSA"),this.debug&&console.log("[start]",e._state.name);!i.atEnd();){let t=i.next();if(this.sampleFilter&&!this.sampleFilter(t,e)){this.debug&&console.log("[skip sample]",t);continue}this.debug&&console.log("[sample]",t);let s=null;for(let i of e._state.transitions)if(s=i.transit(t,e),null!==s){e.stateReached=s.name,this.debug&&console.log("[transition]",e._state.name," => ",s.name,"[context]",Object.assign({},e));break}if(null===s){this.debug&&console.log("[end]",e._state,"[context]",Object.assign({},e));break}e._state=s}return this.debug&&console.log("[buffer consumed]",i.atEnd()?"'till end":"'till "+i.idx),this.debug&&console.groupEnd(),i.atEnd()?-1:i.idx}step(t,e){if(void 0===e._state&&(e._state=this.startState),this.sampleFilter&&!this.sampleFilter(t,e))return this.debug&&console.log("[skip sample]",t),!0;this.debug&&console.log("[sample]",t);let s=null;for(let i of e._state.transitions)if(s=i.transit(t,e),null!==s)return e.stateReached=s.name,this.debug&&console.log("[transition]",e._state.name," => ",s.name,"[context]",Object.assign({},e)),e._state=s,!0;return this.debug&&console.log("[end]",e._state,"[context]",Object.assign({},e)),delete e._state,!1}}class h{name;builders;_sampleFilter;transitions=[];constructor(t="<ROOT>",e){this.name=t,this.builders=e?e.builders:new Map,this._sampleFilter=e?e._sampleFilter:null}sampleFilter(t){if(null!==this._sampleFilter)throw new Error("sampleFilter already set");return this._sampleFilter=t,this}transition(t,e,s){return this.state(t),this.transitions.push({toStateName:t,condition:e,run:s}),this}state(t){let e=this.builders.get(t);return void 0===e&&(e=new h(t,this),this.builders.set(t,e)),e}build(t){let e=new Map;for(let t of this.builders.values())e.has(t.name)||e.set(t.name,new a(t.name,[]));for(let t of this.builders.values()){let s=e.get(t.name);if(void 0===s)throw new Error("Can't find state: "+t.name);for(let i of t.transitions){let t=e.get(i.toStateName);if(void 0===t)throw new Error("Can't find state: "+i.toStateName);s.transitions.push(new o(t,i.condition,i.run))}}let s=e.get(t);if(void 0===s)throw new Error("Can't find state: "+t);return new l(s,this._sampleFilter)}}var c=s(658),d=s(165);i.Z.register("deadly-chasing",[r.g,c.N],((t,e)=>{const s=(t,e)=>t.sameDir&&t.dist<100&&t.behind,i=3*d.T.telemetrySamplesPerSecond;let r=(new h).sampleFilter(((t,e)=>t.t>e.lastFsaTriggerTime)).state("start").transition("start",((t,e)=>!s(t))).transition("chasing",s,((t,e)=>e.chasingCount=1)).state("chasing").transition("chasing",s,((t,e)=>e.chasingCount++)).transition("death",((t,e)=>t.missileIsDead),((t,e)=>e.deathTime=t.t)).transition("inbetween",((t,e)=>e.chasingCount>=i),((t,e)=>e.inbetweenCount=1)).state("inbetween").transition("death",((t,e)=>e.inbetweenCount<=.5*e.chasingCount&&t.missileIsDead),((t,e)=>e.deathTime=t.t)).transition("inbetween",((t,e)=>e.inbetweenCount<=.5*e.chasingCount&&!t.missileIsDead),((t,e)=>e.inbetweenCount++)).transition("failed").build("start");let n=new class{lastFsaTriggerTime;stateReached;chasingCount;deathTime;inbetweenCount;constructor(){this.reset(),this.lastFsaTriggerTime=0}reset(){this.stateReached=null,this.chasingCount=0,this.deathTime=void 0}};e.addStep((e=>{r.step(e,n)?("failed"==n.stateReached&&n.reset(),n.chasingCount>i?t.addInfo("chasingCount",(()=>d.t`Chase it to death!`),500):t.removeInfo("chasingCount"),void 0!==n.deathTime&&(t.addInfo("deadly chaser",d.t`Deadly chaser!`,3e3),t.plane.score+=10,n.lastFsaTriggerTime=n.deathTime,n.reset())):n.reset()}))}))},545:(t,e,s)=>{var i=s(381),r=s(811),n=s(658);i.Z.register(r.g,[n.N],((t,e)=>{let s=new r.g(e.capacity);return t.addTrigger((t=>s.step(e))),s}))},386:(t,e,s)=>{var i=s(381),r=s(925),n=s(134),o=s(464),a=s(165);i.Z.register("retarget-missiles",[],(t=>{r.Z.periodic((function(){let s=t.flies.filter((t=>t instanceof n.JO||t instanceof n.jA));if(s.length>1){t.flies.filter((t=>t instanceof n.Cp)).forEach((t=>{let i=t.target?o.Z.dist(t.xy,t.target.xy):1/0,r=s.filter((e=>e!==t.target)).filter((e=>!(e instanceof n.JO)||o.Z.dotProduct(o.Z.subtract(e.xy,t.xy),t.v)>=0)).map((e=>(e.distToM=o.Z.dist(t.xy,e.xy),e)));r.length>0&&(r.sort(((t,e)=>t.distToM<e.distToM?-1:t.distToM>e.distToM?1:0)),r[0].distToM<e&&r[0].distToM<i&&t.retarget(r[0]))}))}}),300);const e=a.T.fakeTargetRadius}))},976:(t,e,s)=>{var i=s(381),r=s(658),n=s(165);i.Z.register(r.N,[],(t=>{let e=n.T.telemetryWindowSeconds*n.T.telemetrySamplesPerSecond,s=new r.N(1e3/n.T.telemetrySamplesPerSecond,t,e);return t.addTrigger(s.toTrigger()),s}))},381:(t,e,s)=>{s.d(e,{Z:()=>a});const i={};class r{pluginId;dependencies;plugin;pluginValue;constructor(t,e,s){this.pluginId=t,this.dependencies=e,this.plugin=s,this.pluginValue=i}}const n=new Map;let o=!1;const a={register:function(t,e,s){if(n.has(t))throw new Error("Plugin with the id already exists: "+t);n.set(t,new r(t,e,s))},init:function(t){if(o)throw new Error("Calling plugin.init() inside plugin.init()");for(let e of function(){let t,e=[],s=[];n.forEach((t=>s.push(t)));do{t=[];for(let i of s){i.dependencies.filter((t=>-1==e.findIndex((e=>e.pluginId==t)))).length>0||(e.push(i),t.push(i))}t.forEach((t=>s.splice(s.indexOf(t),1)))}while(t.length>0);return s.forEach((t=>e.push(t))),e}()){o=!0;try{let s=e.dependencies.filter((t=>n.has(t))).map((t=>n.get(t))).filter((t=>t.pluginValue!==i)).map((t=>t.pluginValue));if(s.length!=e.dependencies.length){let t=e.dependencies.filter((t=>!n.has(t)||n.get(t).pluginValue===i)).map((t=>"function"==typeof t?t.name:t)).map((t=>`'${t}'`)).join(", ");console.log("[PLUGINS]","Missed dependencies",t,"for plugin","'"+("function"==typeof e.pluginId?e.pluginId.name:e.pluginId)+"'.","Not loaded");continue}e.pluginValue=e.plugin(t,...s)}finally{o=!1}}},get:function(t){if(!n.has(t))return;let e=n.get(t).pluginValue;if(e===i)throw new Error("Plugin is not yet initialized: "+t);return e}}},751:(t,e,s)=>{s.d(e,{yp:()=>n,kb:()=>o,OI:()=>l});var i=s(464),r=s(485);class n{static __type="Region";static EMPTY=new n;void=!1;poly=null;boundingBox=null;static intersects(t,e){if(t===n.EMPTY||e==n.EMPTY)return!1;if(t.void||e.void)return!1;if(t instanceof o&&e instanceof o)return i.Z.length(i.Z.subtract(t.xy,e.xy))<t.r+e.r;const s=t.getBoundingBox(),r=e.getBoundingBox();if(s.leftTop[0]>r.rightBottom[0]||r.leftTop[0]>r.rightBottom[0])return!1;if(s.leftTop[1]>r.rightBottom[1]||r.leftTop[1]>r.rightBottom[1])return!1;const a=t.toPolygonRegion(),l=e.toPolygonRegion();for(const t of a.vertices)if(l.containsPoint(t))return!0;for(const t of l.vertices)if(a.containsPoint(t))return!0;return!1}toPolygonRegion(){return null===this.poly&&(this.poly=this.__toPolygonRegion()),this.poly}getBoundingBox(){if(null===this.boundingBox){const t=this.toPolygonRegion();if(0==t.vertices.length)return{leftTop:[0,0],rightBottom:[0,0]};let e=1e20,s=-1e20,i=1e20,r=-1e20;for(let n of t.vertices)n[0]<e&&(e=n[0]),n[0]>s&&(s=n[0]),n[1]<i&&(i=n[1]),n[1]>r&&(r=n[1]);this.boundingBox={leftTop:[e,i],rightBottom:[s,r]}}return this.boundingBox}getCenter(){const t=this.getBoundingBox();return[(t.leftTop[0]+t.rightBottom[0])/2,(t.leftTop[1]+t.rightBottom[1])/2]}__toPolygonRegion(){return l.EMPTY}draw(t,e,s){t.fillStyle=e,t.strokeStyle=this.void?e:s;const i=this.toPolygonRegion();if(0!=i.vertices.length){t.beginPath(),t.moveTo(i.vertices[0][0],i.vertices[0][1]);for(let e=1;e<=i.vertices.length;e++){const s=e%i.vertices.length;t.lineTo(i.vertices[s][0],i.vertices[s][1])}t.fill(),t.beginPath(),t.moveTo(i.vertices[0][0],i.vertices[0][1]);for(let e=1;e<=i.vertices.length;e++){const s=e%i.vertices.length;t.lineTo(i.vertices[s][0],i.vertices[s][1])}t.stroke()}}__serialize(){return{void:this.void}}__unserialize(t){this.void=t.void}resetCache(){this.boundingBox=null,this.poly=null}moveTo(t){this.resetCache()}scale(t){this.resetCache()}rotate(t){this.resetCache()}}r.Z.registerConstructor(n.__type,(t=>new n));class o extends n{static __type="CircleRegion";xy;r;constructor(t,e){super(),this.xy=t,this.r=e}__toPolygonRegion(){const t=[],e=Math.max(5,Math.min(30,Math.round(2*Math.PI*this.r/5)));for(let s=0;s<e;s++){const i=this.xy[0]+this.r*Math.cos(2*Math.PI/e*s),r=this.xy[1]+this.r*Math.sin(2*Math.PI/e*s);t.push([i,r])}return new l(t)}scale(t){this.r*=t,super.scale(t)}moveTo(t){this.xy=t,super.moveTo(t)}rotate(t){}__serialize(){const t=super.__serialize();return t.xy=this.xy,t.r=this.r,t}__unserialize(t){super.__unserialize(t)}}r.Z.registerConstructor(o.__type,(t=>new o(t.xy,t.r)));class a{v0;v;static __type="Semispace";direction;constructor(t,e,s){this.v0=t,this.v=e,this.direction=this._direction(s)}containsPoint(t){return this.direction*this._direction(t)>=0}_direction(t){if(Math.abs(this.v[0])<1e-6)return Math.sign(t[0]-this.v0[0]);const e=this.v0[1]+(t[0]-this.v0[0])/this.v[0]*this.v[1];return Math.sign(t[1]-e)}__serialize(){return{v0:this.v0,v:this.v,direction:this.direction}}__unserialize(t){this.direction=t.direction}}r.Z.registerConstructor(a.__type,(t=>new a(t.v0,t.v,[0,0])));class l extends n{static __type="ConvexPolygonRegion";static EMPTY=new l([]);vertices;semispaces;constructor(t){super(),this.vertices=t,this.calculateSemispaces()}calculateSemispaces(){const t=this.vertices;this.semispaces=[];for(let e=0;e<t.length;e++){const s=t[e],r=i.Z.subtract(t[(e+1)%t.length],t[e]),n=t[(e+2)%t.length];this.semispaces.push(new a(s,r,n))}for(let e=0;e<this.semispaces.length;e++)for(let s=0;s<t.length;s++)if(s!=e&&(e+1)%this.vertices.length!=s&&!this.semispaces[e].containsPoint(this.vertices[s]))throw new Error("Non-convex polygon: ["+t.join("], [")+"]")}scale(t){const e=this.getCenter();this.vertices=this.vertices.map((s=>i.Z.add(i.Z.mulByScalar(i.Z.subtract(s,e),t),e))),this.calculateSemispaces(),super.scale(t)}moveTo(t){const e=i.Z.subtract(t,this.getCenter());this.vertices=this.vertices.map((t=>i.Z.add(t,e))),this.calculateSemispaces(),super.moveTo(t)}rotate(t){const e=this.getCenter(),s=t/360*Math.PI;this.vertices=this.vertices.map((t=>i.Z.add(i.Z.rotate(i.Z.subtract(t,e),s),e))),this.calculateSemispaces(),super.rotate(t)}containsPoint(t){for(let e of this.semispaces)if(!e.containsPoint(t))return!1;return!0}__toPolygonRegion(){return this}__serialize(){const t=super.__serialize();return t.vertices=this.vertices,t}__unserialize(t){super.__unserialize(t)}}r.Z.registerConstructor(l.__type,(t=>new l(t.vertices)))},607:(t,e,s)=>{s.d(e,{d:()=>i,H:()=>r});class i{buffer;startIdx=0;endIdx=0;size=0;constructor(t){this.buffer=new Array(t)}get(t){if(t>=this.size)throw new Error("Index out of bound: "+t);return this.buffer[(this.startIdx+t)%this.buffer.length]}set(t,e){this.buffer[(this.startIdx+t)%this.buffer.length]=e}push(...t){for(let e of t){const t=this.buffer.length;this.size<t?(this.buffer[this.endIdx++]=e,this.size++):(this.buffer[this.startIdx]=e,this.startIdx=(this.startIdx+1)%t)}}forEach(t){for(let e=0;e<this.size;e++)t(this.get(e),e)}toArray(){const t=new Array(this.size);return this.forEach(((e,s)=>t[s]=e)),t}}class r{buffer;idx;constructor(t,e=0){this.buffer=t,this.idx=e}atEnd(){return this.idx==this.buffer.size}next(){if(this.atEnd())throw new Error("Consumption after the end");return this.buffer.get(this.idx++)}}},350:(t,e,s)=>{s.d(e,{K:()=>h});const i=256,r=Math.pow(i,6),n=Math.pow(2,52),o=2*n,a=255;class l{i=0;j=0;S=[];constructor(t){let e,s=t.length,r=0,n=0;for(s||(t=[s++]);r<i;)this.S[r]=r++;for(r=0;r<i;r++)e=this.S[r],n=a&n+t[r%s]+e,this.S[r]=this.S[n],this.S[n]=e;this.g(i)}g(t){let e,s=0,r=this.i,n=this.j,o=this.S;for(;t--;)r=a&r+1,n=a&n+o[r],e=o[r],o[r]=o[n],o[n]=e,s=s*i+o[a&o[r]+o[n]];return this.i=r,this.j=n,s}}class h{pool=[];arc4;constructor(t){const e=[];this.mixkey(this.flatten(null==t?this.autoseed():t,3),e),this.arc4=new l(e),this.mixkey(this.tostring(this.arc4.S),this.pool)}nextFloat(){let t=this.arc4.g(6),e=r,s=0;for(;t<n;)t=(t+s)*i,e*=i,s=this.arc4.g(1);for(;t>=o;)t/=2,e/=2,s>>>=1;return(t+s)/e}flatten(t,e){const s=[];if(e&&"object"==typeof t)for(const i in t)try{s.push(this.flatten(t[i],e-1))}catch(t){}return s.length?s:"string"==typeof t?t:t+"\0"}mixkey(t,e){let s=t+"",i=0,r=0;for(;r<s.length;)e[a&r]=a&(i^=19*e[a&r])+s.charCodeAt(r++);return this.tostring(e)}autoseed(t){return window.crypto.getRandomValues(t=new Uint8Array(i)),this.tostring(t)}tostring(t){return String.fromCharCode.apply(0,t)}}},722:(t,e,s)=>{s.d(e,{As:()=>P,f3:()=>m,z2:()=>T,Ox:()=>S,jQ:()=>x,nZ:()=>w,Gc:()=>v,n$:()=>b,Xf:()=>u,RF:()=>y,Gt:()=>f,Cs:()=>M});var i=s(134),r=s(751),n=s(917),o=s(485),a=s(464),l=s(350),h=s(32);class c extends i.MB{sprite;region;_angle=0;rendering;set angle(t){this._angle=t/180*Math.PI,this.sprite=void 0}get angle(){return this._angle/Math.PI*180}__serialize(){return Object.assign(super.__serialize(),{angle:this._angle})}__unserialize(t){super.__unserialize(t),this._angle=t.angle}getRegion(){return this.region||r.yp.EMPTY}getCollideRegion(){return r.yp.EMPTY}draw(t){const e=.9;if(void 0===this.sprite&&this.render(e),void 0===this.sprite)return;const s=this.xy[0]-this.sprite.centerXy[0]*e,i=this.xy[1]-this.sprite.centerXy[1]*e;t.drawImage(this.sprite.bitmap,s,i,Math.round(this.sprite.bitmap.width*e),Math.round(this.sprite.bitmap.height*e)),super.draw(t)}render(t=1){return void 0!==this.rendering?Promise.resolve():this.rendering=this.doRender(t).then((t=>{this.sprite=t,this.getGame()?.gameMap.changeEntityGeometry(this,(()=>{if(void 0===t)return void(this.region=void 0);const e=t.bitmap.width,s=t.bitmap.height,i=this.xy[0]-t.centerXy[0],n=this.xy[1]-t.centerXy[1];this.region=new r.OI([[i,n],[i+e,n],[i+e,n+s],[i,n+s]])})),this.rendering=void 0}))}}class d extends c{text;static __type="TextEntity";options;constructor(t,e,s={}){super(t),this.text=e,this.options=Object.assign({color:"black",size:20,font:"serif"},s)}__serialize(){return Object.assign(super.__serialize(),{text:this.text,options:this.options})}__unserialize(t){super.__unserialize(t)}doRender(t){return new Promise((e=>{const s=document.createElement("canvas"),i=s.getContext("2d");if(null===i)return e(void 0);const r=Math.round(this.options.size/t);i.font=`${r}px "${this.options.font}"`;const n=i.measureText(this.text||"Z"),o=Math.round(n.width),a=Math.round(n.actualBoundingBoxDescent+n.actualBoundingBoxAscent),l=Math.round(.2*o),h=Math.round(.2*a),c=o+2*l,d=a+2*h;let u=[c/2,d/2];const p=l-u[0],g=h+n.actualBoundingBoxAscent-u[1];i.translate(u[0],u[1]),i.rotate(this._angle);const m=i.getTransform(),f=m.transformPoint({x:p,y:g}),y=m.transformPoint({x:p+c,y:g-d});s.width=Math.abs(y.x-f.x),s.height=Math.abs(y.y-f.y),u=[s.width/2,s.height/2],i.resetTransform(),i.translate(u[0],u[1]),i.rotate(this._angle),i.fillStyle=this.options.color,i.font=`${r}px "${this.options.font}"`,i.beginPath(),i.fillText(this.text,p,g),i.fill(),e(createImageBitmap(s).then((t=>(console.log("rendered:",this.text),{bitmap:t,centerXy:u}))))}))}}o.Z.registerConstructor(d.__type,(t=>new d(t.xy,t.text,t.options)));class u extends i.MB{node;static __type="Script";region;constructor(t,e){super(t),this.node=e,this.region=new r.kb(t,3)}getRegion(){return this.region}getCollideRegion(){return r.yp.EMPTY}progress(t){if(this.dead)return;super.progress(t);const e=this.getGame();if(null!==e){this.node.progress(t,e)||(this.dead=!0,e.gameMap.removeEntity(this))}}__serialize(){const t=super.__serialize();return t.node=o.Z.toPojo(this.node),t}__unserialize(t){super.__unserialize(t)}}o.Z.registerConstructor(u.__type,(t=>new u(t.xy,o.Z.unserialize(t.node))));class p{game;progress(t,e){return void 0===this.game&&(this.game=e,this.init()),this.doProgress(t)}}class g extends p{done=!1;__serialize(){return{done:this.done}}__unserialize(t){this.done=t.done}doProgress(t){return!this.done&&(this.doAction(),this.done=!0,!0)}init(){}reset(){this.done=!1}}class m extends g{posOrId;static __type="MissileFromActionNode";constructor(t){super(),this.posOrId=t}doAction(){if(void 0===this.game)return;let t;if("string"==typeof this.posOrId){const e=this.game.gameMap.findById(this.posOrId);if(void 0===e)return;t=e.xy}else t=this.posOrId;const e=new i.Cp(t,this.game.plane);this.game.addEntity(e)}__serialize(){return Object.assign(super.__serialize(),{posOrId:this.posOrId})}}o.Z.registerConstructor(m.__type,(t=>new m(t.posOrId)));class f extends g{xyOrName;static __type="TeleportActionNode";constructor(t){super(),this.xyOrName=t}doAction(){if(void 0===this.game)return;let t;if("string"==typeof this.xyOrName){const e=1e6,s=new l.K(this.xyOrName);t=[Math.round((s.nextFloat()>.5?-1:1)*s.nextFloat()*e),Math.round((s.nextFloat()>.5?-1:1)*s.nextFloat()*e)]}else t=this.xyOrName;this.game.teleportTo(t)}__serialize(){return Object.assign(super.__serialize(),{xyOrName:this.xyOrName})}}o.Z.registerConstructor(f.__type,(t=>new f(t.xyOrName)));class y extends g{text;id;intervalMs;color;static __type="ShowTextActionNode";constructor(t,e,s=3e3,i){super(),this.text=t,this.id=e,this.intervalMs=s,this.color=i}doAction(){void 0!==this.game&&this.game.addInfo(this.id?this.id:(0,h.h)(),this.text,this.intervalMs,this.color)}__serialize(){return Object.assign(super.__serialize(),{text:this.text,id:this.id,intervalMs:this.intervalMs,color:this.color})}}o.Z.registerConstructor(y.__type,(t=>new y(t.text,t.id,t.intervalMs,t.color)));class v extends g{posOrId;text;options;static __type="PutTextActionNode";constructor(t,e,s){super(),this.posOrId=t,this.text=e,this.options=s}doAction(){if(void 0!==this.game)if("string"==typeof this.posOrId){const t=this.game.gameMap.findById(this.posOrId);if(void 0===t)return;if(!(t instanceof d))return void this.game.gameMap.addEntity(new d(t.xy,this.text,this.options));t.text=this.text,Object.assign(t.options,this.options),t.render().then((()=>this.game?.gameMap.entityChanged(t)))}else this.game.gameMap.addEntity(new d(this.posOrId,this.text,this.options))}__serialize(){return Object.assign(super.__serialize(),{text:this.text,posOrId:this.posOrId,options:this.options})}}o.Z.registerConstructor(v.__type,(t=>new v(t.posOrId,t.text,t.options)));class x extends g{attribute;static __type="PlayerRemoveActionNode";constructor(t){super(),this.attribute=t}doAction(){void 0!==this.game&&this.game.plane.deleteAttribute(this.attribute)}__serialize(){return Object.assign(super.__serialize(),{attribute:this.attribute})}}o.Z.registerConstructor(x.__type,(t=>new x(t.attribute)));class w extends g{attribute;value;static __type="PlayerSetActionNode";constructor(t,e){super(),this.attribute=t,this.value=e}doAction(){void 0!==this.game&&this.game.plane.setAttribute(this.attribute,this.value||"")}__serialize(){return Object.assign(super.__serialize(),{attribute:this.attribute,value:this.value})}}o.Z.registerConstructor(w.__type,(t=>new w(t.attribute,t.value)));class b extends g{id;static __type="RemoveActionNode";constructor(t){super(),this.id=t}doAction(){if(void 0===this.game)return;const t=this.game.gameMap.findById(this.id);t&&this.game.gameMap.removeEntity(t)}__serialize(){return Object.assign(super.__serialize(),{id:this.id})}}o.Z.registerConstructor(b.__type,(t=>new b(t.id)));class _ extends p{animation;init(){if(!this.game)return;if(this.animation)return void(this.animation.onAnimationProgress=t=>this.onAnimationProgress(t));const t=this.buildSettings();if(!t)return;const e=t.speed>0?Math.round(a.Z.dist(t.startPos,t.endPos)/t.speed*1e3):1;this.animation=new n.fw(t.startPos,t.endPos,10,e,t.timingFunctionName),this.animation.onAnimationProgress=t=>this.onAnimationProgress(t)}reset(){this.game=void 0,this.animation=void 0}doProgress(t){return!!this.animation&&this.animation.progress(t)}moveEntityTo(t,e){this.game&&t instanceof i.JA&&this.game.gameMap.changeEntityGeometry(t,(t=>{t.xy=e,t.region.moveTo(e)}))}__serialize(){return{animation:o.Z.toPojo(this.animation)}}__unserialize(t){this.animation=o.Z.unserialize(t.animation)}}class T extends _{entityId;endPosOrId;speed;timingFunctionName;startPos;static __type="MoveEntityNode";entity;constructor(t,e,s,i,r){super(),this.entityId=t,this.endPosOrId=e,this.speed=s,this.timingFunctionName=i,this.startPos=r}buildSettings(){const t=this.game,e=t.gameMap.findById(this.entityId);if(!e)return;let s;if(this.entity=e,"string"==typeof this.endPosOrId){const e=t.gameMap.findById(this.endPosOrId);if(!e)return;this.endPosOrId=e.xy,s=e.xy}else s=this.endPosOrId;return this.startPos||(this.startPos=this.entity.xy),{endPos:s,startPos:this.startPos,speed:this.speed,timingFunctionName:this.timingFunctionName}}onAnimationProgress(t){this.moveEntityTo(this.entity,t)}__serialize(){return Object.assign(super.__serialize(),{entityId:this.entityId,endPosOrId:this.endPosOrId,speed:this.speed,timingFunctionName:this.timingFunctionName,startPos:this.startPos})}__unserialize(t){}}o.Z.registerConstructor(T.__type,(t=>new T(t.entityId,t.endPosOrId,t.speed,t.timingFunctionName,t.startPos)));class S extends _{entityId;offset;speed;timingFunctionName;static __type="OffsetEntityNode";entity;constructor(t,e,s,i){super(),this.entityId=t,this.offset=e,this.speed=s,this.timingFunctionName=i}buildSettings(){const t=this.game.gameMap.findById(this.entityId);if(!t)return;this.entity=t;const e=a.Z.add(t.xy,this.offset);return{startPos:t.xy,endPos:e,speed:this.speed,timingFunctionName:this.timingFunctionName}}onAnimationProgress(t){this.moveEntityTo(this.entity,t)}__serialize(){return Object.assign(super.__serialize(),{entityId:this.entityId,offset:this.offset,speed:this.speed,timingFunctionName:this.timingFunctionName})}}o.Z.registerConstructor(S.__type,(t=>new S(t.entityId,t.offset,t.speed,t.timingFunctionName)));class P extends p{nodes;loop;currentIdx;static __type="ChainNode";constructor(t,e=!1,s=0){super(),this.nodes=t,this.loop=e,this.currentIdx=s}__serialize(){return{nodes:o.Z.toPojo(this.nodes),currentIdx:this.currentIdx,loop:this.loop}}__unserialize(t){}progress(t,e){if(this.currentIdx>=this.nodes.length)return!1;let s=this.nodes[this.currentIdx].progress(t,e);return s||this.currentIdx++,s=this.currentIdx<this.nodes.length,this.loop&&!s?(this.reset(),!0):s}doProgress(t){return!0}init(){}reset(){this.currentIdx=0,this.nodes.forEach((t=>t.reset()))}}o.Z.registerConstructor(P.__type,(t=>new P(t.nodes.map((t=>o.Z.unserialize(t))),t.loop,t.currentIdx)));class M extends p{thenNode;interval;timePassed;static __type="TimerNode";constructor(t,e,s=0){super(),this.thenNode=t,this.interval=e,this.timePassed=s}__serialize(){return{thenNode:o.Z.toPojo(this.thenNode),interval:this.interval,timePassed:this.timePassed}}__unserialize(t){}progress(t,e){return this.timePassed+=t,this.timePassed<=this.interval||this.thenNode.progress(t,e)}doProgress(t){return!0}init(){}reset(){this.timePassed=0,this.thenNode.reset()}}o.Z.registerConstructor(M.__type,(t=>new M(o.Z.unserialize(t.condition),t.inerval,t.timePassed)))},485:(t,e,s)=>{s.d(e,{Z:()=>d});const i=new Map;function r(t){if(null===t)return null;if(void 0===t)return;if(t instanceof Array)return t.map((t=>r(t)));switch(typeof t){case"boolean":case"number":case"string":return t}const e=Object.getPrototypeOf(t);if("function"==typeof t.__serialize&&e.constructor.__type){return{type:e.constructor.__type,data:t.__serialize()}}{const e={};for(const s in t)e[s]=r(t[s]);return e}}let n=0;function o(t){try{return n++,a("string"==typeof t?JSON.parse(t):t)}finally{n--}}function a(t){if(null===t)return null;if(void 0!==t){switch(typeof t){case"boolean":case"number":case"string":return t}if(t instanceof Array)return t.map((t=>a(t)));if(t.type){let e=i.get(t.type);if(void 0===e)throw new Error("No constructor registered for type: "+t.type);let s=e(t.data);return s.__unserialize(t.data),s}{const e={};for(const s in t){const i=t[s];e[s]=void 0===i?void 0:a(i)}return e}}}let l=[],h=0;function c(t,e){for(let s of e){let e=s.get(t);if(void 0!==e)return e}}const d={toPojo:r,serialize:function(t){return JSON.stringify(r(t))},registerConstructor:function(t,e){if(i.has(t))throw new Error("The constructor already exist: "+t);i.set(t,e)},unserialize:o,unserializeExisting:function(t,e){if(!e.type)throw new Error("Can't unserialize "+e);{const s=o(e),i=Object.getPrototypeOf(t).constructor.__type;if(e.type!==i)throw new Error("Types doesn't match: "+e.type+" and "+i);for(const e of Object.getOwnPropertyNames(t))t[e]=s[e]}},getLink:function(t,e,s=(()=>{})){if(0==h)throw new Error("getLink can only be called inside unserializeWithLinks");if(s=s||(()=>{}),0==n)throw new Error("getLink can only be called inside __unserialize method");l.push({id:t,consumer:e,defaultProducer:s})},unserializeWithLinks:function(t,e){if(0!=n)throw new Error("unserializeWithLinks can only be called outside __unserialize method");h++,l=[];const s=t(),i=e();if(function(t){if(0!=n)throw new Error("resolveLinks can only be called outside __unserialize mathod");l.forEach((e=>{let s;if(e.id instanceof Array)s=e.id.map((s=>{let i=c(s,t);if(void 0===i){if(!e.defaultProducer)throw new Error("Unresolved link: "+e.id);i=e.defaultProducer()}}));else if(s=c(e.id,t),void 0===s){if(!e.defaultProducer)throw new Error("Unresolved link: "+e.id);s=e.defaultProducer()}e.consumer(s)})),l=[]}(i instanceof Array?i:[i]),0!=n)throw new Error("unserializeWithLinks: bad nesting");if(l.length>0)throw new Error("unserializeWithLinks: not all links are resolved: "+l);return h--,s}}},299:(t,e,s)=>{var i=s(134),r=s(751),n=s(485),o=s(722);class a extends i.MB{xy;id;static __type="Marker";region;constructor(t,e){super(t),this.xy=t,this.id=e,this.region=new r.kb(t,5)}getRegion(){return this.region}getCollideRegion(){return r.yp.EMPTY}__serialize(){return super.__serialize()}__unserialize(t){super.__unserialize(t)}}n.Z.registerConstructor(a.__type,(t=>new a(t.xy,t.id)));class l extends i.MB{region;type;triggerOnEnter=!0;triggerOnLeave=!1;triggered=0;inside=!1;constructor(t,e){super(t.getCenter()),this.region=t,this.type=e}getRegion(){return this.region}getCollideRegion(){return r.yp.EMPTY}progress(t){if(this.triggered>0&&("immediate"===this.type||"once"===this.type))return;const e=this.getGame();if(null===e)return;if("immediate"===this.type)return this.triggered++,this.onTrigger(),void this.saveChanges();const s=r.yp.intersects(e.plane.getRegion(),this.region);!this.inside&&s?(this.inside=!0,this.triggerOnEnter&&(this.triggered++,this.onTrigger()),this.saveChanges()):this.inside&&!s&&(this.inside=!1,this.triggerOnLeave&&(this.triggered++,this.onTrigger()),this.saveChanges())}__serialize(){const t=super.__serialize();return t.region=n.Z.toPojo(this.region),t.triggered=this.triggered,t.type=this.type,t.triggerOnEnter=this.triggerOnEnter,t.triggerOnLeave=this.triggerOnLeave,t.inside=this.inside,t}__unserialize(t){super.__unserialize(t),this.triggered=t.triggered,this.inside=t.inside,this.type=t.type,this.triggerOnEnter=t.triggerOnEnter,this.triggerOnLeave=t.triggerOnLeave}}class h{game;triggerSource;chain=[];collapseChain;planeBound=!1;selectionStart=0;constructor(t,e){this.game=t,this.triggerSource=e}forPlayer(){return this.planeBound=!0,this}posOf(t){const e=this.game.gameMap.findById(t);if(void 0!==e)return e.xy}playerHas(t,e){return void 0===e?void 0!==this.game.plane.getAttribute(t):this.game.plane.getAttribute(t)==e}playerSet(t,e){return this.withContinuation(new o.nZ(t,e))}playerRemove(t){return this.withContinuation(new o.jQ(t))}teleport(t){return this.withContinuation(void 0!==t?new o.Gt(t):void 0)}after(t){return this.selectionStart=this.chain.length,this.collapseChain=()=>{const e=this.chain.splice(this.selectionStart,this.chain.length-this.selectionStart);this.chain.push(new o.Cs(1==e.length?e[0]:new o.As(e),t))},this}missileFrom(t){return this.withContinuation(void 0!==t?new o.f3(t):void 0)}showText(t,e,s=3e3,i){return this.withContinuation(new o.RF(t,e,s,i))}putText(t,e,s){return this.withContinuation(void 0!==t?new o.Gc(t,e,s):void 0)}remove(t){return this.withContinuation(new o.n$(t))}move(t){const e=this;return{_speed:0,_timingFunctionName:"ease",speed(t){return this._speed=t,this},slow(){return this._speed=100,this},fast(){return this._speed=500,this},ease(){return this._timingFunctionName="ease",this},linear(){return this._timingFunctionName="linear",this},up(t=100){return this.offset([0,-t])},down(t=100){return this.offset([0,t])},left(t=100){return this.offset([-t,0])},right(t=100){return this.offset([t,0])},offset(s){return e.withContinuation(new o.Ox(t,s,this._speed,this._timingFunctionName))},to(s){return e.withContinuation(void 0!==s?new o.z2(t,s,this._speed,this._timingFunctionName):void 0)}}}then(){return void 0!==this.collapseChain&&this.collapseChain(),this}end(){void 0!==this.collapseChain&&this.collapseChain();let t=this.chain.length>1?new o.As(this.chain):this.chain[0];this.chain=[],this.registerScript(new o.Xf(this.triggerSource.xy,t))}loop(){void 0!==this.collapseChain&&this.collapseChain();let t=new o.As(this.chain,!0);this.chain=[],this.registerScript(new o.Xf(this.triggerSource.xy,t))}registerScript(t){this.planeBound?this.game.plane.addScript(t):this.game.gameMap.addEntity(t)}withContinuation(t){return t&&this.chain.push(t),{then:()=>this.then(),end:()=>this.end(),loop:()=>this.loop()}}}class c extends l{static __type="CallbackTrigger";callback=null;source;constructor(t,e){super(t,e)}progress(t){super.progress(t)}onTrigger(){const t=this.getGame();null!==t&&this.callback&&this.callback((()=>new h(t,this)))}setCallback(t){this.callback=t,this.source=t.toString()}getCallbackSource(){return this.source}setCallbackSource(t){this.source=t;const e=new Set;["fn","fnText","forbiddenKeys","exceptionKeys","empty","oForbiddenKeys"].forEach((t=>e.add(t))),[this,self].forEach((t=>{void 0!==t&&Object.getOwnPropertyNames(t).forEach((t=>{t.match(/^[$\w]+$/)&&e.add(t)}))})),["eval","Object","console","Number","String","Boolean","RegExp","JSON","Date"].forEach((t=>e.delete(t)));const s=['"use strict";',"var "+[...e.values()].join(", ")+";","{","("+t+")(api);","}"].join("\n");this.callback=new Function("api","self","window",s)}__serialize(){const t=super.__serialize();return t.callback=this.source,t}__unserialize(t){super.__unserialize(t)}}n.Z.registerConstructor(c.__type,(t=>{const e=new c(n.Z.unserialize(t.region),t.type);return e.setCallbackSource(t.callback),e}))},165:(t,e,s)=>{function i(t,...e){if(t instanceof Array){return t=t.join("{}"),(r[t]||t).split("{}").map(((t,s,i)=>t+(i.length-1==s?"":e[s]))).join("")}return r[t]||t}s.d(e,{t:()=>i,T:()=>r,B:()=>n});const r={booster:"",boosterColor:"black",score:"",scoreColor:"green",time:"",timeColor:"black",fakeTarget:"",fakeTargetColor:"black",fakeTargetStartColor:[255,0,0],fakeTargetEndColor:[255,200,200],fakeTargetRadius:200,life:"",lifeColor:"#ff471a",planeColor:"black",planeBoosterColor:"#ff3333",planeBoosterAlpha:.5,planeStartPos:[0,0],planeFakeTargetRadiusColor:"#cccccc",planeBirthVoidPeriod:4e3,trailStartColor:[255,255,255],trailEndColor:[200,200,200],missileDieStartColor:[0,0,0],missileDieEndColor:[255,255,255],explosionStartColor:[255,0,0],explosionEndColor:[255,200,200],explosionAlpha:.5,obstacleFillColor:"#cccccc",obstacleStrokeColor:"#333333",skyColor:"#f0ffff",skyOutOfRangeColor:"#fff0f0",cloudColor:"#eeeeee",radarFillColor:"#fff2e6",radarStrokeColor:"#663300",radarSectorColor:"#ffcc99",radarVisibilityAreaColor:"#999999",radarPlaneColor:"#663300",radarMissileColor:"#ff0000",radarPerkColor:"#000000",radarEnemyColor:"#0000ff",radarAlpha:.9,radarSize:100,radarScale:20,infoFontSize:15,infoBgColor:"#ffff88",infoColor:"#000000",infoAlpha:.8,telemetrySamplesPerSecond:5,telemetryWindowSeconds:10,detectorIntervalMs:300};function n(t,e,s){if(void 0===e&&void 0===s){const e=t;return`rgb(${e[0]}, ${e[1]}, ${e[2]})`}return`rgb(${t}, ${e}, ${s})`}},658:(t,e,s)=>{s.d(e,{N:()=>o});var i=s(607),r=s(134),n=s(464);class o{interval;game;capacity;lastTime=0;time=0;planeState;missileState;lastClosestMissile=null;constructor(t,e,s){this.interval=t,this.game=e,this.capacity=s,this.planeState=new i.d(this.capacity),this.missileState=new i.d(this.capacity)}toTrigger(){return t=>this.progress(t)}progress(t){this.time+=t,this.time-this.lastTime>=this.interval&&(this.lastTime=this.time,this._collect())}_collect(){let t=1e20,e=null;const s=this.game.plane;for(let i of this.game.flies)if(i instanceof r.Cp){const r=s.xy[0]-i.xy[0],n=s.xy[1]-i.xy[1],o=r*r+n*n;o<t&&(t=o,e=i)}let i=!1;this.lastClosestMissile!==e&&(null!==this.lastClosestMissile&&this.lastClosestMissile.isDying()&&(i=!0),this.lastClosestMissile=e),this.planeState.push({t:this.time,xy:s.xy,v:n.Z.normalize(s.v)}),null!==e?this.missileState.push({t:this.time,xy:e.xy,v:n.Z.normalize(e.v),lastMissileIsDead:i}):this.missileState.push({t:this.time,xy:[1/0,1/0],v:[0,0],lastMissileIsDead:i})}getLatestPlaneState(){return this.planeState.size>0?this.planeState.get(this.planeState.size-1):null}getLatestMissileState(){return this.missileState.size>0?this.missileState.get(this.missileState.size-1):null}}},925:(t,e,s)=>{s.d(e,{Z:()=>m});let i=0;const r=[],n=new Map;let o=!1,a=0,l=!1;function h(t,e,s){return void 0===s&&(i++,s=i),c({id:s,time:a+e,duration:e,f:t,paused:!1,progressBeforePause:0}),s}function c(t){let e;for(e=0;e<r.length&&!(r[e].time>t.time);e++);n.set(t.id,t),r.splice(e,0,t)}function d(t){const e=n.get(t);return void 0===e?0:e.paused?e.progressBeforePause:0===e.duration?0:1-(e.time-a)/e.duration}function u(t){let e=n.get(t);if(void 0===e)return;if(e.paused)return;e.progressBeforePause=d(t),e.paused=!0;let s=r.findIndex((e=>e.id===t));r.splice(s,1)}function p(t){let e=n.get(t);void 0!==e&&e.paused&&(e.time=a+(1-e.progressBeforePause)*e.duration,e.paused=!1,e.progressBeforePause=0,c(e))}function g(t){return function(){if(!l)return t.apply(null,arguments);setTimeout((()=>t.apply(null,arguments)),0)}}const m={set:h,periodic:function t(e,s,i){let r=h((()=>{e(),t(e,s,r)}),s,i);return r},clear:g((function(t){let e=r.findIndex((e=>e.id===t));-1!==e&&(r.splice(e,1),n.delete(t))})),clearAll:g((function(){n.clear(),r.splice(0,r.length),o=!1})),pause:g(u),pauseAll:g((function(){for(let[t,e]of n)u(t);o=!0})),resume:g(p),resumeAll:g((function(){for(let[t,e]of n)p(t);o=!1})),allPaused:()=>o,getProgress:d,progress:function(t){if(a+=t,!o){l=!0;try{!function(){if(o)return;let t;for(t=0;t<r.length&&!(r[t].time>a);t++);t>0&&r.splice(0,t).forEach((t=>t.f()))}()}finally{l=!1}}},now:()=>a}},32:(t,e,s)=>{s.d(e,{h:()=>h});const i="input is invalid type",r="0123456789abcdef".split(""),n=[-2147483648,8388608,32768,128],o=[24,16,8,0],a=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298];class l{h0;h1;h2;h3;h4;h5;h6;h7;blocks;block=0;start=0;bytes=0;hBytes=0;finalized=!1;hashed=!1;first=!0;lastByteIndex;is224;constructor(t=!1){this.init(t)}init(t){this.is224=t,this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],t?(this.h0=3238371032,this.h1=914150663,this.h2=812702999,this.h3=4144912697,this.h4=4290775857,this.h5=1750603025,this.h6=1694076839,this.h7=3204075428):(this.h0=1779033703,this.h1=3144134277,this.h2=1013904242,this.h3=2773480762,this.h4=1359893119,this.h5=2600822924,this.h6=528734635,this.h7=1541459225)}update(t){if(this.finalized)return this;var e,s=typeof t;if("string"!==s){if("object"!==s)throw new Error(i);if(null===t)throw new Error(i);if(t.constructor===ArrayBuffer)t=new Uint8Array(t);else if(!Array.isArray(t)&&!ArrayBuffer.isView(t))throw new Error(i);e=!0}for(var r,n,a=0,l=t.length,h=this.blocks;a<l;){if(this.hashed&&(this.hashed=!1,h[0]=this.block,h[16]=h[1]=h[2]=h[3]=h[4]=h[5]=h[6]=h[7]=h[8]=h[9]=h[10]=h[11]=h[12]=h[13]=h[14]=h[15]=0),e)for(n=this.start;a<l&&n<64;++a)h[n>>2]|=t[a]<<o[3&n++];else for(n=this.start;a<l&&n<64;++a)(r=t.charCodeAt(a))<128?h[n>>2]|=r<<o[3&n++]:r<2048?(h[n>>2]|=(192|r>>6)<<o[3&n++],h[n>>2]|=(128|63&r)<<o[3&n++]):r<55296||r>=57344?(h[n>>2]|=(224|r>>12)<<o[3&n++],h[n>>2]|=(128|r>>6&63)<<o[3&n++],h[n>>2]|=(128|63&r)<<o[3&n++]):(r=65536+((1023&r)<<10|1023&t.charCodeAt(++a)),h[n>>2]|=(240|r>>18)<<o[3&n++],h[n>>2]|=(128|r>>12&63)<<o[3&n++],h[n>>2]|=(128|r>>6&63)<<o[3&n++],h[n>>2]|=(128|63&r)<<o[3&n++]);this.lastByteIndex=n,this.bytes+=n-this.start,n>=64?(this.block=h[16],this.start=n-64,this.hash(),this.hashed=!0):this.start=n}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296<<0,this.bytes=this.bytes%4294967296),this}finalize(){if(!this.finalized){this.finalized=!0;var t=this.blocks,e=this.lastByteIndex;t[16]=this.block,t[e>>2]|=n[3&e],this.block=t[16],e>=56&&(this.hashed||this.hash(),t[0]=this.block,t[16]=t[1]=t[2]=t[3]=t[4]=t[5]=t[6]=t[7]=t[8]=t[9]=t[10]=t[11]=t[12]=t[13]=t[14]=t[15]=0),t[14]=this.hBytes<<3|this.bytes>>>29,t[15]=this.bytes<<3,this.hash()}}hash(){var t,e,s,i,r,n,o,l,h,c=this.h0,d=this.h1,u=this.h2,p=this.h3,g=this.h4,m=this.h5,f=this.h6,y=this.h7,v=this.blocks;for(t=16;t<64;++t)e=((r=v[t-15])>>>7|r<<25)^(r>>>18|r<<14)^r>>>3,s=((r=v[t-2])>>>17|r<<15)^(r>>>19|r<<13)^r>>>10,v[t]=v[t-16]+e+v[t-7]+s<<0;for(h=d&u,t=0;t<64;t+=4)this.first?(this.is224?(n=300032,y=(r=v[0]-1413257819)-150054599<<0,p=r+24177077<<0):(n=704751109,y=(r=v[0]-210244248)-1521486534<<0,p=r+143694565<<0),this.first=!1):(e=(c>>>2|c<<30)^(c>>>13|c<<19)^(c>>>22|c<<10),i=(n=c&d)^c&u^h,y=p+(r=y+(s=(g>>>6|g<<26)^(g>>>11|g<<21)^(g>>>25|g<<7))+(g&m^~g&f)+a[t]+v[t])<<0,p=r+(e+i)<<0),e=(p>>>2|p<<30)^(p>>>13|p<<19)^(p>>>22|p<<10),i=(o=p&c)^p&d^n,f=u+(r=f+(s=(y>>>6|y<<26)^(y>>>11|y<<21)^(y>>>25|y<<7))+(y&g^~y&m)+a[t+1]+v[t+1])<<0,e=((u=r+(e+i)<<0)>>>2|u<<30)^(u>>>13|u<<19)^(u>>>22|u<<10),i=(l=u&p)^u&c^o,m=d+(r=m+(s=(f>>>6|f<<26)^(f>>>11|f<<21)^(f>>>25|f<<7))+(f&y^~f&g)+a[t+2]+v[t+2])<<0,e=((d=r+(e+i)<<0)>>>2|d<<30)^(d>>>13|d<<19)^(d>>>22|d<<10),i=(h=d&u)^d&p^l,g=c+(r=g+(s=(m>>>6|m<<26)^(m>>>11|m<<21)^(m>>>25|m<<7))+(m&f^~m&y)+a[t+3]+v[t+3])<<0,c=r+(e+i)<<0;this.h0=this.h0+c<<0,this.h1=this.h1+d<<0,this.h2=this.h2+u<<0,this.h3=this.h3+p<<0,this.h4=this.h4+g<<0,this.h5=this.h5+m<<0,this.h6=this.h6+f<<0,this.h7=this.h7+y<<0}hex(){this.finalize();var t=this.h0,e=this.h1,s=this.h2,i=this.h3,n=this.h4,o=this.h5,a=this.h6,l=this.h7,h=r[t>>28&15]+r[t>>24&15]+r[t>>20&15]+r[t>>16&15]+r[t>>12&15]+r[t>>8&15]+r[t>>4&15]+r[15&t]+r[e>>28&15]+r[e>>24&15]+r[e>>20&15]+r[e>>16&15]+r[e>>12&15]+r[e>>8&15]+r[e>>4&15]+r[15&e]+r[s>>28&15]+r[s>>24&15]+r[s>>20&15]+r[s>>16&15]+r[s>>12&15]+r[s>>8&15]+r[s>>4&15]+r[15&s]+r[i>>28&15]+r[i>>24&15]+r[i>>20&15]+r[i>>16&15]+r[i>>12&15]+r[i>>8&15]+r[i>>4&15]+r[15&i]+r[n>>28&15]+r[n>>24&15]+r[n>>20&15]+r[n>>16&15]+r[n>>12&15]+r[n>>8&15]+r[n>>4&15]+r[15&n]+r[o>>28&15]+r[o>>24&15]+r[o>>20&15]+r[o>>16&15]+r[o>>12&15]+r[o>>8&15]+r[o>>4&15]+r[15&o]+r[a>>28&15]+r[a>>24&15]+r[a>>20&15]+r[a>>16&15]+r[a>>12&15]+r[a>>8&15]+r[a>>4&15]+r[15&a];return this.is224||(h+=r[l>>28&15]+r[l>>24&15]+r[l>>20&15]+r[l>>16&15]+r[l>>12&15]+r[l>>8&15]+r[l>>4&15]+r[15&l]),h}toString(){return this.hex()}digest(){this.finalize();var t=this.h0,e=this.h1,s=this.h2,i=this.h3,r=this.h4,n=this.h5,o=this.h6,a=this.h7,l=[t>>24&255,t>>16&255,t>>8&255,255&t,e>>24&255,e>>16&255,e>>8&255,255&e,s>>24&255,s>>16&255,s>>8&255,255&s,i>>24&255,i>>16&255,i>>8&255,255&i,r>>24&255,r>>16&255,r>>8&255,255&r,n>>24&255,n>>16&255,n>>8&255,255&n,o>>24&255,o>>16&255,o>>8&255,255&o];return this.is224||l.push(a>>24&255,a>>16&255,a>>8&255,255&a),l}array(){return this.digest()}arrayBuffer(){this.finalize();var t=new ArrayBuffer(this.is224?28:32),e=new DataView(t);return e.setUint32(0,this.h0),e.setUint32(4,this.h1),e.setUint32(8,this.h2),e.setUint32(12,this.h3),e.setUint32(16,this.h4),e.setUint32(20,this.h5),e.setUint32(24,this.h6),this.is224||e.setUint32(28,this.h7),t}}function h(){var t=new l;if(t.update((new Date).getTime().toString()),window.crypto){var e=new Uint32Array(16);window.crypto.getRandomValues(e);for(let s of e)t.update(s.toString())}else for(var s=0;s<16;s++)t.update(Math.random().toString());return t.update(navigator.userAgent||""),t.update(navigator.language||""),t.update((window.screen.colorDepth||-1).toString()),t.update((window.devicePixelRatio||"").toString()),t.update((new Date).getTimezoneOffset().toString()),t.update(navigator.hardwareConcurrency.toString()||""),t.update(navigator.platform||""),t.update((navigator.hardwareConcurrency||"").toString()),t.hex()}},464:(t,e,s)=>{s.d(e,{Z:()=>r});const i={add:(t,e)=>t.map(((t,s)=>t+e[s])),negate:t=>t.map((t=>-t)),subtract:(t,e)=>i.add(t,i.negate(e)),length:t=>Math.sqrt(t.map((t=>t*t)).reduce(((t,e)=>t+e),0)),normalize:t=>i.mulByScalar(t,1/i.length(t)),mulByScalar:(t,e)=>t.map((t=>t*e)),dotProduct:(t,e)=>t.map(((t,s)=>t*e[s])).reduce(((t,e)=>t+e),0),clone:t=>t.slice(0),random:(t,e=(()=>Math.random()))=>{let s=void 0===t?1:t,i=e()*Math.PI*2;return[s*Math.sin(i),s*Math.cos(i)]},normal:t=>{let e=i.length(t),s=i.normalize(t);return[e*-s[1],e*s[0]]},rotate:(t,e)=>[t[0]*Math.cos(e)-t[1]*Math.sin(e),t[1]*Math.cos(e)+t[0]*Math.sin(e)],alignUp:(t,e)=>{const s=i.length(t),r=t[0]/s,n=t[1]/s;return[e[0]*n-e[1]*r,e[1]*n+e[0]*r]},angle:(t,e)=>{const s=i.dotProduct(t,e)/i.length(t)/i.length(e);return 180*Math.acos(s)/Math.PI},dist:(t,e)=>i.length(i.subtract(t,e)),behind:(t,e,s)=>{const r=i.normal(t);if(Math.abs(r[0])<1e-6)return s[1]<Math.sign(r[1])*e[1];const n=s[0],o=r[1]*(n-e[0])/r[0]+e[1],a=t[0]+e[0],l=r[1]*(a-e[0])/r[0]+e[1];return Math.sign(o-s[1])!=Math.sign(l-e[1])}},r=i}},e={};function s(i){var r=e[i];if(void 0!==r)return r.exports;var n=e[i]={exports:{}};return t[i](n,n.exports,s),n.exports}s.d=(t,e)=>{for(var i in e)s.o(e,i)&&!s.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:e[i]})},s.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),s(238),s(299),s(722),s(386),s(976),s(545);s(509)})();